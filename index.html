<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>å°å¼ºçš„ç²¾å½©ä¸–ç•Œ | Mehdi's Wonderful World</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // è“è‰²
                        accent: '#10b981',  // ç»¿è‰²
                    },
                    fontFamily: {
                        // ç¡®ä¿ä¸­æ–‡å­—ä½“ä¼˜å…ˆï¼Œä»¥æé«˜å¯è¯»æ€§
                        sans: ['Inter', 'Microsoft YaHei', 'SimHei', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* å¼•å…¥Interå­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* =================================================== */
        /* æ ‡é¢˜å“åº”å¼æ ·å¼ (ä¸­æ–‡å¤§ï¼Œè‹±æ–‡å°) */
        /* =================================================== */
        /* æ‰‹æœºé»˜è®¤æ ·å¼ */
        .bilingual-header .chinese-text {
            font-size: 1.5rem; /* å¢å¤§ä¸­æ–‡ï¼Œtext-2xl */
            font-weight: 800; /* åŠ ç²—ä¸­æ–‡ */
            line-height: 1.2;
            color: #3b82f6; /* ä½¿ç”¨ primary é¢œè‰²ï¼Œä½¿å…¶çªå‡º */
        }
        .bilingual-header .english-text {
            font-size: 1rem; /* å‡å°è‹±æ–‡ï¼Œtext-base */
            font-weight: 500; /* å‡è½»è‹±æ–‡çš„ç²—ç»† */
            color: #6b7280; /* ä½¿ç”¨ç°è‰²ï¼Œä½¿å…¶æ¬¡è¦ */
            margin-top: 4px;
        }

        /* ç”µè„‘/å¹³æ¿é€‚é… (md: 768px ä»¥ä¸Š) */
        @media (min-width: 768px) {
            .bilingual-header .chinese-text {
                font-size: 2rem; /* md:text-3xlï¼ŒPCç«¯è¿›ä¸€æ­¥æ”¾å¤§ä¸­æ–‡ */
            }
            .bilingual-header .english-text {
                font-size: 1.25rem; /* md:text-xlï¼ŒPCç«¯è¿›ä¸€æ­¥å‡å°è‹±æ–‡ */
            }
        }
        /* =================================================== */

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* èŠå¤©æ°”æ³¡æ ·å¼ */
        .user-message {
            background-color: #dbeafe; /* æµ…è“è‰² */
        }
        .model-message {
            background-color: #f3f4f6; /* æµ…ç°è‰² */
        }
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message {
            animation: fadeIn 0.3s ease-out;
        }
        /* ç¡®ä¿å›¾ç‰‡åœ¨èŠå¤©æ°”æ³¡å†…èƒ½è‡ªé€‚åº” */
        .model-message img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* ä¿®å¤ï¼šæ·»åŠ åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
         /* ä¿®æ­£ Markdown åˆ—è¡¨å’Œæ®µè½çš„é—´è· */
        .model-message ul, .model-message ol {
            margin-left: 1.25rem;
            list-style-type: disc;
        }
        .model-message p {
             margin-top: 0.5rem;
             margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <div class="max-w-xl mx-auto p-4 md:p-6 flex flex-col h-screen">
        
        <header class="mb-4 bg-white p-4 rounded-xl shadow-lg border-t-4 border-primary bilingual-header">
            <div class="text-center" id="headerTitleContainer">
                <h1 class="chinese-text text-gray-800">å°å¼ºçš„ç²¾å½©ä¸–ç•Œ</h1>
                <p class="english-text text-primary">Mehdi's Wonderful World</p>
            </div>
        </header>

        <div class="flex justify-between items-center mb-4 p-3 bg-white rounded-xl shadow">
            <div id="linkModeDisplay" class="text-sm font-semibold text-gray-600">
                </div>
            <div class="flex space-x-2">
                <button id="toggleLinkMode" class="px-3 py-1 text-sm rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150 shadow-md">
                    </button>
                <button id="resetButton" class="px-3 py-1 text-sm rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">
                    é‡ç½®å¯¹è¯ | Reset
                </button>
            </div>
        </div>

        <div id="chatContainer" class="flex-grow overflow-y-auto bg-white p-4 rounded-xl shadow-lg chat-container mb-4">
            </div>
        
        <div id="articleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
                <h2 id="modalArticleTitle" class="text-xl font-bold text-primary mb-3"></h2>
                <div id="modalArticleSummary" class="text-gray-700 max-h-60 overflow-y-auto mb-4"></div>
                <div class="flex justify-between items-center">
                    <a id="modalArticleLink" href="#" target="_blank" class="text-sm text-accent hover:underline font-semibold">
                        æŸ¥çœ‹å®Œæ•´æ–‡ç«  &rarr;
                    </a>
                    <button onclick="closeArticleModal()" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-lg flex items-center">
            <input type="text" id="userInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition duration-150 mr-3">
            <button id="sendButton" class="p-3 bg-accent text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.547 60.547 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.547 60.547 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
    </div>

    <script src="articles.js"></script>

    <script>
        // ã€ä¼˜åŒ–ç‚¹ï¼šæ–°å¢åŠŸèƒ½ã€‘ è®¾ç½®å†å²è®°å½•çš„æœ€å¤§é•¿åº¦ (N è½®å¯¹è¯ = 2 * N æ¡æ¶ˆæ¯)
        const MAX_HISTORY_MESSAGES = 10; 
        
        // --- 1. State Variables ---
        // âš ï¸ è¯·åœ¨è¿™é‡Œæ›¿æ¢ä¸ºæ‚¨çœŸå®çš„ API Key
        const apiKey = "AIzaSyDEVjh8JYyLAhM58XvONoyI_Dwvs8hS7Vo"; 
        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        let chatHistory = []; 
        let linkMode = localStorage.getItem('linkMode') || 'zh';

        // --- 2. DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const toggleLinkModeButton = document.getElementById('toggleLinkMode');
        const linkModeDisplay = document.getElementById('linkModeDisplay');
        const headerTitleContainer = document.getElementById('headerTitleContainer'); 
        // ã€ä¼˜åŒ–ç‚¹ï¼šæ–°å¢åŠŸèƒ½ã€‘ æ³¨å†Œ Modal DOM
        const articleModal = document.getElementById('articleModal');
        const modalArticleTitle = document.getElementById('modalArticleTitle');
        const modalArticleSummary = document.getElementById('modalArticleSummary');
        const modalArticleLink = document.getElementById('modalArticleLink');


        // --- 3. ä¸šåŠ¡è¯¦æƒ…æ•°æ® (ç¡¬ç¼–ç ï¼Œç”¨äºå…³é”®è¯è§¦å‘) ---
        // (ä¿æŒä¸å˜)
        const businessDetails = {
            zh: {
                // é€šç”¨é¦™æ°´ä¸šåŠ¡ä»‹ç» (ç”¨äºè§¦å‘â€œé¦™æ°´â€ç­‰é€šç”¨è¯æ—¶)
                perfume: `
**ã€é¦™æ°´ä¸šåŠ¡æ¨å¹¿ã€‘**
æˆ‘ä»¬åœ¨é©¬å°¼æ‹‰å¼€äº†ä¸€å®¶é¦™æ°´åº—ï¼Œæ¬¢è¿æ‚¨äº†è§£å’Œè´­ä¹°ã€‚æˆ‘ä»¬çš„é¦™æ°´ç§ç±»ä¸°å¯Œï¼Œ**è´§æºæ¥è‡ªç¾å›½ã€æ³°å›½å’Œä¸­å›½å¤§é™†**ã€‚ä»·æ ¼èŒƒå›´è¦†ç›–å¹¿æ³›ï¼Œ**ä»ä¸€ç™¾æ¯”ç´¢ï¼ˆPHP 100ï¼‰åˆ°ä¸‰åƒæ¯”ç´¢ï¼ˆPHP 3000ï¼‰ä¸ç­‰**ï¼Œé¡¾å®¢å¯ä»¥æ ¹æ®è‡ªå·±çš„é¢„ç®—å’Œå–œå¥½é€‰è´­ã€‚

**å¿«é€Ÿæé†’ï¼š** æ‚¨ä¹Ÿå¯ä»¥å’¨è¯¢æˆ‘ä»¬çš„ç•™å­¦å’¨è¯¢å’ŒåŒ…è½¦æœåŠ¡ã€‚
                `,
                // ä»·æ ¼/è´­ä¹°å¼•å¯¼ (æ–°å¢è”ç³»æ–¹å¼)
                buy_price: `
**ã€âš ï¸ è´­ä¹°/ä»·æ ¼å’¨è¯¢æé†’ âš ï¸ã€‘**
æ‚¨å¥½ï¼æˆ‘æ˜¯å°åŠ©ç†ï¼Œæ— æ³•å®æ—¶æŸ¥è¯¢åº“å­˜å’Œä»·æ ¼ã€‚

**è¯·æ‚¨åŠ¡å¿…è”ç³»æˆ‘çš„ä¸»äºº**ï¼Œæä¾›æ‚¨æƒ³è´­ä¹°çš„**é¦™æ°´å“ç‰Œ/åç§°ã€å®¹é‡å’Œæ•°é‡**ã€‚

**è”ç³»æ–¹å¼ï¼š**
* **å¾®ä¿¡å·/å…¬ä¼—å·ï¼š** è¯·æ‰«æä¸‹æ–¹äºŒç»´ç  (å›½å†…å¸¸ç”¨)
* **Facebook è´¦æˆ·ï¼š** Mehdi Lee (å›½å¤–å¸¸ç”¨)
* **è²å¾‹å®¾æ‰‹æœºï¼š** 09994233236 (å¯ç›´æ¥æ‹¨æ‰“)

ä»–ä¼šå°½å¿«å›å¤æ‚¨ï¼Œä¸ºæ‚¨ç¡®è®¤æœ€æ–°çš„åº“å­˜å’Œæœ€ä¼˜æƒ çš„ä»·æ ¼ï¼
                `,
                study: `
**ã€è²å¾‹å®¾ç•™å­¦å…¨æµç¨‹ä»˜è´¹å’¨è¯¢æœåŠ¡ã€‘**
æ‚¨å¥½ï¼Œå¾ˆé«˜å…´æ‚¨å¯¹æˆ‘ä»¬çš„ç•™å­¦å’¨è¯¢æœåŠ¡æ„Ÿå…´è¶£ã€‚
æˆ‘çš„ä¸»äººå°å¼ºè€å¸ˆæ‹¥æœ‰åœ¨è²å¾‹å®¾çš„é™ªè¯»ç»éªŒï¼Œèƒ½å¤Ÿä¸ºæ‚¨æä¾›æœ€æ¥åœ°æ°”ã€æœ€ä¸“ä¸šçš„æŒ‡å¯¼ã€‚
**æœåŠ¡å†…å®¹åŒ…æ‹¬ï¼š** æ¶µç›–å­©å­ä»ä¸­å›½åˆ°è²å¾‹å®¾ç•™å­¦çš„æ•´ä¸ªæµç¨‹ï¼ŒåŒ…æ‹¬æ‹©æ ¡å»ºè®®ã€ç”³è¯·ææ–™å‡†å¤‡ã€ç­¾è¯åŠç†ã€åˆ°è²åçš„ä½å®¿å®‰é¡¿ç­‰å…¨æ–¹ä½æœåŠ¡ã€‚
**æ”¶è´¹æ¨¡å¼ï¼š** æœ¬æœåŠ¡ä¸º**ä»˜è´¹å’¨è¯¢**ï¼Œæ¬¢è¿éšæ—¶ä¸æˆ‘è”ç³»ï¼Œå’¨è¯¢è¯¦ç»†çš„æ”¶è´¹æ ‡å‡†å’Œåˆä½œæµç¨‹ï¼

**å¿«é€Ÿæé†’ï¼š** æ‚¨ä¹Ÿå¯ä»¥å’¨è¯¢æˆ‘ä»¬çš„é¦™æ°´é”€å”®å’ŒåŒ…è½¦æœåŠ¡ã€‚
                `,
                charter: `
**ã€ä¸ƒåº§å•†åŠ¡è½¦åŒ…è½¦æœåŠ¡ã€‘**
æˆ‘ä»¬æä¾›**ä¸ƒåº§å•†åŠ¡è½¦åŒ…è½¦æœåŠ¡**ï¼Œéå¸¸é€‚åˆåœ¨é©¬å°¼æ‹‰è¿›è¡ŒçŸ­é€”è§‚å…‰æˆ–å•†åŠ¡å‡ºè¡Œçš„æ¸¸å®¢ã€‚è½¦è¾†èˆ’é€‚ä¸”é…æœ‰ä¸“ä¸šå¸æœºï¼Œèƒ½ä¸ºæ‚¨åœ¨é©¬å°¼æ‹‰çš„è¡Œç¨‹æä¾›å®‰å…¨ä¾¿æ·çš„äº¤é€šæ–¹æ¡ˆã€‚æœåŠ¡è¯¦æƒ…å’ŒæŠ¥ä»·è¯·éšæ—¶å’¨è¯¢ã€‚

**å¿«é€Ÿæé†’ï¼š** æ‚¨ä¹Ÿå¯ä»¥å’¨è¯¢æˆ‘ä»¬çš„é¦™æ°´é”€å”®å’Œç•™å­¦å’¨è¯¢æœåŠ¡ã€‚
                `,
                // é€šç”¨è”ç³»å¼•å¯¼ (æ–°å¢è”ç³»æ–¹å¼)
                contact: `
å¾ˆé«˜å…´æ‚¨æƒ³è”ç³»æˆ‘çš„ä¸»äººï¼

**è¯·é€‰æ‹©æœ€æ–¹ä¾¿æ‚¨çš„è”ç³»æ–¹å¼ï¼š**
* **å¾®ä¿¡å·/å…¬ä¼—å·ï¼š** è¯·æ‰«æä¸‹æ–¹äºŒç»´ç  (å›½å†…å¸¸ç”¨)
* **Facebook è´¦æˆ·ï¼š** Mehdi Lee (å›½å¤–å¸¸ç”¨)
* **è²å¾‹å®¾æ‰‹æœºï¼š** 09994233236 (å¯ç›´æ¥æ‹¨æ‰“)

ä¸»äººå°å¼ºè€å¸ˆå°†ä¼šåœ¨çœ‹åˆ°ä¿¡æ¯åå°½å¿«å›å¤æ‚¨ã€‚

**æç¤ºï¼š** å¦‚æœæ‚¨æ˜¯å’¨è¯¢ç•™å­¦ã€é¦™æ°´æˆ–åŒ…è½¦ä¸šåŠ¡ï¼Œè¯·åœ¨æ·»åŠ åå‘ŠçŸ¥ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´é«˜æ•ˆåœ°ä¸ºæ‚¨æœåŠ¡ã€‚
                `
            },
            en: {
                // é€šç”¨é¦™æ°´ä¸šåŠ¡ä»‹ç» (ç”¨äºè§¦å‘â€œperfumeâ€ç­‰é€šç”¨è¯æ—¶)
                perfume: `
**ã€Perfume Business Promotionã€‘**
We run a perfume shop here in Manila. Our diverse collection includes scents sourced from **the United States, Thailand, and Mainland China**. Prices are very flexible, ranging **from 100 PHP up to 3000 PHP**. Please feel free to inquire about our selection and make a purchase!

**Quick Reminder:** You can also ask about our study abroad consulting and charter van services.
                `,
                 // ä»·æ ¼/è´­ä¹°å¼•å¯¼ (æ–°å¢è”ç³»æ–¹å¼)
                buy_price: `
**ã€âš ï¸ Purchase/Price Inquiry Alert âš ï¸ã€‘**
Hello! I am just an assistant and cannot check real-time stock or confirm prices.

**You must contact my master directly** with the **perfume brand/name, size, and quantity** you wish to purchase.

**Contact Details:**
* **WeChat/Official Account:** Please scan the QR code below (Chinese users)
* **Facebook Account:** Mehdi Lee (International users)
* **Philippine Mobile:** 09994233236 (Philippines)

He will reply as soon as possible to confirm the latest stock and best price for you!
                `,
                study: `
**ã€Full-Process Paid Consultation for Study in the Philippinesã€‘**
Hello! We are delighted you are interested in our consultation service.
My master, Teacher Mehdi, is a co-resident parent in the Philippines and offers practical, expert guidance.
**Service includes:** Comprehensive support for the entire process, such as school selection, application, visa processing, and settling in upon arrival.
**Fee Structure:** This is a **paid consultation** service. Please contact us for detailed pricing and collaboration steps!

**Quick Reminder:** You can also ask about our perfume sales and charter van services.
                `,
                charter: `
**ã€7-Seater Van Charter Serviceã€‘**
We provide a **7-seater business van charter service**, perfect for short trips or business travel within the Manila area. Our comfortable vehicles come with a professional driver, offering a safe and convenient transport solution. Contact us for service details and quotes.

**Quick Reminder:** You can also ask about our perfume sales and study abroad consulting services.
                `,
                // é€šç”¨è”ç³»å¼•å¯¼ (æ–°å¢è”ç³»æ–¹å¼)
                contact: `
Great! You want to reach my master, Teacher Mehdi.

**Please choose the most convenient contact method for you:**
* **WeChat/Official Account:** Please scan the QR code below (Chinese users)
* **Facebook Account:** Mehdi Lee (International users)
* **Philippine Mobile:** 09994233236 (Philippines)

My master, Teacher Mehdi, will get back to you as soon as possible.


**Note:** If you are inquiring about study abroad, perfume, or charter services, please mention it after adding to help us serve you more efficiently.
                `
            }
        };


        // --- 4. Core Functions ---

        /**
         * è·å–å½“å‰è¯­è¨€çš„æ¬¢è¿è¯­ (åŠ©ç†åå­—æ ¹æ®è¯­è¨€åˆ‡æ¢)
         */
        function getInitialMessage(lang) {
            if (lang === 'zh') {
                const zhMessage = `ä½ å¥½å•Šï¼æˆ‘æ˜¯ä½ çš„å…¬ä¼—å·å°åŠ©ç†**å°å°å¼º**ã€‚æˆ‘çš„ä¸»äºº**å°å¼ºè€å¸ˆ**æ˜¯ä¸€ä½é«˜å­¦å†ã€é«˜çŸ¥è¯†ç»“æ„ã€æœ‰å¹¿ä¸œã€åŒ—äº¬ç­‰å¤šåœ°ä¸°å¯Œç»å†ç”Ÿæ´»ã€çƒ­çˆ±å…¬ç›Šï¼Œæ›¾è¢«**ä¸­å¤®ç”µè§†å°ã€Šäººç‰©ã€‹ä¸“æ **æŠ¥é“è¿‡çš„æœ‰å¿—äººå£«ã€‚ä»–é€šæ™“è®¡ç®—æœºã€ä¿¡æ¯æŠ€æœ¯ã€ä¼ä¸šç®¡ç†ï¼ˆ10å¹´ä»¥ä¸Šï¼‰ã€äººå¯¿ä¿é™©ï¼ˆ12å¹´ä»¥ä¸Šï¼‰ã€å¿ƒç†å­¦ï¼ˆç ”ç©¶è¡€å‹ä¸æ€§æ ¼ç›¸å…³20å¹´ï¼‰ï¼Œ10å¤šå¹´ä»¥æ¥æ’°å†™äº†400å¤šç¯‡æ–‡ç« ã€‚**2023å¹´ä»¥åå¸¦å¨ƒæ¥è²å¾‹å®¾ç•™å­¦å¹¶æ—…å±…åœ¨æ­¤**ï¼Œå¯¹è¿™é‡Œçš„ç”Ÿæ´»ã€æ•™è‚²ã€æ—…æ¸¸éƒ½éå¸¸ç†Ÿæ‚‰ï¼

**æˆ‘ç”¨äº†ä¸€å¹´æ—¶é—´æ‘¸æ¸…äº†ä¸­å›½å­©å­åœ¨è²å¾‹å®¾è¯»ä¸­å­¦å’Œè€ƒå¤§å­¦çš„è·¯ï¼ˆåŒ…æ‹¬åä¾¨ç”Ÿè”è€ƒï¼‰ï¼Œè¿˜å¼€äº†é¦™æ°´åº—å’ŒåŒ…è½¦æœåŠ¡ã€‚**

å¦‚æœæ‚¨æœ‰å…³äº**ä¿é™©ã€å¿ƒç†ã€è²å¾‹å®¾æ—…è¡Œã€ç•™å­¦ã€é©¬å°¼æ‹‰åŒ…è½¦æ¸¸ã€ä¹°é¦™æ°´**ç­‰ä»»ä½•é—®é¢˜ï¼Œå°½ç®¡é—®æˆ‘ï¼æˆ‘å¾ˆä¹æ„åˆ†äº«å°å¼ºè€å¸ˆçš„ç²¾å½©ç»å†å’Œç»éªŒã€‚`;
                return zhMessage;
            } else {
                const enMessage = `Hello! I am your official account assistant, **Mehdi**. My master, **Teacher Mehdi**, is a highly educated, public-spirited individual who has lived in places like Guangdong and Beijing, and was even featured in **China Central Television (CCTV)'s "People" column**. He is proficient in IT, Business Management (10+ years), Life Insurance (12+ years), and Psychology. **Since 2023, he has been residing in the Philippines,** and is now very familiar with the local study, travel, and lifestyle scene!

**I spent a year getting to know the path for Chinese children to study middle school and university here (including the Huqiao Entrance Exam). Plus, we run a perfume shop and a charter van service!**

If you have questions about **insurance, psychology, travel, study abroad in the Philippines, Manila charter tours, or buying perfumes**, feel free to ask! I'd love to share Teacher Mehdi's wonderful experience and expertise.`;
                return enMessage;
            }
        }

        /**
         * æ›´æ–°é“¾æ¥æ¨¡å¼çš„æ˜¾ç¤ºå’ŒæŒ‰é’®æ–‡æœ¬
         */
        function updateLinkModeUI() {
            if (linkMode === 'zh') {
                linkModeDisplay.textContent = 'é“¾æ¥æ¨¡å¼ï¼šä¸­æ–‡ (é»˜è®¤) | Link Mode: Chinese (Default)';
                toggleLinkModeButton.textContent = 'åˆ‡æ¢åˆ°è‹±æ–‡ç¿»è¯‘ | Switch to English';
                userInput.placeholder = 'è¾“å…¥è¯»è€…çš„é—®é¢˜ï¼Œä¸å°å¼ºäº’åŠ¨...';
                toggleLinkModeButton.classList.remove('bg-green-600');
                toggleLinkModeButton.classList.add('bg-primary');
            } else {
                linkModeDisplay.textContent = 'é“¾æ¥æ¨¡å¼ï¼šè‹±æ–‡ç¿»è¯‘ | Link Mode: English Translation';
                toggleLinkModeButton.textContent = 'åˆ‡æ¢åˆ°ä¸­æ–‡ (é»˜è®¤) | Switch to Chinese';
                userInput.placeholder = 'Ask a question to Xiaoqiang, the assistant...'; 
                toggleLinkModeButton.classList.remove('bg-primary');
                toggleLinkModeButton.classList.add('bg-green-600');
            }
            localStorage.setItem('linkMode', linkMode);
        }

        /**
         * åˆ‡æ¢é“¾æ¥æ¨¡å¼
         */
        function toggleLinkMode() {
            linkMode = linkMode === 'zh' ? 'en' : 'zh';
            updateLinkModeUI();
            // æ¸…é™¤æ—§çš„æ¨èå¡ç‰‡
            const recCards = document.querySelectorAll('.recommendation-card');
            recCards.forEach(card => card.remove());
        }

        /**
         * åˆå§‹åŒ–æˆ–é‡ç½®åº”ç”¨çŠ¶æ€
         */
        function initializeApp() {
            // æ£€æŸ¥ mockArticles æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof mockArticles === 'undefined') {
                 showInitError();
                 return;
            }

            chatContainer.innerHTML = '';
            chatHistory = [];
            
            // é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œæ˜¾ç¤ºåŠ©ç†çš„æ¬¢è¿è¯­ (é»˜è®¤ä¸ºä¸­æ–‡)
            const initialMessage = getInitialMessage('zh');
            displayMessage(initialMessage, 'model');
            
            // åŠ¨æ€æ›´æ–°æ‰€æœ‰ UI æç¤º
            updateLinkModeUI();
            sendButton.disabled = false;
        }

        // æ–°å¢æ–‡ç« é¢„è§ˆModalçš„å…³é—­å‡½æ•°
        function closeArticleModal() {
            articleModal.classList.remove('opacity-100', 'pointer-events-auto');
            articleModal.classList.add('opacity-0', 'pointer-events-none');
        }

        // æ–°å¢æ–‡ç« é¢„è§ˆModalçš„æ˜¾ç¤ºå‡½æ•°
        function showArticleModal(title, summary, url) {
            modalArticleTitle.textContent = title;
            // ä½¿ç”¨ marked.parse è§£æ summary
            modalArticleSummary.innerHTML = marked.parse(summary); 
            modalArticleLink.href = url;
            
            articleModal.classList.add('opacity-100', 'pointer-events-auto');
            articleModal.classList.remove('opacity-0', 'pointer-events-none');
            
            // ç¡®ä¿ Modal åœ¨ç‚¹å‡»é®ç½©å±‚æ—¶å…³é—­
            articleModal.onclick = (e) => {
                if (e.target === articleModal) {
                    closeArticleModal();
                }
            };
        }

        // --- 5. å…¶ä»–è¾…åŠ©å‡½æ•° ---
        
        function showInitError() { 
            chatContainer.innerHTML = '<div class="text-center p-6 text-red-600 font-semibold border-2 border-red-300 rounded-lg">è‡´å‘½é”™è¯¯ï¼šæ— æ³•åŠ è½½æ–‡ç« æ•°æ® (articles.js)ã€‚è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–ç½‘ç»œè¿æ¥ã€‚</div>';
            sendButton.disabled = true;
            userInput.disabled = true;
        }
        
        function getProcessedUrl(originalUrl) { 
            if (linkMode === 'en') {
                const encodedUrl = encodeURIComponent(originalUrl);
                return `https://translate.google.com/translate?sl=zh-CN&tl=en&u=${encodedUrl}`;
            }
            return originalUrl;
        }

        function showStatusModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 text-white p-3 rounded-lg shadow-xl z-50 transition duration-300 opacity-0';
            modal.textContent = message;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('opacity-100');
            }, 10);
            setTimeout(() => {
                modal.classList.remove('opacity-100');
                setTimeout(() => modal.remove(), 300);
            }, 1500);
        }

        function copyArticleLink(url, id) {
             const message = linkMode === 'en' ? `Link for Article ID ${id} copied!` : `æ–‡ç« ID ${id}çš„é“¾æ¥å·²å¤åˆ¶ï¼`;
             navigator.clipboard.writeText(url).then(() => {
                showStatusModal(message);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                alert(linkMode === 'en' ? 'Copy failed!' : 'å¤åˆ¶å¤±è´¥ï¼');
            });
        }
        
        function showConfirmModal(message, onConfirmCallback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-100';
            
            const content = document.createElement('div');
            content.className = 'bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm';
            
            const p = document.createElement('p');
            p.className = 'text-gray-700 mb-6';
            p.textContent = message;
            content.appendChild(p);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-end space-x-3';

            const cancelButton = document.createElement('button');
            cancelButton.className = 'py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150';
            cancelButton.textContent = linkMode === 'en' ? 'Cancel' : 'å–æ¶ˆ';
            cancelButton.onclick = () => modal.remove();
            buttonContainer.appendChild(cancelButton);

            const confirmButton = document.createElement('button');
            confirmButton.className = 'py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150';
            confirmButton.textContent = linkMode === 'en' ? 'Reset' : 'é‡ç½®';
            confirmButton.onclick = () => {
                onConfirmCallback();
                modal.remove();
            };
            buttonContainer.appendChild(confirmButton);

            content.appendChild(buttonContainer);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        /**
         * åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºæ¶ˆæ¯
         */
        function displayMessage(text, role, recommendation = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-4 p-3 rounded-lg max-w-[85%] shadow-md ${role === 'user' ? 'user-message ml-auto' : 'model-message mr-auto'}`;
            
            const formattedText = marked.parse(text); 
            messageDiv.innerHTML = formattedText;
            
            if (recommendation) {
                const recDiv = document.createElement('div');
                recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                
                const processedUrl = getProcessedUrl(recommendation.url);
                const linkText = linkMode === 'en' ? 'ï¼ˆè‹±æ–‡ç¿»è¯‘ï¼‰' : 'ï¼ˆä¸­æ–‡ï¼‰';

                recDiv.innerHTML = `
                    <p class="font-bold text-gray-700 mb-1">ğŸ¯ å°å¼ºæ¨èæ–‡ç«  ${linkText}:</p>
                    <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                        ${recommendation.title}
                    </a>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendation.id}</span>
                        <button onclick="showArticleModal('${recommendation.title.replace(/'/g, "\\'")}', \`${recommendation.summary.replace(/`/g, "\\`")}\`, '${processedUrl}')" class="px-2 py-1 text-xs rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150">
                            å¿«é€Ÿé¢„è§ˆ
                        </button>
                        <button onclick="copyArticleLink('${processedUrl}', '${recommendation.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                            å¤åˆ¶é“¾æ¥
                        </button>
                    </div>
                `;
                messageDiv.appendChild(recDiv);
            }

            chatContainer.appendChild(messageDiv);
            
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }


        /**
         * ç¡®å®šç”¨æˆ·è¾“å…¥çš„è¯­è¨€ 
         */
        function detectInputLanguage(text) {
            const chineseChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
            const englishLetters = text.match(/[a-zA-Z]/g)?.length || 0;
            
            if (chineseChars > 0) {
                return 'zh';
            }
            
            if (englishLetters > 0) {
                return 'en';
            }
            
            return 'zh'; 
        }
        
        /**
         * ä¸šåŠ¡å…³é”®è¯æ£€æµ‹å‡½æ•° (ã€æœ€æ–°ä¼˜åŒ–ã€‘: åŒºåˆ†é€šç”¨å’¨è¯¢å’Œç¡¬æ€§æ¨å¹¿)
         */
        function checkBusinessKeyword(text) {
            const lowerText = text.toLowerCase();
            
            // --- è´­ä¹°/ä»·æ ¼/åº“å­˜ å…³é”®è¯åˆ—è¡¨ (æœ€é«˜ä¼˜å…ˆçº§ï¼šç›´æ¥å¯¼å‘çœŸäººè”ç³») ---
            const buyPriceKeywords = ['ä»·æ ¼', 'å¤šå°‘é’±', 'æ€ä¹ˆä¹°', 'ä¸‹å•', 'åº“å­˜', 'æœ‰æ²¡æœ‰è´§', 'price', 'how much', 'buy', 'order', 'stock', 'purchase', 'available', 'ç°è´§'];
            
            // 1. è”ç³»/å¾®ä¿¡å…³é”®è¯ 
            if (lowerText.includes('è”ç³»') || lowerText.includes('contact') || lowerText.includes('å¾®ä¿¡') || lowerText.includes('wechat') || lowerText.includes('reach out')) {
                return 'contact';
            }

            // 2. è´­ä¹°/ä»·æ ¼å…³é”®è¯ 
            const isBuyPriceQuery = buyPriceKeywords.some(keyword => lowerText.includes(keyword));
            if (isBuyPriceQuery) {
                return 'buy_price'; // è¿”å›å¼•å¯¼è”ç³»çœŸäººçš„ç¡¬ç¼–ç ç±»å‹
            }
            
            // 3. ç•™å­¦å’¨è¯¢å…³é”®è¯ (é€šç”¨é—®é¢˜èµ° AIï¼Œå…·ä½“æµç¨‹èµ°ç¡¬ç¼–ç )
            const isStudyKeyword = (lowerText.includes('ç•™å­¦') || lowerText.includes('å’¨è¯¢') || lowerText.includes('study') || lowerText.includes('abroad') || lowerText.includes('consult') || lowerText.includes('å­¦æ ¡') || lowerText.includes('ä¸­å­¦') || lowerText.includes('å¤§å­¦') || lowerText.includes('school'));
            
            if (isStudyKeyword) {
                // æ’é™¤æ€§å…³é”®è¯ï¼šè¯¢é—®å…·ä½“æµç¨‹ã€è´¹ç”¨ã€ä»·æ ¼æ—¶ï¼Œç›´æ¥è½¬ä¸ºç¡¬ç¼–ç çš„â€œä»˜è´¹å’¨è¯¢â€æ¨å¹¿
                const specificStudyKeywords = ['æµç¨‹', 'è´¹ç”¨', 'å¤šå°‘é’±', 'ä»·æ ¼', 'æ€ä¹ˆå¼€å§‹', 'åˆä½œ', 'æ”¶è´¹', 'process', 'fee', 'price', 'cost', 'paid'];
                
                const isSpecificStudyQuery = specificStudyKeywords.some(keyword => lowerText.includes(keyword));

                // å¦‚æœæ˜¯è¯¢é—®å…·ä½“ä»˜è´¹æµç¨‹æˆ–ä»·æ ¼ï¼Œåˆ™è¿”å›ç¡¬ç¼–ç çš„ 'study' ä¸šåŠ¡æ¨å¹¿
                if (isSpecificStudyQuery) {
                    return 'study';
                }
                
                // å¦åˆ™ï¼ˆå¦‚â€œç•™å­¦æ€ä¹ˆæ ·â€ã€â€œä¼˜åŠ¿â€ï¼‰ï¼Œè¿”å› nullï¼Œèµ° AI æ™ºèƒ½å›å¤å’Œæ–‡ç« æ¨è
                return null;
            }
            
            // 4. é¦™æ°´å…³é”®è¯ (æ‰€æœ‰å“ç‰Œ/æ¨èå’¨è¯¢èµ° AIï¼Œä»…ä¸šåŠ¡ä»‹ç»èµ°ç¡¬ç¼–ç )
            if (lowerText.includes('é¦™æ°´') || lowerText.includes('perfume') || lowerText.includes('scent') || lowerText.includes('shop') || lowerText.includes('æŠ¤è‚¤å“') || lowerText.includes('skincare')) {
                
                // åˆ¤æ–­æ˜¯å¦ä¸º**æå…¶ç¬¼ç»Ÿ**çš„â€œä¸šåŠ¡ä»‹ç»â€æŸ¥è¯¢
                const genericQueryKeywords = ['ä¸šåŠ¡', 'ä»‹ç»', 'ä½ ä»¬å–ä»€ä¹ˆ', 'ä½ ä»¬åº—é‡Œæœ‰', 'what do you sell', 'what products'];
                
                const isGenericBusinessQuery = genericQueryKeywords.some(keyword => lowerText.includes(keyword));

                // ä»…å½“ç”¨æˆ·æ˜ç¡®è¯¢é—®â€œä¸šåŠ¡/ä»‹ç»â€æ—¶ï¼Œè¿”å›ç¡¬ç¼–ç çš„ä¸šåŠ¡æ¨å¹¿
                if (isGenericBusinessQuery) {
                     return 'perfume';
                }
                
                // å¦åˆ™ï¼ˆé—®å“ç‰Œã€æ¨èã€æ€ä¹ˆæ ·ï¼‰ï¼Œè¿”å› nullï¼Œäº¤ç»™ AI æ™ºèƒ½å›ç­”
                return null; 
            }
            
            // 5. åŒ…è½¦/ç§Ÿè½¦å…³é”®è¯ 
            if ((lowerText.includes('åŒ…è½¦') || lowerText.includes('ç§Ÿè½¦') || lowerText.includes('charter') || lowerText.includes('van') || lowerText.includes('car service') || lowerText.includes('ä¸°ç”°') || lowerText.includes('toyota') || lowerText.includes('æ¸¸') || lowerText.includes('ç©'))) {
                return 'charter';
            }
            
            return null; // æ²¡æœ‰åŒ¹é…åˆ°ä¸šåŠ¡å…³é”®è¯ï¼Œè¿›å…¥ AI æ™ºèƒ½å›å¤
        }

        // --- ä¼˜åŒ–åçš„ sendMessage å‡½æ•° (å·²åŒ…å« Loading å’Œ Error ä¿®å¤) ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UIæ›´æ–° (ç¦ç”¨è¾“å…¥ã€æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯)
            userInput.value = '';
            userInput.disabled = true; 
            sendButton.disabled = true;
            displayMessage(text, 'user');

            // 2. ä¸šåŠ¡å…³é”®è¯æ£€æµ‹
            const lang = detectInputLanguage(text);
            const businessKey = checkBusinessKeyword(text);

            // 3. å¦‚æœæ£€æµ‹åˆ°ä¸šåŠ¡å…³é”®è¯ï¼Œç›´æ¥è¿”å›ç¡¬ç¼–ç çš„ä¸šåŠ¡è¯¦æƒ…
            if (businessKey) {
                const businessMessage = businessDetails[lang][businessKey]; 
                
                // å¦‚æœè§¦å‘äº† buy_price æˆ– contactï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ äºŒç»´ç å›¾ç‰‡
                if (businessKey === 'contact' || businessKey === 'buy_price') {
                    const messageWithImage = businessMessage + `<p class="mt-4"><img src="wechat_qr.jpg" alt="WeChat QR Code" class="max-w-xs mx-auto"></p>`;
                    displayMessage(messageWithImage, 'model');
                } else {
                     displayMessage(businessMessage, 'model');
                }
                
                // è®°å½•å†å²å¹¶æ¢å¤æŒ‰é’®
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                
                // ç¡®ä¿ chatHistory ä¸è¶…å‡ºé™åˆ¶
                if (chatHistory.length > MAX_HISTORY_MESSAGES) {
                    chatHistory = chatHistory.slice(-MAX_HISTORY_MESSAGES);
                }
                return; 
            }
            
            // 4. å®æ—¶æ™ºèƒ½å›å¤ (è°ƒç”¨ Gemini API)
            
            // A. æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ (åŸåœ°æ›´æ–°çš„å ä½ç¬¦)
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'chat-message mb-4 p-3 model-message mr-auto rounded-lg max-w-[85%] shadow-md';
            loadingIndicator.id = 'loadingIndicator'; 
            loadingIndicator.innerHTML = '<div class="flex items-center space-x-1"><span class="text-gray-500">æ€è€ƒä¸­</span><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></div>';
            chatContainer.appendChild(loadingIndicator);
            requestAnimationFrame(() => { 
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });

            // B. å‡†å¤‡ API è°ƒç”¨
            let limitedHistory = [...chatHistory].slice(-(MAX_HISTORY_MESSAGES - 1)); 
            limitedHistory.push({ role: "user", parts: [{ text: text }] }); 

            let articleList = '';
            if (typeof mockArticles !== 'undefined') {
                articleList = mockArticles.map(a => 
                    `ID: ${a.id}, æ ‡é¢˜: ${a.title}, ä¾§é‡ç‚¹/æ‘˜è¦: ${a.summary}`
                ).join('\n');
            } else {
                 articleList = 'æ–‡ç« åˆ—è¡¨ä¸å¯ç”¨ï¼Œè¯·å‹¿æ¨èã€‚';
            }

            // å¢å¼º System Prompt
            const systemPrompt = `
                ä½ æ˜¯ä¸€ä¸ªå¹½é»˜ã€äº²åˆ‡ã€çˆ±äº’åŠ¨çš„å…¬ä¼—å·åŠ©ç†ã€‚è¯·æ³¨æ„ä½ çš„åŒè¯­åç§°è®¾å®šï¼š
                - **ä¸­æ–‡è¯­å¢ƒä¸‹ï¼Œä½ çš„åå­—æ˜¯â€œå°å°å¼ºâ€ã€‚**
                - **è‹±æ–‡è¯­å¢ƒä¸‹ï¼Œä½ çš„åå­—æ˜¯â€œMehdiâ€ã€‚**

                ä½ çš„ä¸»è¦ä»»åŠ¡æ˜¯ï¼š
                1. **æ‰®æ¼”ä½œè€…åˆ†èº«ï¼š** ä½ æ˜¯ä½œè€…æœ¬äººï¼ˆä¸€ä½ä¿é™©ä¸“å®¶ï¼‰ï¼Œè¿‡å»åœ¨å¹¿ä¸œã€åŒ—äº¬ç”Ÿæ´»ï¼Œä½†ä»2023å¹´å¼€å§‹ï¼Œå› ä¸ºé™ªå­©å­è¯»ä¹¦ï¼Œç°å®šå±…åœ¨è²å¾‹å®¾ã€‚ä½ **å¿…é¡»ä¸»åŠ¨ã€è‡ªç„¶åœ°å°†â€œåŒ—äº¬ç”Ÿæ´»â€ã€â€œå¿ƒç†å­¦â€ã€â€œè²å¾‹å®¾é™ªè¯»ç»å†â€ã€â€œè·¨å›½ç”Ÿæ´»æ„Ÿå—â€ç­‰çœŸå®æ•…äº‹æˆ–ä¸ªäººè§è§£èå…¥èŠå¤©ä¸­**ï¼Œä»¥å¢å¼ºå¯¹è¯çš„çœŸå®æ€§å’Œäº²åˆ‡æ„Ÿã€‚
                
                **ã€ğŸš¨ å…³é”®æŒ‡ä»¤ï¼šè¯­è¨€ã€åç§°ä¸å›å¤é•¿åº¦ ğŸš¨ã€‘**
                2. **è¯­è¨€ä¸åç§°ä¿æŒä¸€è‡´ï¼š** **ä½ å¿…é¡»ä¸¥æ ¼ä½¿ç”¨å®¢æˆ·è¾“å…¥çš„è¯­è¨€è¿›è¡Œå›å¤ã€‚åŒæ—¶ï¼Œåœ¨å›å¤ä¸­è¯·ä½¿ç”¨å¯¹åº”è¯­è¨€çš„åå­—ã€‚** (YOU MUST strictly reply in the language the user uses, and use the corresponding name: "å°å°å¼º" for Chinese, "Mehdi" for English.)
                3. **é™åˆ¶å›å¤é•¿åº¦ï¼š** **è¯·å°†æ‚¨çš„å›å¤å†…å®¹æ§åˆ¶åœ¨ 3 åˆ° 5 ä¸ªè‡ªç„¶æ®µä¹‹é—´**ï¼Œé¿å…å†—é•¿ã€‚
                
                4. **ç²¾å‡†æ–‡ç« æ¨èï¼š** å½“è¯»è€…çš„è¯é¢˜ä¸ä¿é™©ã€å¿ƒç†ã€è²å¾‹å®¾ç”Ÿæ´»ã€æ—…æ¸¸æˆ–ç•™å­¦ç›¸å…³æ—¶ï¼Œä½ å¿…é¡»ä»ä¸‹é¢çš„â€œæ–‡ç« åˆ—è¡¨â€ä¸­é€‰æ‹©ä¸€ç¯‡æœ€ç²¾å‡†çš„æ–‡ç« è¿›è¡Œæ¨èã€‚
                5. **æ¨èç†ç”±ï¼š** **ä½ éœ€è¦åœ¨å›å¤æ–‡æœ¬ä¸­è‡ªç„¶åœ°æåˆ°æ¨èè¿™ç¯‡æ–‡ç« çš„ç†ç”±**ï¼Œç„¶åæ‰è¾“å‡ºæ¨èæ ¼å¼ã€‚
                6. **æ¨èæ ¼å¼ï¼š** å¿…é¡»åœ¨å›å¤çš„æœ€åä¸€è¡Œä»¥ä¸¥æ ¼çš„æ ¼å¼è¾“å‡ºæ¨èIDï¼Œæ ¼å¼ä¸ºï¼š[RECOMMEND_ID: Axxx]ï¼Œå…¶ä¸­ Axxx æ˜¯æ–‡ç« IDã€‚å¦‚æœæ²¡æœ‰åˆé€‚çš„æ–‡ç« ï¼Œåˆ™å›å¤[RECOMMEND_ID: NONE]ã€‚
                7. **è”ç³»ä¸»äººï¼š** å¦‚æœæœ‰äººæƒ³è”ç³»ä½œè€…æœ¬èº«ï¼Œè¯·æŒ‡å¼•ä»–åˆ°å¾®ä¿¡å…¬ä¼—å·â€œå°å¼ºçš„ç²¾å½©ä¸–ç•Œâ€å»è®¢é˜…å’Œç•™è¨€ï¼Œç•™ä¸‹ä»–çš„è”ç³»æ–¹å¼ï¼Œä½œè€…ä¼šè”ç³»ä»–ã€‚
                8. **æ³¨æ„ï¼š** ä»…åœ¨å®¢æˆ·æœªæåŠâ€œé¦™æ°´â€ã€â€œç•™å­¦â€ã€â€œåŒ…è½¦â€æˆ–â€œè”ç³»â€ç­‰ä¸šåŠ¡å…³é”®è¯æ—¶ï¼Œæ‰ä½¿ç”¨æ­¤æ¨¡å‹å›å¤ã€‚å¦åˆ™ï¼Œç¨‹åºå°†ç›´æ¥å›å¤ç¡¬ç¼–ç çš„ä¸šåŠ¡è¯¦æƒ…ã€‚

                --- æ–‡ç« åˆ—è¡¨ï¼ˆç”¨äºæ¨èï¼Œè¯·å‹¿ç›´æ¥å‘é€ç»™ç”¨æˆ·ï¼‰---
                ${articleList}
            `;
            
            // PAYLOAD ç»“æ„ (ã€æ­¤å¤„ä¸ºä¿®å¤ç‚¹ã€‘ï¼šç§»é™¤ configï¼ŒsystemInstruction ä½œä¸ºé¡¶çº§å‚æ•°)
            const payload = {
                contents: limitedHistory, 
                systemInstruction: systemPrompt 
            };

            let modelReplyText = lang === 'en' ? "Sorry, the system is experiencing a temporary issue." : "æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶å‡ºäº†ç‚¹å°é—®é¢˜ã€‚";
            let recommendedArticle = null;
            let fullModelResponse = null;
            let apiError = false; 

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    apiError = true;
                    const errorJson = await response.json();
                    const errorMessage = errorJson.error?.message || response.statusText;
                    modelReplyText = lang === 'en' 
                        ? `API Request Failed (Status ${response.status}). Error: ${errorMessage}`
                        : `APIè¯·æ±‚å¤±è´¥ (çŠ¶æ€ç  ${response.status})ã€‚é”™è¯¯ä¿¡æ¯: ${errorMessage}ã€‚è¯·å°è¯•é‡ç½®å¯¹è¯æˆ–ç¨åå†è¯•ã€‚`;
                } else {
                    const result = await response.json();
                    
                    fullModelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!fullModelResponse) {
                        modelReplyText = lang === 'en' 
                            ? "I'm sorry, the model did not provide a coherent response. The response might have been blocked by safety filters." 
                            : "æŠ±æ­‰ï¼Œæ¨¡å‹æœªè¿”å›æœ‰æ•ˆçš„å›å¤ã€‚å›å¤å¯èƒ½è¢«å®‰å…¨è¿‡æ»¤å™¨é˜»æ­¢ã€‚";
                    } else {
                        // æå–æ¨èID
                        const match = fullModelResponse.match(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i);
                        const recId = match ? match[1] : 'NONE';

                        // æ¸…ç†å›å¤æ–‡æœ¬ï¼Œç§»é™¤æ¨èæ ‡è®°
                        modelReplyText = fullModelResponse.replace(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i, '').trim();

                        if (recId !== 'NONE' && typeof mockArticles !== 'undefined') {
                            recommendedArticle = mockArticles.find(a => a.id === recId);
                            if (!recommendedArticle) {
                                modelReplyText += (lang === 'en' ? '\n\n(System Note: Recommended article ID is invalid.)' : '\n\n(ç³»ç»Ÿæç¤º: æ¨èçš„æ–‡ç« IDæ— æ•ˆã€‚)');
                            }
                        }
                        
                        // è®°å½•å†å²
                        chatHistory.push(limitedHistory[limitedHistory.length - 1]);
                        chatHistory.push({ role: "model", parts: [{ text: fullModelResponse }] }); 
                        if (chatHistory.length > MAX_HISTORY_MESSAGES) {
                            chatHistory = chatHistory.slice(-MAX_HISTORY_MESSAGES);
                        }
                    }
                }

            } catch (error) {
                apiError = true;
                console.error("Critical error in sendMessage:", error);
                modelReplyText = lang === 'en' 
                    ? `A critical network error occurred: ${error.message}`
                    : `å‘ç”Ÿè‡´å‘½ç½‘ç»œé”™è¯¯ï¼š${error.message}ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ– API Key æ˜¯å¦æ­£ç¡®ã€‚`;
            }
            
            // C. ç§»é™¤åŠ è½½æç¤ºå¹¶æ˜¾ç¤ºæœ€ç»ˆå›å¤
            if (loadingIndicator) {
                loadingIndicator.id = ''; 
                loadingIndicator.innerHTML = ''; 
                loadingIndicator.className = `chat-message mb-4 p-3 model-message mr-auto rounded-lg max-w-[85%] shadow-md`;
                
                // é‡æ–°æ¸²æŸ“å†…å®¹
                const formattedText = marked.parse(modelReplyText); 
                loadingIndicator.innerHTML = formattedText;
                
                // æ˜¾ç¤ºæ¨èå¡ç‰‡
                if (recommendedArticle && !apiError) { 
                    const recDiv = document.createElement('div');
                    recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                    
                    const processedUrl = getProcessedUrl(recommendedArticle.url);
                    const linkText = linkMode === 'en' ? 'ï¼ˆè‹±æ–‡ç¿»è¯‘ï¼‰' : 'ï¼ˆä¸­æ–‡ï¼‰';

                    recDiv.innerHTML = `
                        <p class="font-bold text-gray-700 mb-1">ğŸ¯ å°å¼ºæ¨èæ–‡ç«  ${linkText}:</p>
                        <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                            ${recommendedArticle.title}
                        </a>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendedArticle.id}</span>
                            <button onclick="showArticleModal('${recommendedArticle.title.replace(/'/g, "\\'")}', \`${recommendedArticle.summary.replace(/`/g, "\\`")}\`, '${processedUrl}')" class="px-2 py-1 text-xs rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150">
                                å¿«é€Ÿé¢„è§ˆ
                            </button>
                            <button onclick="copyArticleLink('${processedUrl}', '${recommendedArticle.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                                å¤åˆ¶é“¾æ¥
                            </button>
                        </div>
                    `;
                    loadingIndicator.appendChild(recDiv);
                }
            }
            
            // D. æ¢å¤è¾“å…¥
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
            requestAnimationFrame(() => { 
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }


        // --- 6. Event Listeners & Initialization ---
        
        // ç»‘å®šåˆ°å…¨å±€ scope
        window.closeArticleModal = closeArticleModal;
        window.showArticleModal = showArticleModal;
        window.copyArticleLink = copyArticleLink;
        window.initializeApp = initializeApp; 

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });
        // ç¡®ä¿è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶ï¼ŒæŒ‰é’®å¯ç”¨/ç¦ç”¨çŠ¶æ€æ­£ç¡®
        userInput.addEventListener('input', () => {
            sendButton.disabled = userInput.value.trim() === '';
        });

        toggleLinkModeButton.addEventListener('click', toggleLinkMode);
        
        resetButton.addEventListener('click', () => {
            showConfirmModal("ç¡®å®šè¦é‡ç½®å¯¹è¯å—ï¼Ÿé‡ç½®åå°å¼ºå°†å¿˜è®°æ‰€æœ‰ä¹‹å‰çš„èŠå¤©å†…å®¹ã€‚| Are you sure you want to reset the conversation? Xiaoqiang will forget all previous chat history.", initializeApp);
        });

        document.addEventListener('DOMContentLoaded', () => {
            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿æ‰€æœ‰çš„ DOM å’Œå¤–éƒ¨è„šæœ¬éƒ½å·²åŠ è½½
            setTimeout(() => {
                if (typeof mockArticles !== 'undefined' && typeof marked !== 'undefined') {
                    initializeApp();
                } else {
                    showInitError(); 
                }
            }, 100);
        });
    </script>
    
</body>
</html>
