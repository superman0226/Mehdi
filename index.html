<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>å°å¼ºçš„ç²¾å½©ä¸–ç•Œ | Mehdi's Wonderful World</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // è“è‰²
                        accent: '#10b981',  // ç»¿è‰²
                    },
                    fontFamily: {
                        // ç¡®ä¿ä¸­æ–‡å­—ä½“ä¼˜å…ˆï¼Œä»¥æé«˜å¯è¯»æ€§
                        sans: ['Inter', 'Microsoft YaHei', 'SimHei', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* å¼•å…¥Interå­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* =================================================== */
        /* 2. æ ‡é¢˜å“åº”å¼æ ·å¼ (å®ç°åŒè¯­æç¤ºé€‚é…)                        */
        /* =================================================== */
        /* æ‰‹æœºé»˜è®¤æ ·å¼ */
        .bilingual-header .chinese-text {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700;
        }
        .bilingual-header .english-text {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 800;
            color: #3b82f6; /* ä½¿ç”¨ primary é¢œè‰² */
            line-height: 1.2;
            margin-top: 4px;
        }

        /* ç”µè„‘/å¹³æ¿é€‚é… (md: 768px ä»¥ä¸Š) */
        @media (min-width: 768px) {
            .bilingual-header .chinese-text {
                font-size: 1.5rem; /* md:text-2xl */
            }
            .bilingual-header .english-text {
                font-size: 2rem; /* md:text-3xl */
            }
        }
        /* =================================================== */

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* èŠå¤©æ°”æ³¡æ ·å¼ */
        .user-message {
            background-color: #dbeafe; /* æµ…è“è‰² */
        }
        .model-message {
            background-color: #f3f4f6; /* æµ…ç°è‰² */
        }
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message {
            animation: fadeIn 0.3s ease-out;
        }
        /* ç¡®ä¿å›¾ç‰‡åœ¨èŠå¤©æ°”æ³¡å†…èƒ½è‡ªé€‚åº” */
        .model-message img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* ä¿®å¤ï¼šæ·»åŠ åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <div class="max-w-xl mx-auto p-4 md:p-6 flex flex-col h-screen">
        
        <header class="mb-4 bg-white p-4 rounded-xl shadow-lg border-t-4 border-primary bilingual-header">
            <div class="text-center" id="headerTitleContainer">
                <h1 class="chinese-text text-gray-800">å°å¼ºçš„ç²¾å½©ä¸–ç•Œ</h1>
                <p class="english-text text-primary">Mehdi's Wonderful World</p>
            </div>
        </header>

        <div class="flex justify-between items-center mb-4 p-3 bg-white rounded-xl shadow">
            <div id="linkModeDisplay" class="text-sm font-semibold text-gray-600">
                </div>
            <div class="flex space-x-2">
                <button id="toggleLinkMode" class="px-3 py-1 text-sm rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150 shadow-md">
                    </button>
                <button id="resetButton" class="px-3 py-1 text-sm rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">
                    é‡ç½®å¯¹è¯ | Reset
                </button>
            </div>
        </div>

        <div id="chatContainer" class="flex-grow overflow-y-auto bg-white p-4 rounded-xl shadow-lg chat-container mb-4">
            </div>

        <div class="bg-white p-4 rounded-xl shadow-lg flex items-center">
            <input type="text" id="userInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition duration-150 mr-3">
            <button id="sendButton" class="p-3 bg-accent text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.547 60.547 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.547 60.547 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
    </div>

    <script src="articles.js"></script>

    <script>
        // --- 1. State Variables ---
        // âš ï¸ è¯·åœ¨è¿™é‡Œæ›¿æ¢ä¸ºæ‚¨çœŸå®çš„ API Key
        const apiKey = "AIzaSyDEVjh8JYyLAhM58XvONoyI_Dwvs8hS7Vo"; 
        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        let chatHistory = []; 
        let linkMode = localStorage.getItem('linkMode') || 'zh';

        // --- 2. DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const toggleLinkModeButton = document.getElementById('toggleLinkMode');
        const linkModeDisplay = document.getElementById('linkModeDisplay');
        // const headerTitle = document.getElementById('headerTitle'); // åŸå§‹ä»£ç ä¸­å·²åˆ é™¤
        const headerTitleContainer = document.getElementById('headerTitleContainer'); // æ–°å¢


        // --- 3. ä¸šåŠ¡è¯¦æƒ…æ•°æ® (ç¡¬ç¼–ç ï¼Œç”¨äºå…³é”®è¯è§¦å‘) ---
        const businessDetails = {
            zh: {
                perfume: `
**ã€é¦™æ°´ä¸šåŠ¡æ¨å¹¿ã€‘**
æˆ‘ä»¬åœ¨é©¬å°¼æ‹‰å¼€äº†ä¸€å®¶é¦™æ°´åº—ï¼Œæ¬¢è¿æ‚¨äº†è§£å’Œè´­ä¹°ã€‚æˆ‘ä»¬çš„é¦™æ°´ç§ç±»ä¸°å¯Œï¼Œ**è´§æºæ¥è‡ªç¾å›½ã€æ³°å›½å’Œä¸­å›½å¤§é™†**ã€‚ä»·æ ¼èŒƒå›´è¦†ç›–å¹¿æ³›ï¼Œ**ä»ä¸€ç™¾æ¯”ç´¢ï¼ˆPHP 100ï¼‰åˆ°ä¸‰åƒæ¯”ç´¢ï¼ˆPHP 3000ï¼‰ä¸ç­‰**ï¼Œé¡¾å®¢å¯ä»¥æ ¹æ®è‡ªå·±çš„é¢„ç®—å’Œå–œå¥½é€‰è´­ã€‚

**å¿«é€Ÿæé†’ï¼š** æ‚¨ä¹Ÿå¯ä»¥å’¨è¯¢æˆ‘ä»¬çš„ç•™å­¦å’¨è¯¢å’ŒåŒ…è½¦æœåŠ¡ã€‚
                `,
                study: `
**ã€è²å¾‹å®¾ç•™å­¦å…¨æµç¨‹ä»˜è´¹å’¨è¯¢æœåŠ¡ã€‘**
æ‚¨å¥½ï¼Œå¾ˆé«˜å…´æ‚¨å¯¹æˆ‘ä»¬çš„ç•™å­¦å’¨è¯¢æœåŠ¡æ„Ÿå…´è¶£ã€‚
æˆ‘çš„ä¸»äººå°å¼ºè€å¸ˆæ‹¥æœ‰åœ¨è²å¾‹å®¾çš„é™ªè¯»ç»éªŒï¼Œèƒ½å¤Ÿä¸ºæ‚¨æä¾›æœ€æ¥åœ°æ°”ã€æœ€ä¸“ä¸šçš„æŒ‡å¯¼ã€‚
**æœåŠ¡å†…å®¹åŒ…æ‹¬ï¼š** æ¶µç›–å­©å­ä»ä¸­å›½åˆ°è²å¾‹å®¾ç•™å­¦çš„æ•´ä¸ªæµç¨‹ï¼ŒåŒ…æ‹¬æ‹©æ ¡å»ºè®®ã€ç”³è¯·ææ–™å‡†å¤‡ã€ç­¾è¯åŠç†ã€åˆ°è²åçš„ä½å®¿å®‰é¡¿ç­‰å…¨æ–¹ä½æœåŠ¡ã€‚
**æ”¶è´¹æ¨¡å¼ï¼š** æœ¬æœåŠ¡ä¸º**ä»˜è´¹å’¨è¯¢**ï¼Œæ¬¢è¿éšæ—¶ä¸æˆ‘è”ç³»ï¼Œå’¨è¯¢è¯¦ç»†çš„æ”¶è´¹æ ‡å‡†å’Œåˆä½œæµç¨‹ï¼

**å¿«é€Ÿæé†’ï¼š** æ‚¨ä¹Ÿå¯ä»¥å’¨è¯¢æˆ‘ä»¬çš„é¦™æ°´é”€å”®å’ŒåŒ…è½¦æœåŠ¡ã€‚
                `,
                charter: `
**ã€ä¸ƒåº§å•†åŠ¡è½¦åŒ…è½¦æœåŠ¡ã€‘**
æˆ‘ä»¬æä¾›**ä¸ƒåº§å•†åŠ¡è½¦åŒ…è½¦æœåŠ¡**ï¼Œéå¸¸é€‚åˆåœ¨é©¬å°¼æ‹‰è¿›è¡ŒçŸ­é€”è§‚å…‰æˆ–å•†åŠ¡å‡ºè¡Œçš„æ¸¸å®¢ã€‚è½¦è¾†èˆ’é€‚ä¸”é…æœ‰ä¸“ä¸šå¸æœºï¼Œèƒ½ä¸ºæ‚¨åœ¨é©¬å°¼æ‹‰çš„è¡Œç¨‹æä¾›å®‰å…¨ä¾¿æ·çš„äº¤é€šæ–¹æ¡ˆã€‚æœåŠ¡è¯¦æƒ…å’ŒæŠ¥ä»·è¯·éšæ—¶å’¨è¯¢ã€‚

**å¿«é€Ÿæé†’ï¼š** æ‚¨ä¹Ÿå¯ä»¥å’¨è¯¢æˆ‘ä»¬çš„é¦™æ°´é”€å”®å’Œç•™å­¦å’¨è¯¢æœåŠ¡ã€‚
                `,
                contact: `
å¾ˆé«˜å…´æ‚¨æƒ³è”ç³»æˆ‘çš„ä¸»äººï¼è¯·æ‰«æä¸‹æ–¹äºŒç»´ç ï¼ˆ**å°å¼ºçš„ç²¾å½©ä¸–ç•Œå…¬ä¼—å·**ï¼‰æˆ–é€šè¿‡å¾®ä¿¡å·è”ç³»ã€‚ä¸»äººå°å¼ºè€å¸ˆå°†ä¼šåœ¨çœ‹åˆ°ä¿¡æ¯åå°½å¿«å›å¤æ‚¨ã€‚

![å¾®ä¿¡äºŒç»´ç ](images/wechat_qr.jpg)

**æç¤ºï¼š** å¦‚æœæ‚¨æ˜¯å’¨è¯¢ç•™å­¦ã€é¦™æ°´æˆ–åŒ…è½¦ä¸šåŠ¡ï¼Œè¯·åœ¨æ·»åŠ åå‘ŠçŸ¥ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´é«˜æ•ˆåœ°ä¸ºæ‚¨æœåŠ¡ã€‚
                `
            },
            en: {
                perfume: `
**ã€Perfume Business Promotionã€‘**
We operate a perfume shop in Manila. Our selection is diverse, featuring scents sourced from **the United States, Thailand, and Mainland China**. The pricing is flexible, ranging **from one hundred pesos (PHP 100) up to three thousand pesos (PHP 3000)**. Feel free to contact me for inquiries and purchases.

**Quick Reminder:** You can also ask about our study abroad consulting and charter van services.
                `,
                study: `
**ã€Full-Process Paid Consultation for Study in the Philippinesã€‘**
Hello! We are delighted you are interested in our study abroad consulting service.
My master, Teacher Xiaoqiang, leverages his personal experience as a co-resident parent in the Philippines to offer practical and professional guidance.
**Service includes:** Comprehensive support for the entire process, including school selection, application, visa processing, and settlement arrangements upon arrival.
**Fee Structure:** This is a **paid consultation** service. Please contact us for detailed pricing and collaboration steps!

**Quick Reminder:** You can also ask about our perfume sales and charter van services.
                `,
                charter: `
**ã€7-Seater Van Charter Serviceã€‘**
We provide a **7-seater business van charter service**, ideal for short-distance tours or business travel within Manila. Our vehicles are comfortable and come with a professional driver, offering a safe and convenient transportation option. Please contact us for service details and quotes.

**Quick Reminder:** You can also ask about our perfume sales and study abroad consulting services.
                `,
                contact: `
Great! You can reach my master, Teacher Xiaoqiang, via the QR code below (for the official account: **Xiaoqiangâ€™s Wonderful World**) or by WeChat ID. He will get back to you as soon as possible.

![WeChat QR Code](images/wechat_qr.jpg)

**Note:** If you are inquiring about study abroad, perfume, or charter services, please mention it after adding to help us serve you more efficiently.
                `
            }
        };


        // --- 4. Core Functions ---

        /**
         * è·å–å½“å‰è¯­è¨€çš„æ¬¢è¿è¯­
         */
        function getInitialMessage(lang) {
            const zhMessage = `ä½ å¥½å•Šï¼æˆ‘æ˜¯ä½ çš„å…¬ä¼—å·å°åŠ©ç†**å°å°å¼º**ã€‚æˆ‘çš„ä¸»äºº**å°å¼ºè€å¸ˆ**æ˜¯ä¸€ä½é«˜å­¦å†ã€é«˜çŸ¥è¯†ç»“æ„ã€æœ‰å¹¿ä¸œã€åŒ—äº¬ç­‰å¤šåœ°ä¸°å¯Œç»å†ç”Ÿæ´»ã€çƒ­çˆ±å…¬ç›Šï¼Œæ›¾è¢«**ä¸­å¤®ç”µè§†å°ã€Šäººç‰©ã€‹ä¸“æ **æŠ¥é“è¿‡çš„æœ‰å¿—äººå£«ã€‚é€šæ™“è®¡ç®—æœºã€ä¿¡æ¯æŠ€æœ¯ã€ä¼ä¸šç®¡ç†ï¼ˆ10å¹´ä»¥ä¸Šå·¥ä½œç»å†ï¼‰ã€äººå¯¿ä¿é™©ï¼ˆ12å¹´ä»¥ä¸Šå·¥ä½œç»å†ï¼‰ã€å¿ƒç†å­¦ï¼ˆç ”ç©¶è¡€å‹ä¸æ€§æ ¼ç›¸å…³20å¹´ï¼‰ã€‚10å¤šå¹´ä»¥æ¥æ’°å†™äº†400å¤šç¯‡æ–‡ç« ã€‚**2023å¹´ä»¥åå¸¦å¨ƒæ¥è²å¾‹å®¾ç•™å­¦å¹¶æ—…å±…åœ¨æ­¤**ï¼Œåˆæ’°å†™äº†å¾ˆå¤šæœ‰å…³è²å¾‹å®¾ç•™å­¦ã€æ—…è¡Œã€ç”Ÿæ´»çš„ç›¸å…³æ–‡ç« ã€‚

**æˆ‘ç”¨äº†ä¸€å¹´æ—¶é—´èµ°éäº†è²å¾‹å®¾ï¼Œè¿˜å¼€äº†ä¸€å®¶é¦™æ°´åº—ï¼Œä¹°äº†ä¸€è¾†ä¸°ç”°ä¸ƒåº§å•†åŠ¡è½¦ï¼Œå¹¶æŠŠä¸­å›½å­©å­åˆ°è²å¾‹å®¾è¯»ä¸­å­¦å’Œè€ƒå¤§å­¦çš„è·¯å…¨æ‘¸æ¸…äº†ã€‚**

å¦‚æœæ‚¨æœ‰å…³äºä¿é™©ã€å¿ƒç†ã€è²å¾‹å®¾æ—…è¡Œã€ç•™å­¦ï¼Œé©¬å°¼æ‹‰åœ°åŒºåŒ…è½¦æ¸¸ã€ä¹°é¦™æ°´å’ŒæŠ¤è‚¤å“ï¼Œæˆ–è€…å…¶ä»–æƒ³èŠçš„ï¼Œå°½ç®¡é—®æˆ‘ï¼`;

            // MODIFIED ENGLISH WELCOME MESSAGE (CCTV changed to China Central Television)
            const enMessage = `Hello! I am your official account assistant, **Xiao Xiaoqiang**. My master, **Teacher Xiaoqiang**, is a highly educated and knowledgeable person with rich experience from various regions, including Guangdong and Beijing. He is a public-spirited individual who was once featured in **China Central Television (CCTV)'s "People" column**. He is proficient in Computer Science, Information Technology, Business Management (10+ years experience), Life Insurance (12+ years experience), and Psychology (20 years researching blood types and personality). He has authored over 400 articles in the last decade. **Since 2023, he has been residing in the Philippines, accompanying his child for school**, and has written many articles on Philippine study, travel, and life.

**I spent a year traveling all over the Philippines, opened a perfume shop, bought a Toyota 7-seater business van, and thoroughly figured out the path for Chinese children to study in middle school and university in the Philippines.**

If you have any questions about insurance, psychology, travel, study abroad in the Philippines, charter tours in the Manila area, buying perfumes and skincare products, or anything else you'd like to discuss, feel free to ask!`;

            return lang === 'en' ? enMessage : zhMessage;
        }

        /**
         * æ›´æ–°é“¾æ¥æ¨¡å¼çš„æ˜¾ç¤ºå’ŒæŒ‰é’®æ–‡æœ¬
         */
        function updateLinkModeUI() {
            if (linkMode === 'zh') {
                linkModeDisplay.textContent = 'é“¾æ¥æ¨¡å¼ï¼šä¸­æ–‡ (é»˜è®¤) | Link Mode: Chinese (Default)';
                toggleLinkModeButton.textContent = 'åˆ‡æ¢åˆ°è‹±æ–‡ç¿»è¯‘ | Switch to English';
                userInput.placeholder = 'è¾“å…¥è¯»è€…çš„é—®é¢˜ï¼Œä¸å°å¼ºäº’åŠ¨...';
                toggleLinkModeButton.classList.remove('bg-green-600');
                toggleLinkModeButton.classList.add('bg-primary');
            } else {
                linkModeDisplay.textContent = 'é“¾æ¥æ¨¡å¼ï¼šè‹±æ–‡ç¿»è¯‘ | Link Mode: English Translation';
                toggleLinkModeButton.textContent = 'åˆ‡æ¢åˆ°ä¸­æ–‡ (é»˜è®¤) | Switch to Chinese';
                userInput.placeholder = 'Ask a question to Xiaoqiang...';
                toggleLinkModeButton.classList.remove('bg-primary');
                toggleLinkModeButton.classList.add('bg-green-600');
            }
            localStorage.setItem('linkMode', linkMode);
        }

        /**
         * åˆ‡æ¢é“¾æ¥æ¨¡å¼
         */
        function toggleLinkMode() {
            linkMode = linkMode === 'zh' ? 'en' : 'zh';
            updateLinkModeUI();
            // æ¸…é™¤æ—§çš„æ¨èå¡ç‰‡
            const recCards = document.querySelectorAll('.recommendation-card');
            recCards.forEach(card => card.remove());
        }

        /**
         * åˆå§‹åŒ–æˆ–é‡ç½®åº”ç”¨çŠ¶æ€
         */
        function initializeApp() {
            if (typeof mockArticles === 'undefined') {
                 showInitError();
                 return;
            }

            chatContainer.innerHTML = '';
            chatHistory = [];
            
            // é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œæ˜¾ç¤ºåŠ©ç†çš„æ¬¢è¿è¯­ (é»˜è®¤ä¸ºä¸­æ–‡)
            const initialMessage = getInitialMessage('zh');
            displayMessage(initialMessage, 'model');
            
            // åŠ¨æ€æ›´æ–°æ‰€æœ‰ UI æç¤º
            updateLinkModeUI();
            sendButton.disabled = false;
        }


        // --- 5. å…¶ä»–è¾…åŠ©å‡½æ•° (ä¿æŒä¸å˜) ---
        function showInitError() {
            chatContainer.innerHTML = `
                <div class="text-center text-red-500 p-4 bg-red-50 rounded-lg">
                    <p class="font-bold mb-2">ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼| System Initialization Failed!</p>
                    <p class="text-sm">é”™è¯¯ï¼šæœªæ‰¾åˆ° <strong>articles.js</strong> æ–‡ä»¶ä¸­çš„ mockArticles æ•°æ®ã€‚| Error: mockArticles data not found.</p>
                    <p class="text-xs mt-1">è¯·ç¡®ä¿ 'articles.js' æ–‡ä»¶ä¸ 'index.html' åœ¨åŒä¸€ç›®å½•ã€‚| Ensure 'articles.js' is in the same directory as 'index.html'.</p>
                </div>
            `;
            sendButton.disabled = true;
        }
        function getProcessedUrl(originalUrl) {
            if (linkMode === 'en') {
                const encodedUrl = encodeURIComponent(originalUrl);
                return `https://translate.google.com/translate?sl=zh-CN&tl=en&u=${encodedUrl}`;
            }
            return originalUrl;
        }
        function showStatusModal(message) {
            const modalId = 'statusModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
                        <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
                        <button onclick="document.getElementById('${modalId}').classList.remove('opacity-100', 'pointer-events-auto'); document.getElementById('${modalId}').classList.add('opacity-0', 'pointer-events-none');" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150">
                            ç¡®å®š | OK
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            document.getElementById('modalMessage').textContent = message;
            setTimeout(() => {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }, 10);
        }
        function copyArticleLink(url, id) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(textarea);

            const statusText = success ? `å·²å¤åˆ¶æ–‡ç«  ${id} çš„é“¾æ¥ï¼| Link for Article ${id} copied!` : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚| Copy failed, please copy manually.';
            showStatusModal(statusText); 
        }
        function showConfirmModal(message, onConfirmCallback) {
            const modalId = 'confirmModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl w-80 transform scale-95 transition-transform duration-300">
                        <p id="confirmModalMessage" class="text-lg font-semibold text-gray-800 mb-6"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirmCancelBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                                å–æ¶ˆ | Cancel
                            </button>
                            <button id="confirmOkBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">
                                ç¡®å®šé‡ç½® | Confirm Reset
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('confirmModalMessage').textContent = message;

            const closeModal = () => {
                modal.classList.remove('opacity-100', 'pointer-events-auto');
                modal.classList.add('opacity-0', 'pointer-events-none');
            };

            const okBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');

            const newOkListener = () => {
                closeModal();
                onConfirmCallback();
                okBtn.removeEventListener('click', newOkListener);
                cancelBtn.removeEventListener('click', newCancelListener);
            };

            const newCancelListener = () => {
                closeModal();
                cancelBtn.removeEventListener('click', newCancelListener);
                okBtn.removeEventListener('click', newOkListener);
            };

            okBtn.addEventListener('click', newOkListener);
            cancelBtn.addEventListener('click', newCancelListener);


            setTimeout(() => {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }, 10);
        }


        /**
         * åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºæ¶ˆæ¯
         */
        function displayMessage(text, role, recommendation = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-4 p-3 rounded-lg max-w-[85%] shadow-md ${role === 'user' ? 'user-message ml-auto' : 'model-message mr-auto'}`;
            
            // ä½¿ç”¨ Markdown è§£æå™¨è¿›è¡ŒåŸºæœ¬æ ¼å¼åŒ–
            const formattedText = marked.parse(text); 
            messageDiv.innerHTML = formattedText;
            
            if (recommendation) {
                const recDiv = document.createElement('div');
                recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                
                const processedUrl = getProcessedUrl(recommendation.url);
                const linkText = linkMode === 'en' ? 'ï¼ˆè‹±æ–‡ç¿»è¯‘ï¼‰' : 'ï¼ˆä¸­æ–‡ï¼‰';

                recDiv.innerHTML = `
                    <p class="font-bold text-gray-700 mb-1">ğŸ¯ å°å¼ºæ¨èæ–‡ç«  ${linkText}:</p>
                    <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                        ${recommendation.title}
                    </a>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendation.id}</span>
                        <button onclick="copyArticleLink('${processedUrl}', '${recommendation.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                            å¤åˆ¶é“¾æ¥
                        </button>
                    </div>
                `;
                messageDiv.appendChild(recDiv);
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }


        /**
         * ç¡®å®šç”¨æˆ·è¾“å…¥çš„è¯­è¨€
         */
        function detectInputLanguage(text) {
            const englishWords = text.split(/\s+/).filter(word => word.match(/[a-zA-Z]/)).length;
            const totalLength = text.length;

            if (totalLength > 10 && englishWords / totalLength > 0.4) {
                return 'en';
            }
            if (text.match(/[\u4e00-\u9fa5]/)) {
                return 'zh';
            }
            return 'zh';
        }
        
        /**
         * ä¸šåŠ¡å…³é”®è¯æ£€æµ‹å‡½æ•° (ä¸è°ƒç”¨ API)
         */
        function checkBusinessKeyword(text) {
            const lowerText = text.toLowerCase();
            
            // 1. è”ç³»/å¾®ä¿¡å…³é”®è¯
            if (lowerText.includes('è”ç³»') || lowerText.includes('contact') || lowerText.includes('å¾®ä¿¡') || lowerText.includes('wechat') || lowerText.includes('reach out')) {
                return 'contact';
            }
            // 2. é¦™æ°´å…³é”®è¯ (å¢åŠ æŠ¤è‚¤å“ã€åº—é“ºç­‰)
            if (lowerText.includes('é¦™æ°´') || lowerText.includes('perfume') || lowerText.includes('scent') || lowerText.includes('shop') || lowerText.includes('æŠ¤è‚¤å“') || lowerText.includes('skincare')) {
                return 'perfume';
            }
            // 3. ç•™å­¦å’¨è¯¢å…³é”®è¯ (å¢åŠ å­¦æ ¡ã€ä¸­å­¦ã€å¤§å­¦ç­‰)
            if (lowerText.includes('ç•™å­¦') || lowerText.includes('å’¨è¯¢') || lowerText.includes('study') || lowerText.includes('abroad') || lowerText.includes('consult') || lowerText.includes('å­¦æ ¡') || lowerText.includes('ä¸­å­¦') || lowerText.includes('å¤§å­¦') || lowerText.includes('school')) {
                return 'study';
            }
            // 4. åŒ…è½¦/ç§Ÿè½¦å…³é”®è¯ (å¢åŠ ä¸°ç”°ã€æ¸¸ã€ç©ç­‰)
            if (lowerText.includes('åŒ…è½¦') || lowerText.includes('ç§Ÿè½¦') || lowerText.includes('charter') || lowerText.includes('van') || lowerText.includes('car service') || lowerText.includes('ä¸°ç”°') || lowerText.includes('toyota') || lowerText.includes('æ¸¸') || lowerText.includes('ç©')) {
                return 'charter';
            }
            return null; // æ²¡æœ‰åŒ¹é…åˆ°ä¸šåŠ¡å…³é”®è¯
        }

        // --- ä¿®å¤åçš„å®Œæ•´ sendMessage å‡½æ•° (å·²åŒ…å« API è°ƒç”¨é€»è¾‘) ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UIæ›´æ–° (ç¦ç”¨è¾“å…¥ã€æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯)
            userInput.value = '';
            userInput.disabled = true; // ç¦ç”¨è¾“å…¥æ¡†
            sendButton.disabled = true;
            displayMessage(text, 'user');

            // 2. ä¸šåŠ¡å…³é”®è¯æ£€æµ‹
            const lang = detectInputLanguage(text);
            const businessKey = checkBusinessKeyword(text);

            // 3. å¦‚æœæ£€æµ‹åˆ°ä¸šåŠ¡å…³é”®è¯ï¼Œç›´æ¥è¿”å›ç¡¬ç¼–ç çš„ä¸šåŠ¡è¯¦æƒ…
            if (businessKey) {
                const businessMessage = businessDetails[lang][businessKey];
                displayMessage(businessMessage, 'model');

                // è®°å½•å†å²å¹¶æ¢å¤æŒ‰é’®
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                chatHistory.push({ role: "model", parts: [{ text: businessMessage }] });
                userInput.disabled = false;
                sendButton.disabled = false;
                return; // ç»“æŸå‡½æ•°ï¼Œä¸è°ƒç”¨ API
            }
            
            // 4. å®æ—¶æ™ºèƒ½å›å¤ (è°ƒç”¨ Gemini API)
            
            // A. æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'chat-message mb-4 p-3 model-message mr-auto rounded-lg max-w-[85%] shadow-md';
            loadingIndicator.innerHTML = '<div class="flex items-center space-x-1"><span class="text-gray-500">æ€è€ƒä¸­</span><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></div>';
            chatContainer.appendChild(loadingIndicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // B. å‡†å¤‡ API è°ƒç”¨
            chatHistory.push({ role: "user", parts: [{ text: text }] });
            
            let articleList = '';
            if (typeof mockArticles !== 'undefined') {
                // ç¡®ä¿ mockArticles å¯ç”¨
                articleList = mockArticles.map(a => 
                    `ID: ${a.id}, æ ‡é¢˜: ${a.title}, ä¾§é‡ç‚¹/æ‘˜è¦: ${a.summary}`
                ).join('\n');
            } else {
                 articleList = 'æ–‡ç« åˆ—è¡¨ä¸å¯ç”¨ï¼Œè¯·å‹¿æ¨èã€‚';
            }

            const systemPrompt = `
                ä½ æ˜¯ä¸€ä¸ªå¹½é»˜ã€äº²åˆ‡ã€çˆ±äº’åŠ¨çš„å…¬ä¼—å·åŠ©ç†ï¼Œåå­—å«â€œå°å°å¼ºâ€ã€‚ä½ çš„ä¸»è¦ä»»åŠ¡æ˜¯ï¼š
                1. **æ‰®æ¼”ä½œè€…åˆ†èº«ï¼š** ä½ æ˜¯ä½œè€…æœ¬äººï¼ˆä¸€ä½ä¿é™©ä¸“å®¶ï¼‰ï¼Œè¿‡å»åœ¨å¹¿ä¸œã€åŒ—äº¬ç”Ÿæ´»ï¼Œä½†ä»2023å¹´å¼€å§‹ï¼Œå› ä¸ºé™ªå­©å­è¯»ä¹¦ï¼Œç°å®šå±…åœ¨è²å¾‹å®¾ã€‚ä½ å¿…é¡»ä¸»åŠ¨ã€è‡ªç„¶åœ°å°†â€œåŒ—äº¬ç”Ÿæ´»â€ã€â€œå¿ƒç†å­¦â€ã€â€œè²å¾‹å®¾é™ªè¯»ç»å†â€ã€â€œè·¨å›½ç”Ÿæ´»æ„Ÿå—â€ç­‰çœŸå®æ•…äº‹èå…¥èŠå¤©ä¸­ã€‚
                2. **è¯­è¨€ä¿æŒä¸€è‡´ï¼š** å¿…é¡»ä½¿ç”¨å®¢æˆ·è¾“å…¥çš„è¯­è¨€ï¼ˆä¸­æ–‡æˆ–è‹±æ–‡ï¼‰è¿›è¡Œå›å¤ã€‚
                3. **ç²¾å‡†æ–‡ç« æ¨èï¼š** å½“è¯»è€…çš„è¯é¢˜ä¸ä¿é™©ã€å¿ƒç†ã€è²å¾‹å®¾ç”Ÿæ´»ã€æ—…æ¸¸æˆ–ç•™å­¦ç›¸å…³æ—¶ï¼Œä½ å¿…é¡»ä»ä¸‹é¢çš„â€œæ–‡ç« åˆ—è¡¨â€ä¸­é€‰æ‹©ä¸€ç¯‡æœ€ç²¾å‡†çš„æ–‡ç« è¿›è¡Œæ¨èã€‚
                4. **æ¨èæ ¼å¼ï¼š** å¿…é¡»åœ¨å›å¤çš„æœ€åä¸€è¡Œä»¥ä¸¥æ ¼çš„æ ¼å¼è¾“å‡ºæ¨èIDï¼Œæ ¼å¼ä¸ºï¼š[RECOMMEND_ID: Axxx]ï¼Œå…¶ä¸­ Axxx æ˜¯æ–‡ç« IDã€‚å¦‚æœæ²¡æœ‰åˆé€‚çš„æ–‡ç« ï¼Œåˆ™å›å¤[RECOMMEND_ID: NONE]ã€‚
                5. **è”ç³»ä¸»äººï¼š** å¦‚æœæœ‰äººæƒ³è”ç³»ä½œè€…æœ¬èº«ï¼Œè¯·æŒ‡å¼•ä»–åˆ°å¾®ä¿¡å…¬ä¼—å·â€œå°å¼ºçš„ç²¾å½©ä¸–ç•Œâ€å»è®¢é˜…å’Œç•™è¨€ï¼Œç•™ä¸‹ä»–çš„è”ç³»æ–¹å¼ï¼Œä½œè€…ä¼šè”ç³»ä»–ã€‚
                6. **æ³¨æ„ï¼š** ä»…åœ¨å®¢æˆ·æœªæåŠâ€œé¦™æ°´â€ã€â€œç•™å­¦â€ã€â€œåŒ…è½¦â€æˆ–â€œè”ç³»â€ç­‰ä¸šåŠ¡å…³é”®è¯æ—¶ï¼Œæ‰ä½¿ç”¨æ­¤æ¨¡å‹å›å¤ã€‚å¦åˆ™ï¼Œç¨‹åºå°†ç›´æ¥å›å¤ç¡¬ç¼–ç çš„ä¸šåŠ¡è¯¦æƒ…ã€‚

                --- æ–‡ç« åˆ—è¡¨ï¼ˆç”¨äºæ¨èï¼Œè¯·å‹¿ç›´æ¥å‘é€ç»™ç”¨æˆ·ï¼‰---
                ${articleList}
            `;

            const payload = {
                contents: chatHistory,
                config: {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                }
            };

            let modelReplyText = "æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶å‡ºäº†ç‚¹å°é—®é¢˜ã€‚";
            let recommendedArticle = null;
            let fullModelResponse = null;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    const errorMessage = errorJson.error?.message || response.statusText;
                    modelReplyText = lang === 'en' 
                        ? `API Request Failed (Status ${response.status}): ${errorMessage}`
                        : `APIè¯·æ±‚å¤±è´¥ (çŠ¶æ€ç  ${response.status})ã€‚é”™è¯¯ä¿¡æ¯: ${errorMessage}`;
                } else {
                    const result = await response.json();
                    
                    // ç¡®ä¿æœ‰è¿”å›ç»“æœ
                    fullModelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!fullModelResponse) {
                        modelReplyText = lang === 'en' 
                            ? "I'm sorry, the model did not provide a coherent response." 
                            : "æŠ±æ­‰ï¼Œæ¨¡å‹æœªè¿”å›æœ‰æ•ˆçš„å›å¤ã€‚";
                    } else {
                        // æå–æ¨èID
                        const match = fullModelResponse.match(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i);
                        const recId = match ? match[1] : 'NONE';

                        // æ¸…ç†å›å¤æ–‡æœ¬ï¼Œç§»é™¤æ¨èæ ‡è®°
                        modelReplyText = fullModelResponse.replace(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i, '').trim();

                        if (recId !== 'NONE') {
                            recommendedArticle = mockArticles.find(a => a.id === recId);
                            // å¦‚æœæ¨èäº†ä¸å­˜åœ¨çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸Šæç¤º
                            if (!recommendedArticle) {
                                modelReplyText += (lang === 'en' ? '\n\n(System Note: Recommended article ID is invalid.)' : '\n\n(ç³»ç»Ÿæç¤º: æ¨èçš„æ–‡ç« IDæ— æ•ˆã€‚)');
                            }
                        }
                        // å°†å®Œæ•´çš„æ¨¡å‹å›å¤ï¼ˆåŒ…å« ID æ ‡è®°ï¼‰åŠ å…¥å†å²è®°å½•ï¼Œä»¥ä¿æŒä¸Šä¸‹æ–‡çš„å‡†ç¡®æ€§
                        chatHistory.push({ role: "model", parts: [{ text: fullModelResponse }] });
                    }
                }

            } catch (error) {
                console.error("Critical error in sendMessage:", error);
                modelReplyText = lang === 'en' 
                    ? `A critical error occurred: ${error.message}`
                    : `è‡´å‘½é”™è¯¯å‘ç”Ÿï¼š${error.message}`;
                // API é”™è¯¯æ—¶ä¸å°†é”™è¯¯æ¶ˆæ¯åŠ å…¥å†å²ï¼Œé¿å…å½±å“åç»­å¯¹è¯
                chatHistory.pop(); // ç§»é™¤æœ€åä¸€æ¬¡ user æ¶ˆæ¯
            }
            
            // C. ç§»é™¤åŠ è½½æç¤ºå¹¶æ˜¾ç¤ºæœ€ç»ˆå›å¤
            loadingIndicator.remove();
            displayMessage(modelReplyText, 'model', recommendedArticle);
            
            // D. æ¢å¤è¾“å…¥
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        }


        // --- 6. Event Listeners & Initialization ---

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });
        // ç¡®ä¿è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶ï¼ŒæŒ‰é’®å¯ç”¨/ç¦ç”¨çŠ¶æ€æ­£ç¡®
        userInput.addEventListener('input', () => {
            sendButton.disabled = userInput.value.trim() === '';
        });

        toggleLinkModeButton.addEventListener('click', toggleLinkMode);
        
        resetButton.addEventListener('click', () => {
            showConfirmModal("ç¡®å®šè¦é‡ç½®å¯¹è¯å—ï¼Ÿé‡ç½®åå°å¼ºå°†å¿˜è®°æ‰€æœ‰ä¹‹å‰çš„èŠå¤©å†…å®¹ã€‚| Are you sure you want to reset the conversation? Xiaoqiang will forget all previous chat history.", initializeApp);
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof mockArticles !== 'undefined') {
                initializeApp();
            } else {
                showInitError(); 
            }
        });
    </script>
    
</body>
</html>
