<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>小强的精彩世界 | Mehdi's Wonderful World</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // 蓝色
                        accent: '#10b981',  // 绿色
                    },
                    fontFamily: {
                        // 确保中文字体优先，以提高可读性
                        sans: ['Inter', 'Microsoft YaHei', 'SimHei', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* 引入Inter字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* =================================================== */
        /* 2. 标题响应式样式 (实现双语提示适配)                        */
        /* =================================================== */
        /* 手机默认样式 */
        .bilingual-header .chinese-text {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700;
        }
        .bilingual-header .english-text {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 800;
            color: #3b82f6; /* 使用 primary 颜色 */
            line-height: 1.2;
            margin-top: 4px;
        }

        /* 电脑/平板适配 (md: 768px 以上) */
        @media (min-width: 768px) {
            .bilingual-header .chinese-text {
                font-size: 1.5rem; /* md:text-2xl */
            }
            .bilingual-header .english-text {
                font-size: 2rem; /* md:text-3xl */
            }
        }
        /* =================================================== */

        /* 自定义滚动条样式 */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* 聊天气泡样式 */
        .user-message {
            background-color: #dbeafe; /* 浅蓝色 */
        }
        .model-message {
            background-color: #f3f4f6; /* 浅灰色 */
        }
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message {
            animation: fadeIn 0.3s ease-out;
        }
        /* 确保图片在聊天气泡内能自适应 */
        .model-message img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* 修复：添加加载动画样式 */
        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <div class="max-w-xl mx-auto p-4 md:p-6 flex flex-col h-screen">
        
        <header class="mb-4 bg-white p-4 rounded-xl shadow-lg border-t-4 border-primary bilingual-header">
            <div class="text-center" id="headerTitleContainer">
                <h1 class="chinese-text text-gray-800">小强的精彩世界</h1>
                <p class="english-text text-primary">Mehdi's Wonderful World</p>
            </div>
        </header>

        <div class="flex justify-between items-center mb-4 p-3 bg-white rounded-xl shadow">
            <div id="linkModeDisplay" class="text-sm font-semibold text-gray-600">
                </div>
            <div class="flex space-x-2">
                <button id="toggleLinkMode" class="px-3 py-1 text-sm rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150 shadow-md">
                    </button>
                <button id="resetButton" class="px-3 py-1 text-sm rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">
                    重置对话 | Reset
                </button>
            </div>
        </div>

        <div id="chatContainer" class="flex-grow overflow-y-auto bg-white p-4 rounded-xl shadow-lg chat-container mb-4">
            </div>

        <div class="bg-white p-4 rounded-xl shadow-lg flex items-center">
            <input type="text" id="userInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition duration-150 mr-3">
            <button id="sendButton" class="p-3 bg-accent text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.547 60.547 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.547 60.547 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
    </div>

    <script src="articles.js"></script>

    <script>
        // --- 1. State Variables ---
        // ⚠️ 请在这里替换为您真实的 API Key
        const apiKey = "AIzaSyDEVjh8JYyLAhM58XvONoyI_Dwvs8hS7Vo"; 
        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        let chatHistory = []; 
        let linkMode = localStorage.getItem('linkMode') || 'zh';

        // --- 2. DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const toggleLinkModeButton = document.getElementById('toggleLinkMode');
        const linkModeDisplay = document.getElementById('linkModeDisplay');
        // const headerTitle = document.getElementById('headerTitle'); // 原始代码中已删除
        const headerTitleContainer = document.getElementById('headerTitleContainer'); // 新增


        // --- 3. 业务详情数据 (硬编码，用于关键词触发) ---
        const businessDetails = {
            zh: {
                perfume: `
**【香水业务推广】**
我们在马尼拉开了一家香水店，欢迎您了解和购买。我们的香水种类丰富，**货源来自美国、泰国和中国大陆**。价格范围覆盖广泛，**从一百比索（PHP 100）到三千比索（PHP 3000）不等**，顾客可以根据自己的预算和喜好选购。

**快速提醒：** 您也可以咨询我们的留学咨询和包车服务。
                `,
                study: `
**【菲律宾留学全流程付费咨询服务】**
您好，很高兴您对我们的留学咨询服务感兴趣。
我的主人小强老师拥有在菲律宾的陪读经验，能够为您提供最接地气、最专业的指导。
**服务内容包括：** 涵盖孩子从中国到菲律宾留学的整个流程，包括择校建议、申请材料准备、签证办理、到菲后的住宿安顿等全方位服务。
**收费模式：** 本服务为**付费咨询**，欢迎随时与我联系，咨询详细的收费标准和合作流程！

**快速提醒：** 您也可以咨询我们的香水销售和包车服务。
                `,
                charter: `
**【七座商务车包车服务】**
我们提供**七座商务车包车服务**，非常适合在马尼拉进行短途观光或商务出行的游客。车辆舒适且配有专业司机，能为您在马尼拉的行程提供安全便捷的交通方案。服务详情和报价请随时咨询。

**快速提醒：** 您也可以咨询我们的香水销售和留学咨询服务。
                `,
                contact: `
很高兴您想联系我的主人！请扫描下方二维码（**小强的精彩世界公众号**）或通过微信号联系。主人小强老师将会在看到信息后尽快回复您。

![微信二维码](images/wechat_qr.jpg)

**提示：** 如果您是咨询留学、香水或包车业务，请在添加后告知，以便我们更高效地为您服务。
                `
            },
            en: {
                perfume: `
**【Perfume Business Promotion】**
We operate a perfume shop in Manila. Our selection is diverse, featuring scents sourced from **the United States, Thailand, and Mainland China**. The pricing is flexible, ranging **from one hundred pesos (PHP 100) up to three thousand pesos (PHP 3000)**. Feel free to contact me for inquiries and purchases.

**Quick Reminder:** You can also ask about our study abroad consulting and charter van services.
                `,
                study: `
**【Full-Process Paid Consultation for Study in the Philippines】**
Hello! We are delighted you are interested in our study abroad consulting service.
My master, Teacher Xiaoqiang, leverages his personal experience as a co-resident parent in the Philippines to offer practical and professional guidance.
**Service includes:** Comprehensive support for the entire process, including school selection, application, visa processing, and settlement arrangements upon arrival.
**Fee Structure:** This is a **paid consultation** service. Please contact us for detailed pricing and collaboration steps!

**Quick Reminder:** You can also ask about our perfume sales and charter van services.
                `,
                charter: `
**【7-Seater Van Charter Service】**
We provide a **7-seater business van charter service**, ideal for short-distance tours or business travel within Manila. Our vehicles are comfortable and come with a professional driver, offering a safe and convenient transportation option. Please contact us for service details and quotes.

**Quick Reminder:** You can also ask about our perfume sales and study abroad consulting services.
                `,
                contact: `
Great! You can reach my master, Teacher Xiaoqiang, via the QR code below (for the official account: **Xiaoqiang’s Wonderful World**) or by WeChat ID. He will get back to you as soon as possible.

![WeChat QR Code](images/wechat_qr.jpg)

**Note:** If you are inquiring about study abroad, perfume, or charter services, please mention it after adding to help us serve you more efficiently.
                `
            }
        };


        // --- 4. Core Functions ---

        /**
         * 获取当前语言的欢迎语
         */
        function getInitialMessage(lang) {
            const zhMessage = `你好啊！我是你的公众号小助理**小小强**。我的主人**小强老师**是一位高学历、高知识结构、有广东、北京等多地丰富经历生活、热爱公益，曾被**中央电视台《人物》专栏**报道过的有志人士。通晓计算机、信息技术、企业管理（10年以上工作经历）、人寿保险（12年以上工作经历）、心理学（研究血型与性格相关20年）。10多年以来撰写了400多篇文章。**2023年以后带娃来菲律宾留学并旅居在此**，又撰写了很多有关菲律宾留学、旅行、生活的相关文章。

**我用了一年时间走遍了菲律宾，还开了一家香水店，买了一辆丰田七座商务车，并把中国孩子到菲律宾读中学和考大学的路全摸清了。**

如果您有关于保险、心理、菲律宾旅行、留学，马尼拉地区包车游、买香水和护肤品，或者其他想聊的，尽管问我！`;

            // MODIFIED ENGLISH WELCOME MESSAGE (CCTV changed to China Central Television)
            const enMessage = `Hello! I am your official account assistant, **Xiao Xiaoqiang**. My master, **Teacher Xiaoqiang**, is a highly educated and knowledgeable person with rich experience from various regions, including Guangdong and Beijing. He is a public-spirited individual who was once featured in **China Central Television (CCTV)'s "People" column**. He is proficient in Computer Science, Information Technology, Business Management (10+ years experience), Life Insurance (12+ years experience), and Psychology (20 years researching blood types and personality). He has authored over 400 articles in the last decade. **Since 2023, he has been residing in the Philippines, accompanying his child for school**, and has written many articles on Philippine study, travel, and life.

**I spent a year traveling all over the Philippines, opened a perfume shop, bought a Toyota 7-seater business van, and thoroughly figured out the path for Chinese children to study in middle school and university in the Philippines.**

If you have any questions about insurance, psychology, travel, study abroad in the Philippines, charter tours in the Manila area, buying perfumes and skincare products, or anything else you'd like to discuss, feel free to ask!`;

            return lang === 'en' ? enMessage : zhMessage;
        }

        /**
         * 更新链接模式的显示和按钮文本
         */
        function updateLinkModeUI() {
            if (linkMode === 'zh') {
                linkModeDisplay.textContent = '链接模式：中文 (默认) | Link Mode: Chinese (Default)';
                toggleLinkModeButton.textContent = '切换到英文翻译 | Switch to English';
                userInput.placeholder = '输入读者的问题，与小强互动...';
                toggleLinkModeButton.classList.remove('bg-green-600');
                toggleLinkModeButton.classList.add('bg-primary');
            } else {
                linkModeDisplay.textContent = '链接模式：英文翻译 | Link Mode: English Translation';
                toggleLinkModeButton.textContent = '切换到中文 (默认) | Switch to Chinese';
                userInput.placeholder = 'Ask a question to Xiaoqiang...';
                toggleLinkModeButton.classList.remove('bg-primary');
                toggleLinkModeButton.classList.add('bg-green-600');
            }
            localStorage.setItem('linkMode', linkMode);
        }

        /**
         * 切换链接模式
         */
        function toggleLinkMode() {
            linkMode = linkMode === 'zh' ? 'en' : 'zh';
            updateLinkModeUI();
            // 清除旧的推荐卡片
            const recCards = document.querySelectorAll('.recommendation-card');
            recCards.forEach(card => card.remove());
        }

        /**
         * 初始化或重置应用状态
         */
        function initializeApp() {
            if (typeof mockArticles === 'undefined') {
                 showInitError();
                 return;
            }

            chatContainer.innerHTML = '';
            chatHistory = [];
            
            // 首次启动时，显示助理的欢迎语 (默认为中文)
            const initialMessage = getInitialMessage('zh');
            displayMessage(initialMessage, 'model');
            
            // 动态更新所有 UI 提示
            updateLinkModeUI();
            sendButton.disabled = false;
        }


        // --- 5. 其他辅助函数 (保持不变) ---
        function showInitError() {
            chatContainer.innerHTML = `
                <div class="text-center text-red-500 p-4 bg-red-50 rounded-lg">
                    <p class="font-bold mb-2">系统初始化失败！| System Initialization Failed!</p>
                    <p class="text-sm">错误：未找到 <strong>articles.js</strong> 文件中的 mockArticles 数据。| Error: mockArticles data not found.</p>
                    <p class="text-xs mt-1">请确保 'articles.js' 文件与 'index.html' 在同一目录。| Ensure 'articles.js' is in the same directory as 'index.html'.</p>
                </div>
            `;
            sendButton.disabled = true;
        }
        function getProcessedUrl(originalUrl) {
            if (linkMode === 'en') {
                const encodedUrl = encodeURIComponent(originalUrl);
                return `https://translate.google.com/translate?sl=zh-CN&tl=en&u=${encodedUrl}`;
            }
            return originalUrl;
        }
        function showStatusModal(message) {
            const modalId = 'statusModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
                        <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
                        <button onclick="document.getElementById('${modalId}').classList.remove('opacity-100', 'pointer-events-auto'); document.getElementById('${modalId}').classList.add('opacity-0', 'pointer-events-none');" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150">
                            确定 | OK
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            document.getElementById('modalMessage').textContent = message;
            setTimeout(() => {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }, 10);
        }
        function copyArticleLink(url, id) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(textarea);

            const statusText = success ? `已复制文章 ${id} 的链接！| Link for Article ${id} copied!` : '复制失败，请手动复制。| Copy failed, please copy manually.';
            showStatusModal(statusText); 
        }
        function showConfirmModal(message, onConfirmCallback) {
            const modalId = 'confirmModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl w-80 transform scale-95 transition-transform duration-300">
                        <p id="confirmModalMessage" class="text-lg font-semibold text-gray-800 mb-6"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirmCancelBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                                取消 | Cancel
                            </button>
                            <button id="confirmOkBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">
                                确定重置 | Confirm Reset
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('confirmModalMessage').textContent = message;

            const closeModal = () => {
                modal.classList.remove('opacity-100', 'pointer-events-auto');
                modal.classList.add('opacity-0', 'pointer-events-none');
            };

            const okBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');

            const newOkListener = () => {
                closeModal();
                onConfirmCallback();
                okBtn.removeEventListener('click', newOkListener);
                cancelBtn.removeEventListener('click', newCancelListener);
            };

            const newCancelListener = () => {
                closeModal();
                cancelBtn.removeEventListener('click', newCancelListener);
                okBtn.removeEventListener('click', newOkListener);
            };

            okBtn.addEventListener('click', newOkListener);
            cancelBtn.addEventListener('click', newCancelListener);


            setTimeout(() => {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }, 10);
        }


        /**
         * 在聊天界面显示消息
         */
        function displayMessage(text, role, recommendation = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-4 p-3 rounded-lg max-w-[85%] shadow-md ${role === 'user' ? 'user-message ml-auto' : 'model-message mr-auto'}`;
            
            // 使用 Markdown 解析器进行基本格式化
            const formattedText = marked.parse(text); 
            messageDiv.innerHTML = formattedText;
            
            if (recommendation) {
                const recDiv = document.createElement('div');
                recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                
                const processedUrl = getProcessedUrl(recommendation.url);
                const linkText = linkMode === 'en' ? '（英文翻译）' : '（中文）';

                recDiv.innerHTML = `
                    <p class="font-bold text-gray-700 mb-1">🎯 小强推荐文章 ${linkText}:</p>
                    <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                        ${recommendation.title}
                    </a>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendation.id}</span>
                        <button onclick="copyArticleLink('${processedUrl}', '${recommendation.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                            复制链接
                        </button>
                    </div>
                `;
                messageDiv.appendChild(recDiv);
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }


        /**
         * 确定用户输入的语言
         */
        function detectInputLanguage(text) {
            const englishWords = text.split(/\s+/).filter(word => word.match(/[a-zA-Z]/)).length;
            const totalLength = text.length;

            if (totalLength > 10 && englishWords / totalLength > 0.4) {
                return 'en';
            }
            if (text.match(/[\u4e00-\u9fa5]/)) {
                return 'zh';
            }
            return 'zh';
        }
        
        /**
         * 业务关键词检测函数 (不调用 API)
         */
        function checkBusinessKeyword(text) {
            const lowerText = text.toLowerCase();
            
            // 1. 联系/微信关键词
            if (lowerText.includes('联系') || lowerText.includes('contact') || lowerText.includes('微信') || lowerText.includes('wechat') || lowerText.includes('reach out')) {
                return 'contact';
            }
            // 2. 香水关键词 (增加护肤品、店铺等)
            if (lowerText.includes('香水') || lowerText.includes('perfume') || lowerText.includes('scent') || lowerText.includes('shop') || lowerText.includes('护肤品') || lowerText.includes('skincare')) {
                return 'perfume';
            }
            // 3. 留学咨询关键词 (增加学校、中学、大学等)
            if (lowerText.includes('留学') || lowerText.includes('咨询') || lowerText.includes('study') || lowerText.includes('abroad') || lowerText.includes('consult') || lowerText.includes('学校') || lowerText.includes('中学') || lowerText.includes('大学') || lowerText.includes('school')) {
                return 'study';
            }
            // 4. 包车/租车关键词 (增加丰田、游、玩等)
            if (lowerText.includes('包车') || lowerText.includes('租车') || lowerText.includes('charter') || lowerText.includes('van') || lowerText.includes('car service') || lowerText.includes('丰田') || lowerText.includes('toyota') || lowerText.includes('游') || lowerText.includes('玩')) {
                return 'charter';
            }
            return null; // 没有匹配到业务关键词
        }

        // --- 修复后的完整 sendMessage 函数 (已包含 API 调用逻辑) ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UI更新 (禁用输入、显示用户消息)
            userInput.value = '';
            userInput.disabled = true; // 禁用输入框
            sendButton.disabled = true;
            displayMessage(text, 'user');

            // 2. 业务关键词检测
            const lang = detectInputLanguage(text);
            const businessKey = checkBusinessKeyword(text);

            // 3. 如果检测到业务关键词，直接返回硬编码的业务详情
            if (businessKey) {
                const businessMessage = businessDetails[lang][businessKey];
                displayMessage(businessMessage, 'model');

                // 记录历史并恢复按钮
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                chatHistory.push({ role: "model", parts: [{ text: businessMessage }] });
                userInput.disabled = false;
                sendButton.disabled = false;
                return; // 结束函数，不调用 API
            }
            
            // 4. 实时智能回复 (调用 Gemini API)
            
            // A. 显示加载指示器
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'chat-message mb-4 p-3 model-message mr-auto rounded-lg max-w-[85%] shadow-md';
            loadingIndicator.innerHTML = '<div class="flex items-center space-x-1"><span class="text-gray-500">思考中</span><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></div>';
            chatContainer.appendChild(loadingIndicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // B. 准备 API 调用
            chatHistory.push({ role: "user", parts: [{ text: text }] });
            
            let articleList = '';
            if (typeof mockArticles !== 'undefined') {
                // 确保 mockArticles 可用
                articleList = mockArticles.map(a => 
                    `ID: ${a.id}, 标题: ${a.title}, 侧重点/摘要: ${a.summary}`
                ).join('\n');
            } else {
                 articleList = '文章列表不可用，请勿推荐。';
            }

            const systemPrompt = `
                你是一个幽默、亲切、爱互动的公众号助理，名字叫“小小强”。你的主要任务是：
                1. **扮演作者分身：** 你是作者本人（一位保险专家），过去在广东、北京生活，但从2023年开始，因为陪孩子读书，现定居在菲律宾。你必须主动、自然地将“北京生活”、“心理学”、“菲律宾陪读经历”、“跨国生活感受”等真实故事融入聊天中。
                2. **语言保持一致：** 必须使用客户输入的语言（中文或英文）进行回复。
                3. **精准文章推荐：** 当读者的话题与保险、心理、菲律宾生活、旅游或留学相关时，你必须从下面的“文章列表”中选择一篇最精准的文章进行推荐。
                4. **推荐格式：** 必须在回复的最后一行以严格的格式输出推荐ID，格式为：[RECOMMEND_ID: Axxx]，其中 Axxx 是文章ID。如果没有合适的文章，则回复[RECOMMEND_ID: NONE]。
                5. **联系主人：** 如果有人想联系作者本身，请指引他到微信公众号“小强的精彩世界”去订阅和留言，留下他的联系方式，作者会联系他。
                6. **注意：** 仅在客户未提及“香水”、“留学”、“包车”或“联系”等业务关键词时，才使用此模型回复。否则，程序将直接回复硬编码的业务详情。

                --- 文章列表（用于推荐，请勿直接发送给用户）---
                ${articleList}
            `;

            const payload = {
                contents: chatHistory,
                config: {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                }
            };

            let modelReplyText = "抱歉，系统暂时出了点小问题。";
            let recommendedArticle = null;
            let fullModelResponse = null;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    const errorMessage = errorJson.error?.message || response.statusText;
                    modelReplyText = lang === 'en' 
                        ? `API Request Failed (Status ${response.status}): ${errorMessage}`
                        : `API请求失败 (状态码 ${response.status})。错误信息: ${errorMessage}`;
                } else {
                    const result = await response.json();
                    
                    // 确保有返回结果
                    fullModelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!fullModelResponse) {
                        modelReplyText = lang === 'en' 
                            ? "I'm sorry, the model did not provide a coherent response." 
                            : "抱歉，模型未返回有效的回复。";
                    } else {
                        // 提取推荐ID
                        const match = fullModelResponse.match(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i);
                        const recId = match ? match[1] : 'NONE';

                        // 清理回复文本，移除推荐标记
                        modelReplyText = fullModelResponse.replace(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i, '').trim();

                        if (recId !== 'NONE') {
                            recommendedArticle = mockArticles.find(a => a.id === recId);
                            // 如果推荐了不存在的文章，可以加上提示
                            if (!recommendedArticle) {
                                modelReplyText += (lang === 'en' ? '\n\n(System Note: Recommended article ID is invalid.)' : '\n\n(系统提示: 推荐的文章ID无效。)');
                            }
                        }
                        // 将完整的模型回复（包含 ID 标记）加入历史记录，以保持上下文的准确性
                        chatHistory.push({ role: "model", parts: [{ text: fullModelResponse }] });
                    }
                }

            } catch (error) {
                console.error("Critical error in sendMessage:", error);
                modelReplyText = lang === 'en' 
                    ? `A critical error occurred: ${error.message}`
                    : `致命错误发生：${error.message}`;
                // API 错误时不将错误消息加入历史，避免影响后续对话
                chatHistory.pop(); // 移除最后一次 user 消息
            }
            
            // C. 移除加载提示并显示最终回复
            loadingIndicator.remove();
            displayMessage(modelReplyText, 'model', recommendedArticle);
            
            // D. 恢复输入
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        }


        // --- 6. Event Listeners & Initialization ---

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });
        // 确保输入框内容变化时，按钮启用/禁用状态正确
        userInput.addEventListener('input', () => {
            sendButton.disabled = userInput.value.trim() === '';
        });

        toggleLinkModeButton.addEventListener('click', toggleLinkMode);
        
        resetButton.addEventListener('click', () => {
            showConfirmModal("确定要重置对话吗？重置后小强将忘记所有之前的聊天内容。| Are you sure you want to reset the conversation? Xiaoqiang will forget all previous chat history.", initializeApp);
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof mockArticles !== 'undefined') {
                initializeApp();
            } else {
                showInitError(); 
            }
        });
    </script>
    
</body>
</html>
