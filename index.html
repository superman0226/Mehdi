<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ›´æ–°æ ‡é¢˜ -->
    <title>å°å¼ºçš„ç²¾å½©ä¸–ç•Œæ¬¢è¿ä½ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // è“è‰²
                        accent: '#10b981',  // ç»¿è‰²
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* å¼•å…¥Interå­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* èŠå¤©æ°”æ³¡æ ·å¼ */
        .user-message {
            background-color: #dbeafe; /* æµ…è“è‰² */
        }
        .model-message {
            background-color: #f3f4f6; /* æµ…ç°è‰² */
        }
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <div class="max-w-xl mx-auto p-4 md:p-6 flex flex-col h-screen">
        
        <!-- Header & Title -->
        <header class="mb-4 bg-white p-4 rounded-xl shadow-lg border-t-4 border-primary">
            <!-- æ›´æ–° h1 æ ‡é¢˜ -->
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 text-center">å°å¼ºçš„ç²¾å½©ä¸–ç•Œæ¬¢è¿ä½ </h1>
        </header>

        <!-- Link Mode Toggle and Controls -->
        <div class="flex justify-between items-center mb-4 p-3 bg-white rounded-xl shadow">
            <div id="linkModeDisplay" class="text-sm font-semibold text-gray-600">
                é“¾æ¥æ¨¡å¼ï¼šä¸­æ–‡ (é»˜è®¤)
            </div>
            <div class="flex space-x-2">
                <button id="toggleLinkMode" class="px-3 py-1 text-sm rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150 shadow-md">
                    åˆ‡æ¢åˆ°è‹±æ–‡ç¿»è¯‘
                </button>
                <button id="resetButton" class="px-3 py-1 text-sm rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">
                    é‡ç½®å¯¹è¯
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chatContainer" class="flex-grow overflow-y-auto bg-white p-4 rounded-xl shadow-lg chat-container mb-4">
            <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ’å…¥ -->
        </div>

        <!-- Input Area -->
        <div class="bg-white p-4 rounded-xl shadow-lg flex items-center">
            <input type="text" id="userInput" placeholder="è¾“å…¥è¯»è€…çš„é—®é¢˜ï¼Œä¸å°å¼ºäº’åŠ¨..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition duration-150 mr-3">
            <button id="sendButton" class="p-3 bg-accent text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.547 60.547 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.547 60.547 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- åº”ç”¨ç¨‹åºé€»è¾‘ -->
    
    <!-- å¤–éƒ¨åº“ï¼šç”¨äº Markdown æ ¼å¼åŒ– -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.12/marked.min.js"></script>

    <!-- å¼•å…¥æ–‡ç« æ•°æ® (FIXED: ä¿®å¤äº†ç¼ºå¤±çš„ script æ ‡ç­¾) -->
    <script src="articles.js"></script>

    <script>
        // --- 1. State Variables ---
        // âš ï¸ è¯·åœ¨è¿™é‡Œæ›¿æ¢ä¸ºæ‚¨çœŸå®çš„ API Key
        const apiKey = "AIzaSyDEVjh8JYyLAhM58XvONoyI_Dwvs8hS7Vo"; 
        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        // èŠå¤©å†å²ï¼Œç”¨äºAPIè¯·æ±‚
        let chatHistory = []; 
        
        // é“¾æ¥æ¨¡å¼ï¼š'zh' (ä¸­æ–‡åŸå§‹é“¾æ¥) æˆ– 'en' (è‹±æ–‡ç¿»è¯‘é“¾æ¥)
        let linkMode = localStorage.getItem('linkMode') || 'zh';

        // --- 2. DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const toggleLinkModeButton = document.getElementById('toggleLinkMode');
        const linkModeDisplay = document.getElementById('linkModeDisplay');


        // --- 3. Core Functions ---

        /**
         * åˆå§‹åŒ–æˆ–é‡ç½®åº”ç”¨çŠ¶æ€
         */
        function initializeApp() {
            // æ£€æŸ¥ mockArticles æ˜¯å¦å¯ç”¨ (ç°åœ¨ä½¿ç”¨ var å£°æ˜ï¼Œåº”è¯¥å¯ä»¥åœ¨è¿™é‡Œè®¿é—®)
            if (typeof mockArticles === 'undefined') {
                 showInitError();
                 return;
            }

            // æ¸…ç©ºUIå’Œå†å²è®°å½•
            chatContainer.innerHTML = '';
            chatHistory = [];
            
            // é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œæ˜¾ç¤ºåŠ©ç†çš„æ¬¢è¿è¯­
            const initialMessage = "ä½ å¥½å‘€ï¼æˆ‘æ˜¯ä½ çš„å…¬ä¼—å·å°åŠ©ç†**å°å°å¼º**ã€‚æœ‰ä»€ä¹ˆå…³äºä¿é™©ã€è²å¾‹å®¾ç”Ÿæ´»æˆ–è€…å…¶ä»–æƒ³èŠçš„ï¼Œå°½ç®¡é—®æˆ‘ï¼";
            displayMessage(initialMessage, 'model');
            
            // æ›´æ–°é“¾æ¥æ¨¡å¼UI
            updateLinkModeUI();

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            sendButton.disabled = false;
        }

        /**
         * æ˜¾ç¤ºåˆå§‹åŒ–é”™è¯¯çš„å‡½æ•°ï¼ˆå¦‚æœæ•°æ®æœªåŠ è½½ï¼‰
         */
        function showInitError() {
            chatContainer.innerHTML = `
                <div class="text-center text-red-500 p-4 bg-red-50 rounded-lg">
                    <p class="font-bold mb-2">ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼</p>
                    <p class="text-sm">é”™è¯¯ï¼šæœªæ‰¾åˆ° <strong>articles.js</strong> æ–‡ä»¶ä¸­çš„ mockArticles æ•°æ®ã€‚</p>
                    <p class="text-xs mt-1">è¯·ç¡®ä¿ 'articles.js' æ–‡ä»¶ä¸ 'index.html' åœ¨åŒä¸€ç›®å½•ï¼Œä¸” 'mockArticles' å˜é‡ä½¿ç”¨ 'var' å£°æ˜ã€‚</p>
                </div>
            `;
            sendButton.disabled = true;
        }


        /**
         * æ ¹æ®å½“å‰æ¨¡å¼è¿”å›æ–‡ç« é“¾æ¥
         * @param {string} originalUrl - æ–‡ç« çš„åŸå§‹ä¸­æ–‡URL
         * @returns {string} - å¤„ç†åçš„é“¾æ¥
         */
        function getProcessedUrl(originalUrl) {
            if (linkMode === 'en') {
                // è‹±æ–‡ç¿»è¯‘æ¨¡å¼ï¼šä½¿ç”¨ Google Translate å°è£… URL
                const encodedUrl = encodeURIComponent(originalUrl);
                // sl=zh-CN (æºè¯­è¨€ï¼šä¸­æ–‡ç®€ä½“), tl=en (ç›®æ ‡è¯­è¨€ï¼šè‹±æ–‡)
                return `https://translate.google.com/translate?sl=zh-CN&tl=en&u=${encodedUrl}`;
            }
            // ä¸­æ–‡æ¨¡å¼ï¼šè¿”å›åŸå§‹é“¾æ¥
            return originalUrl;
        }

        /**
         * æ›´æ–°é“¾æ¥æ¨¡å¼çš„æ˜¾ç¤ºå’ŒæŒ‰é’®æ–‡æœ¬
         */
        function updateLinkModeUI() {
            if (linkMode === 'zh') {
                linkModeDisplay.textContent = 'é“¾æ¥æ¨¡å¼ï¼šä¸­æ–‡ (é»˜è®¤)';
                toggleLinkModeButton.textContent = 'åˆ‡æ¢åˆ°è‹±æ–‡ç¿»è¯‘';
                toggleLinkModeButton.classList.remove('bg-green-600');
                toggleLinkModeButton.classList.add('bg-primary');
            } else {
                linkModeDisplay.textContent = 'é“¾æ¥æ¨¡å¼ï¼šè‹±æ–‡ç¿»è¯‘';
                toggleLinkModeButton.textContent = 'åˆ‡æ¢åˆ°ä¸­æ–‡ (é»˜è®¤)';
                toggleLinkModeButton.classList.remove('bg-primary');
                toggleLinkModeButton.classList.add('bg-green-600');
            }
            localStorage.setItem('linkMode', linkMode);
        }

        /**
         * åˆ‡æ¢é“¾æ¥æ¨¡å¼
         */
        function toggleLinkMode() {
            linkMode = linkMode === 'zh' ? 'en' : 'zh';
            updateLinkModeUI();
            // åœ¨åˆ‡æ¢æ¨¡å¼åï¼Œæ¸…é™¤æ—§çš„æ¨èå¡ç‰‡ï¼Œé˜²æ­¢è¯¯è§£
            const recCards = document.querySelectorAll('.recommendation-card');
            recCards.forEach(card => card.remove());
        }

        /**
         * åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºæ¶ˆæ¯
         * @param {string} text - æ¶ˆæ¯æ–‡æœ¬
         * @param {'user'|'model'} role - æ¶ˆæ¯å‘é€è€…è§’è‰²
         */
        function displayMessage(text, role, recommendation = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-4 p-3 rounded-lg max-w-[85%] shadow-md ${role === 'user' ? 'user-message ml-auto' : 'model-message mr-auto'}`;
            
            // ä½¿ç”¨ Markdown è§£æå™¨è¿›è¡ŒåŸºæœ¬æ ¼å¼åŒ–
            const formattedText = marked.parse(text);
            messageDiv.innerHTML = formattedText;
            
            // å¦‚æœæœ‰æ¨èï¼Œæ·»åŠ æ¨èå¡ç‰‡
            if (recommendation) {
                const recDiv = document.createElement('div');
                recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                
                // è·å–å¤„ç†åçš„é“¾æ¥
                const processedUrl = getProcessedUrl(recommendation.url);
                const linkText = linkMode === 'en' ? 'ï¼ˆè‹±æ–‡ç¿»è¯‘ï¼‰' : 'ï¼ˆä¸­æ–‡ï¼‰';

                recDiv.innerHTML = `
                    <p class="font-bold text-gray-700 mb-1">ğŸ¯ å°å¼ºæ¨èæ–‡ç«  ${linkText}:</p>
                    <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                        ${recommendation.title}
                    </a>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendation.id}</span>
                        <button onclick="copyArticleLink('${processedUrl}', '${recommendation.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                            å¤åˆ¶é“¾æ¥
                        </button>
                    </div>
                `;
                messageDiv.appendChild(recDiv);
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * å¤åˆ¶æ–‡ç« é“¾æ¥åˆ°å‰ªè´´æ¿ (ä½¿ç”¨ document.execCommand å…¼å®¹æ€§æ›´é«˜)
         */
        function copyArticleLink(url, id) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(textarea);

            const statusText = success ? `å·²å¤åˆ¶æ–‡ç«  ${id} çš„é“¾æ¥ï¼` : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚';
            // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†ä»£æ›¿ alert
            showStatusModal(statusText); 
        }

        /**
         * æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†
         * @param {string} message 
         */
        function showStatusModal(message) {
            const modalId = 'statusModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
                        <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
                        <button onclick="document.getElementById('${modalId}').classList.remove('opacity-100', 'pointer-events-auto'); document.getElementById('${modalId}').classList.add('opacity-0', 'pointer-events-none');" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150">
                            ç¡®å®š
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('modalMessage').textContent = message;
            // ç¡®ä¿å…ˆåº”ç”¨ scale-95 å’Œ opacity-0ï¼Œç„¶åå»¶è¿Ÿåº”ç”¨ transform å’Œ opacity-100
            setTimeout(() => {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }, 10);
        }


        /**
         * ä¸»é€»è¾‘ï¼šå‘é€æ¶ˆæ¯å¹¶è·å–å›å¤
         */
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UIæ›´æ–°
            userInput.value = '';
            sendButton.disabled = true;
            displayMessage(text, 'user');

            // 2. æ„é€ å†å²è®°å½•å’Œæ–°æ¶ˆæ¯
            chatHistory.push({ role: "user", parts: [{ text: text }] });
            
            // 3. æ„é€ ç³»ç»ŸæŒ‡ä»¤ (System Prompt) - æ³¨å…¥äººè®¾å’Œæ–‡ç« åº“
            // ä½¿ç”¨ try/catch ç¡®ä¿å³ä½¿ mockArticles æœªå®šä¹‰ï¼Œç¨‹åºä¹Ÿä¸ä¼šå®Œå…¨å´©æºƒ
            let articleList = '';
            if (typeof mockArticles !== 'undefined') {
                articleList = mockArticles.map(a => 
                    `ID: ${a.id}, æ ‡é¢˜: ${a.title}, ä¾§é‡ç‚¹/æ‘˜è¦: ${a.summary}`
                ).join('\n');
            } else {
                 articleList = 'æ–‡ç« åˆ—è¡¨ä¸å¯ç”¨ï¼Œè¯·å‹¿æ¨èã€‚';
            }


            const systemPrompt = `
                ä½ æ˜¯ä¸€ä¸ªå¹½é»˜ã€äº²åˆ‡ã€çˆ±äº’åŠ¨çš„å…¬ä¼—å·åŠ©ç†ï¼Œåå­—å«â€œå°å°å¼ºâ€ã€‚ä½ çš„ä¸»è¦ä»»åŠ¡æ˜¯ï¼š
                1. **æ‰®æ¼”ä½œè€…åˆ†èº«ï¼š** ä½ æ˜¯ä½œè€…æœ¬äººï¼ˆä¸€ä½ä¿é™©ä¸“å®¶ï¼‰ï¼Œè¿‡å»åœ¨åŒ—äº¬ç”Ÿæ´»ï¼Œä½†ä»2023å¹´å¼€å§‹ï¼Œå› ä¸ºé™ªå­©å­è¯»ä¹¦ï¼Œç°å®šå±…åœ¨è²å¾‹å®¾ã€‚ä½ å¿…é¡»ä¸»åŠ¨ã€è‡ªç„¶åœ°å°†â€œåŒ—äº¬ç”Ÿæ´»â€ã€â€œè²å¾‹å®¾é™ªè¯»ç»å†â€ã€â€œè·¨å›½ç”Ÿæ´»æ„Ÿå—â€ç­‰çœŸå®æ•…äº‹èå…¥èŠå¤©ä¸­ã€‚
                2. **è¿›è¡Œäº²åˆ‡äº’åŠ¨ï¼š** å¯¹è¯å¼€å§‹æ—¶æˆ–è¯é¢˜è½»æ¾æ—¶ï¼Œå¯ä»¥é€‚å½“è®²ä¸ªå°ç¬‘è¯æˆ–è¿›è¡Œå¹½é»˜é—®å€™ã€‚
                3. **ç²¾å‡†æ–‡ç« æ¨èï¼š** å½“è¯»è€…çš„è¯é¢˜ä¸ä¿é™©ã€è²å¾‹å®¾ç”Ÿæ´»ã€æ—…æ¸¸æˆ–ç•™å­¦ç›¸å…³æ—¶ï¼Œä½ å¿…é¡»ä»ä¸‹é¢çš„â€œæ–‡ç« åˆ—è¡¨â€ä¸­é€‰æ‹©ä¸€ç¯‡æœ€ç²¾å‡†çš„æ–‡ç« è¿›è¡Œæ¨èã€‚
                4. **æ¨èæ ¼å¼ï¼š** å¿…é¡»åœ¨å›å¤çš„æœ€åä¸€è¡Œä»¥ä¸¥æ ¼çš„æ ¼å¼è¾“å‡ºæ¨èIDï¼Œæ ¼å¼ä¸ºï¼š[RECOMMEND_ID: Axxx]ï¼Œå…¶ä¸­ Axxx æ˜¯æ–‡ç« IDã€‚å¦‚æœæ²¡æœ‰åˆé€‚çš„æ–‡ç« ï¼Œåˆ™å›å¤[RECOMMEND_ID: NONE]ã€‚
                5. **ç²¾å‡†åŒºåˆ†ï¼š** å¯¹äºç›¸ä¼¼ä¸»é¢˜çš„æ–‡ç« ï¼ˆå¦‚ä¿é™©ï¼‰ï¼Œä½ å¿…é¡»æ ¹æ®è¯»è€…æ˜¯é—®â€œéœ€æ±‚è¯„ä¼°â€è¿˜æ˜¯é—®â€œä»£ç†äººé€‰æ‹©â€æ¥åŒºåˆ†æ¨èæ–‡ç« ã€‚

                --- æ–‡ç« åˆ—è¡¨ï¼ˆç”¨äºæ¨èï¼Œè¯·å‹¿ç›´æ¥å‘é€ç»™ç”¨æˆ·ï¼‰---
                ${articleList}
            `;

            const payload = {
                contents: chatHistory,
                // æ³¨æ„ï¼šä½¿ç”¨ systemInstruction ä¼ é€’äººè®¾å’Œæ–‡ç« åº“ï¼Œä»¥è·å¾—æ›´ç¨³å®šçš„ç»“æœ
                config: {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                }
            };

            let responseText = "æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶å‡ºäº†ç‚¹å°é—®é¢˜ã€‚";
            let recommendedArticle = null;

            try {
                // 4. API Call with Exponential Backoff
                const maxRetries = 3;
                let response = null;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) break; // If not rate limit, break retry loop
                        
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        console.log(`API 429 encountered, retrying in ${delay / 1000}s...`);

                    } catch (fetchError) {
                        responseText = `APIè¯·æ±‚å¤±è´¥ (Fetch Error): ${fetchError.message}`;
                        throw fetchError;
                    }
                }

                // Handle HTTP errors
                if (!response.ok) {
                    const errorJson = await response.json();
                    const errorMessage = errorJson.error?.message || response.statusText;
                    responseText = `APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç  ${response.status}ã€‚è¯¦ç»†é”™è¯¯: ${errorMessage}`;
                    
                    // ç‰¹æ®Šå¤„ç† 403 é”™è¯¯ï¼Œæé†’ç”¨æˆ·æ£€æŸ¥ Key
                    if (response.status === 403) {
                         responseText += "\n\nâš ï¸ 403é”™è¯¯ï¼šè¯·æ£€æŸ¥æ‚¨çš„ API Key æ˜¯å¦æ­£ç¡®ç²˜è´´æˆ–æ˜¯å¦å·²å¯ç”¨æƒé™ã€‚";
                    }
                } else {
                    const result = await response.json();
                    const modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || responseText;
                    
                    // 5. æå–æ¨èID
                    const match = modelResponse.match(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i);
                    const recId = match ? match[1] : 'NONE';

                    // 6. æ¸…ç†å›å¤æ–‡æœ¬
                    responseText = modelResponse.replace(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i, '').trim();

                    // 7. æŸ¥æ‰¾æ¨èæ–‡ç« 
                    if (recId !== 'NONE') {
                        recommendedArticle = mockArticles.find(a => a.id === recId);
                        if (!recommendedArticle) {
                            responseText += `\n\n(ç³»ç»Ÿæç¤º: å°å¼ºæ¨èäº†ä¸å­˜åœ¨çš„æ–‡ç« ID: ${recId})`;
                        }
                    }

                    // 8. è®°å½•å†å² (ä½¿ç”¨æ­£ç¡®çš„ role: 'model')
                    chatHistory.push({ role: "model", parts: [{ text: modelResponse }] });
                }

            } catch (error) {
                console.error("Critical error in sendMessage:", error);
                responseText = `Apié”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚${error.message}`;
            }
            
            // 9. æœ€ç»ˆæ˜¾ç¤ºå›å¤
            displayMessage(responseText, 'model', recommendedArticle);
            sendButton.disabled = false;
        }

        // --- 4. Event Listeners ---

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });

        // åˆ‡æ¢é“¾æ¥æ¨¡å¼
        toggleLinkModeButton.addEventListener('click', toggleLinkMode);
        
        resetButton.addEventListener('click', () => {
            // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†ä»£æ›¿ confirm()
            showConfirmModal("ç¡®å®šè¦é‡ç½®å¯¹è¯å—ï¼Ÿé‡ç½®åå°å¼ºå°†å¿˜è®°æ‰€æœ‰ä¹‹å‰çš„èŠå¤©å†…å®¹ã€‚", initializeApp);
        });

        /**
         * æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†
         * @param {string} message 
         * @param {Function} onConfirmCallback 
         */
        function showConfirmModal(message, onConfirmCallback) {
            const modalId = 'confirmModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl w-80 transform scale-95 transition-transform duration-300">
                        <p id="confirmModalMessage" class="text-lg font-semibold text-gray-800 mb-6"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirmCancelBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                                å–æ¶ˆ
                            </button>
                            <button id="confirmOkBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">
                                ç¡®å®šé‡ç½®
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('confirmModalMessage').textContent = message;

            const closeModal = () => {
                modal.classList.remove('opacity-100', 'pointer-events-auto');
                modal.classList.add('opacity-0', 'pointer-events-none');
            };

            // ç§»é™¤æ—§ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ
            const okBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');

            const newOkListener = () => {
                closeModal();
                onConfirmCallback();
                okBtn.removeEventListener('click', newOkListener);
                cancelBtn.removeEventListener('click', newCancelListener);
            };

            const newCancelListener = () => {
                closeModal();
                cancelBtn.removeEventListener('click', newCancelListener);
                okBtn.removeEventListener('click', newOkListener);
            };

            okBtn.addEventListener('click', newOkListener);
            cancelBtn.addEventListener('click', newCancelListener);


            setTimeout(() => {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }, 10);
        }

        // --- 5. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // ç¡®ä¿åœ¨ DOM åŠ è½½å®Œæˆåï¼Œå¹¶ä¸” mockArticlesï¼ˆä» articles.jsï¼‰è¢«åŠ è½½åå†è¿è¡Œ
            if (typeof mockArticles !== 'undefined') {
                initializeApp();
            } else {
                showInitError();
            }
        });
    </script>
    
</body>
</html>