<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¯¹è¯æ–‡ç« æ¨èç³»ç»Ÿ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .loading-spinner { border-top-color: #4f46e5; -webkit-animation: spin 1s ease-in-out infinite; animation: spin 1s ease-in-out infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom chat scrollbar for aesthetics */
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        #chat-history::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <div id="app" class="w-full max-w-lg bg-white rounded-xl shadow-2xl flex flex-col h-[85vh] md:h-[90vh]">

        <!-- Header -->
        <header class="p-4 border-b border-gray-200 bg-indigo-600 text-white rounded-t-xl flex justify-between items-center">
            <h1 class="text-xl font-bold">ğŸ¤– å…¬ä¼—å· AI åŠ©ç†</h1>
            <button id="reset-button" onclick="resetChat()"
                    class="px-3 py-1 text-sm bg-indigo-700 hover:bg-indigo-800 rounded-lg transition duration-150 flex items-center space-x-1">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M15.31 11.24a5.5 5.5 0 00-6.19-5.18l-.55-.1c-1.39-.28-2.82.02-3.8.87a6 6 0 00-.73 5.48.75.75 0 01-1.35.47 7.5 7.5 0 01.87-6.52c1.4-1.2 3.34-1.63-5.22-1.25a7.002 7.002 0 017.37 6.64.75.75 0 01-1.5-.18zM4.69 8.76a5.5 5.5 0 006.19 5.18l.55.1c1.39.28 2.82-.02 3.8-.87a6 6 0 00.73-5.48.75.75 0 011.35-.47 7.5 7.5 0 01-.87 6.52c-1.4 1.2-3.34 1.63-5.22 1.25a7.002 7.002 0 01-7.37-6.64.75.75 0 011.5.18z" clip-rule="evenodd" />
                </svg>
                <span>é‡ç½®å¯¹è¯</span>
            </button>
        </header>

        <!-- Chat History -->
        <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto">
            <!-- Initial Message will be added by JS in resetChat() -->
        </div>

        <!-- Recommendation Card (Hidden by default) -->
        <div id="recommendation-card" class="hidden p-4 bg-green-50 border-t-4 border-green-400">
            <p class="text-green-800 font-bold mb-2">ğŸ‰ æ¨èæ–‡ç«  (å·²é”å®š):</p>
            <div class="bg-white p-3 rounded-lg shadow-inner flex flex-col space-y-1">
                <p class="text-sm font-medium text-gray-800 truncate">
                    æ ‡é¢˜: <span id="recommended-title" class="text-indigo-600 font-bold"></span>
                </p>
                <p class="text-xs text-gray-500">
                    ID: <span id="recommended-id" class="font-mono bg-green-100 px-1 rounded text-green-700"></span>
                </p>
            </div>
            <p id="recommendation-reasoning" class="text-xs text-gray-600 mt-2 italic"></p>
        </div>
        
        <!-- Input Area and Loading Indicator -->
        <div class="p-4 border-t border-gray-200 bg-white flex items-center space-x-2">
            <input 
                id="user-input" 
                type="text" 
                placeholder="åœ¨æ­¤è¾“å…¥è¯»è€…çš„é—®é¢˜ï¼Œä¸åŠ©ç†è¿›è¡Œå¯¹è¯..."
                class="flex-grow p-3 border border-gray-300 rounded-full focus:ring-indigo-500 focus:border-indigo-500 shadow-inner"
                onkeydown="if(event.key === 'Enter') sendMessage()"
            />
            <button id="send-button" onclick="sendMessage()"
                    class="p-3 bg-indigo-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-indigo-700 transition duration-150 disabled:bg-gray-400">
                <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
                <div id="loading-indicator" class="hidden loading-spinner w-6 h-6 border-4 border-t-transparent rounded-full"></div>
            </button>
        </div>
    </div>
    
    <!-- å¼•å…¥å¤–éƒ¨æ–‡ç« æ•°æ®æ–‡ä»¶ - å¿…é¡»åœ¨ä¸»é€»è¾‘è„šæœ¬ä¹‹å‰åŠ è½½ -->
    <script src="./articles.js"></script>

    <script>
        // ç¡®ä¿ mockArticles å·²ç»è¢« articles.js å¼•å…¥
        if (typeof mockArticles === 'undefined' || !Array.isArray(mockArticles)) {
            console.error("Error: mockArticles array not found. Please ensure articles.js is loaded correctly and is in the root directory.");
        }

        // --- 1. State Variables ---
        // ğŸš¨ å…³é”®æ­¥éª¤ï¼šè¯·å°†æ‚¨çš„ API Key ç²˜è´´åˆ° YOUR_API_KEY_HERE çš„ä½ç½®ï¼
        const apiKey = "AIzaSyDEVjh8JYyLAhM58XvONoyI_Dwvs8hS7Vo"; 
        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        let chatHistory = []; // Stores the history of the conversation
        let isRecommendationMade = false;
        
        // --- 2. DOM Elements ---
        const chatHistoryDiv = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const sendIcon = document.getElementById('send-icon');
        const recommendationCard = document.getElementById('recommendation-card');
        const recommendedIdSpan = document.getElementById('recommended-id');
        const recommendedTitleSpan = document.getElementById('recommended-title');
        const recommendationReasoningP = document.getElementById('recommendation-reasoning');

        // --- 3. UI Helper Functions ---
        
        window.onload = resetChat;

        function setLoading(isLoading) {
            sendButton.disabled = isLoading || isRecommendationMade;
            userInput.disabled = isLoading || isRecommendationMade;
            if (isLoading) {
                sendIcon.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
            } else {
                sendIcon.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            }
        }

        function displayMessage(role, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 rounded-lg max-w-[80%] shadow-md ${
                role === 'user' ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-gray-800'
            }`;

            if (role === 'assistant') {
                const assistantName = document.createElement('p');
                assistantName.className = 'font-semibold text-indigo-700 mb-1';
                assistantName.textContent = "åŠ©ç†å°æ™º";
                messageBubble.appendChild(assistantName);
            }
            
            const messageText = document.createElement('p');
            messageText.innerHTML = text.replace(/\n/g, '<br>');
            messageBubble.appendChild(messageText);
            
            messageWrapper.appendChild(messageBubble);
            chatHistoryDiv.appendChild(messageWrapper);
            
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        function displayRecommendation(recommendation) {
            const article = mockArticles.find(a => a.id === recommendation.recommended_id);
            if (article) {
                recommendedIdSpan.textContent = article.id;
                recommendedTitleSpan.textContent = article.title;
                recommendationReasoningP.textContent = `åŒ¹é…ä¾æ®: ${recommendation.reasoning}`;
                recommendationCard.classList.remove('hidden');
                isRecommendationMade = true;
                setLoading(false); // Re-set loading state to apply disabled styles
            } else {
                displayMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„æ–‡ç« IDï¼Œä½†å®ƒä¸åœ¨æˆ‘çš„æ–‡ç« åº“ä¸­ã€‚');
                isRecommendationMade = true; // Still end the conversation flow
                setLoading(false);
            }
        }

        // --- Chat Reset Function ---
        function resetChat() {
            chatHistory = [];
            isRecommendationMade = false;
            chatHistoryDiv.innerHTML = '';
            recommendationCard.classList.add('hidden');
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.value = '';
            
            // Add initial welcome message
            displayMessage('assistant', 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨å…¬ä¼—å·çš„æ™ºèƒ½åŠ©ç†ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å‘¢ï¼Ÿæ¯”å¦‚æ‚¨æƒ³äº†è§£â€œå¦‚ä½•åˆ¶ä½œå’–å•¡â€ï¼Œæˆ–è€…â€œæœ€æ–°çš„è¡Œä¸šè¶‹åŠ¿â€ï¼Ÿ');
        }

        // --- 4. Main Chat Logic ---
        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText || isRecommendationMade) return;

            // 1. Add user message to history and UI
            chatHistory.push({ role: 'user', parts: [{ text: userText }] });
            displayMessage('user', userText);
            userInput.value = '';
            setLoading(true);

            try {
                // Prepare context for the model
                const articlesList = mockArticles
                    .map(a => `ID: ${a.id}, Title: ${a.title}, Summary: ${a.summary}`)
                    .join('\n---\n');

                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€äº²åˆ‡ã€çŸ¥è¯†æ¸Šåšçš„å…¬ä¼—å·åŠ©ç†â€œåŠ©ç†å°æ™ºâ€ã€‚ä½ çš„é¦–è¦ç›®æ ‡æ˜¯ä¸ç”¨æˆ·è¿›è¡Œè‡ªç„¶ã€æœ‰æ¸©åº¦çš„å¯¹è¯ï¼Œå¢åŠ äº²è¿‘æ„Ÿã€‚

è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š
1. **å›å¤é£æ ¼ï¼š** ä½¿ç”¨å£è¯­åŒ–ã€äº²åˆ‡çš„ä¸­æ–‡è¿›è¡Œå›å¤ï¼ˆåƒæœ‹å‹èŠå¤©ä¸€æ ·ï¼‰ã€‚
2. **å¯¹è¯æ¨¡å¼ï¼ˆaction: "continue_chat"ï¼‰ï¼š** å¦‚æœç”¨æˆ·åªæ˜¯åœ¨èŠå¤©ã€æé—®æˆ–æ¾„æ¸…æ„å›¾ï¼Œè¯·ç”Ÿæˆä¸€ä¸ªå‹å¥½çš„å›å¤ï¼Œå¹¶å°† action è®¾ç½®ä¸º "continue_chat"ã€‚
3. **æ¨èæ¨¡å¼ï¼ˆaction: "recommend_article"ï¼‰ï¼š** åªæœ‰å½“ä½ æ ¹æ®å½“å‰å¯¹è¯å’Œå†å²è®°å½•ï¼Œ**ç¡®å®š**ç”¨æˆ·éœ€è¦ä¸€ç¯‡å…·ä½“çš„æ–‡ç« æ¥è§£å†³é—®é¢˜æ—¶ï¼Œæ‰å°† action è®¾ç½®ä¸º "recommend_article"ã€‚æ­¤æ—¶ï¼Œä½ å¿…é¡»ä»æä¾›çš„æ–‡ç« åˆ—è¡¨ä¸­é€‰æ‹©æœ€åŒ¹é…çš„æ–‡ç« IDï¼Œå¹¶ç»™å‡ºæ¨èç†ç”±ã€‚
4. **æ–‡ç« åˆ—è¡¨ (ID, æ ‡é¢˜, æ‘˜è¦):**
---
${articlesList}
---
5. **JSONè¾“å‡ºï¼š** ä½ çš„è¾“å‡ºå¿…é¡»æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹æ‰€æœ‰å­—æ®µã€‚

è¯·æ ¹æ®æœ€æ–°çš„èŠå¤©è®°å½•å’Œå†å²ï¼Œå†³å®šæ˜¯ç»§ç»­èŠå¤©è¿˜æ˜¯æ¨èæ–‡ç« ã€‚`;

                // JSON Schema for structured output
                const responseSchema = {
                    type: "OBJECT",
                    properties: {
                        "response_text": { "type": "STRING", "description": "å¯¹ç”¨æˆ·æ¶ˆæ¯çš„ä¸­æ–‡å›å¤ï¼ˆäº²åˆ‡çš„èŠå¤©å†…å®¹ï¼‰ã€‚" },
                        "action": { "type": "STRING", "description": "å†³å®šä¸‹ä¸€æ­¥æ“ä½œï¼Œå¿…é¡»æ˜¯ 'continue_chat' æˆ– 'recommend_article'ã€‚" },
                        "recommended_id": { "type": "STRING", "description": "å¦‚æœ action æ˜¯ recommend_articleï¼Œåˆ™ä¸ºæœ€åŒ¹é…æ–‡ç« çš„IDï¼Œä¾‹å¦‚ 'A006'ã€‚" },
                        "reasoning": { "type": "STRING", "description": "å¦‚æœ action æ˜¯ recommend_articleï¼Œåˆ™ä¸ºæ¨èè¯¥æ–‡ç« çš„ç®€çŸ­ç†ç”± (ä¸­æ–‡)ã€‚" }
                    },
                    required: ["response_text", "action"],
                    propertyOrdering: ["response_text", "action", "recommended_id", "reasoning"]
                };

                const payload = {
                    contents: chatHistory, 
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    }
                };
                
                let response = null;
                const maxRetries = 3;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                    } catch (e) {
                        if (i === maxRetries - 1) throw new Error("APIè¿æ¥å¤±è´¥");
                    }
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }

                if (!response || !response.ok) {
                    let errorDetail = response ? `çŠ¶æ€ç : ${response.status}` : 'ç½‘ç»œé”™è¯¯';
                    
                    // å°è¯•è§£æ API é”™è¯¯è¯¦æƒ…
                    try {
                        const errorBody = await response.json();
                        if (errorBody && errorBody.error && errorBody.error.message) {
                            errorDetail = `APIé”™è¯¯: ${errorBody.error.message}`;
                        }
                    } catch (e) {
                        // æ— æ³•è§£æ JSON é”™è¯¯ä½“ï¼Œä½¿ç”¨åŸå§‹çŠ¶æ€ç 
                    }
                    throw new Error(errorDetail);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("APIè¿”å›å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚");
                }

                const parsedJson = JSON.parse(jsonText);
                
                // 2. Process Assistant's Response
                const assistantResponseText = parsedJson.response_text || "æˆ‘è¿˜åœ¨å­¦ä¹ ä¸­ï¼Œè¯·æ‚¨ç¨ç­‰ä¸€ä¸‹å“¦ã€‚";
                
                // Add assistant response to history and UI
                chatHistory.push({ role: 'assistant', parts: [{ text: assistantResponseText }] });
                displayMessage('assistant', assistantResponseText);

                // 3. Check for recommendation action
                if (parsedJson.action === "recommend_article") {
                    displayRecommendation(parsedJson);
                }

            } catch (error) {
                console.error("å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯:", error);
                // Display the specific error message on the UI
                displayMessage('assistant', `æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶å‡ºäº†ç‚¹å°é—®é¢˜ã€‚è¯¦ç»†é”™è¯¯: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
    </script>
</body>
</html>