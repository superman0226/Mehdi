<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 更新标题 -->
    <title>小强的精彩世界欢迎你</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // 蓝色
                        accent: '#10b981',  // 绿色
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* 引入Inter字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        /* 自定义滚动条样式 */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* 聊天气泡样式 */
        .user-message {
            background-color: #dbeafe; /* 浅蓝色 */
        }
        .model-message {
            background-color: #f3f4f6; /* 浅灰色 */
        }
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <div class="max-w-xl mx-auto p-4 md:p-6 flex flex-col h-screen">
        
        <!-- Header & Title -->
        <header class="mb-4 bg-white p-4 rounded-xl shadow-lg border-t-4 border-primary">
            <!-- 更新 h1 标题 -->
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 text-center">小强的精彩世界欢迎你</h1>
        </header>

        <!-- Link Mode Toggle and Controls -->
        <div class="flex justify-between items-center mb-4 p-3 bg-white rounded-xl shadow">
            <div id="linkModeDisplay" class="text-sm font-semibold text-gray-600">
                链接模式：中文 (默认)
            </div>
            <div class="flex space-x-2">
                <button id="toggleLinkMode" class="px-3 py-1 text-sm rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150 shadow-md">
                    切换到英文翻译
                </button>
                <button id="resetButton" class="px-3 py-1 text-sm rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">
                    重置对话
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chatContainer" class="flex-grow overflow-y-auto bg-white p-4 rounded-xl shadow-lg chat-container mb-4">
            <!-- 聊天消息将在这里插入 -->
        </div>

        <!-- Input Area -->
        <div class="bg-white p-4 rounded-xl shadow-lg flex items-center">
            <input type="text" id="userInput" placeholder="输入读者的问题，与小强互动..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition duration-150 mr-3">
            <button id="sendButton" class="p-3 bg-accent text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.547 60.547 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.547 60.547 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- 应用程序逻辑 -->
    
    <!-- 外部库：用于 Markdown 格式化 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.12/marked.min.js"></script>

    <!-- 引入文章数据 (FIXED: 修复了缺失的 script 标签) -->
    <script src="articles.js"></script>

    <script>
        // --- 1. State Variables ---
        // ⚠️ 请在这里替换为您真实的 API Key
        const apiKey = "AIzaSyDEVjh8JYyLAhM58XvONoyI_Dwvs8hS7Vo"; 
        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        // 聊天历史，用于API请求
        let chatHistory = []; 
        
        // 链接模式：'zh' (中文原始链接) 或 'en' (英文翻译链接)
        let linkMode = localStorage.getItem('linkMode') || 'zh';

        // --- 2. DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const toggleLinkModeButton = document.getElementById('toggleLinkMode');
        const linkModeDisplay = document.getElementById('linkModeDisplay');


        // --- 3. Core Functions ---

        /**
         * 初始化或重置应用状态
         */
        function initializeApp() {
            // 检查 mockArticles 是否可用 (现在使用 var 声明，应该可以在这里访问)
            if (typeof mockArticles === 'undefined') {
                 showInitError();
                 return;
            }

            // 清空UI和历史记录
            chatContainer.innerHTML = '';
            chatHistory = [];
            
            // 首次启动时，显示助理的欢迎语
            const initialMessage = "你好呀！我是你的公众号小助理**小小强**。有什么关于保险、菲律宾生活或者其他想聊的，尽管问我！";
            displayMessage(initialMessage, 'model');
            
            // 更新链接模式UI
            updateLinkModeUI();

            // 恢复按钮状态
            sendButton.disabled = false;
        }

        /**
         * 显示初始化错误的函数（如果数据未加载）
         */
        function showInitError() {
            chatContainer.innerHTML = `
                <div class="text-center text-red-500 p-4 bg-red-50 rounded-lg">
                    <p class="font-bold mb-2">系统初始化失败！</p>
                    <p class="text-sm">错误：未找到 <strong>articles.js</strong> 文件中的 mockArticles 数据。</p>
                    <p class="text-xs mt-1">请确保 'articles.js' 文件与 'index.html' 在同一目录，且 'mockArticles' 变量使用 'var' 声明。</p>
                </div>
            `;
            sendButton.disabled = true;
        }


        /**
         * 根据当前模式返回文章链接
         * @param {string} originalUrl - 文章的原始中文URL
         * @returns {string} - 处理后的链接
         */
        function getProcessedUrl(originalUrl) {
            if (linkMode === 'en') {
                // 英文翻译模式：使用 Google Translate 封装 URL
                const encodedUrl = encodeURIComponent(originalUrl);
                // sl=zh-CN (源语言：中文简体), tl=en (目标语言：英文)
                return `https://translate.google.com/translate?sl=zh-CN&tl=en&u=${encodedUrl}`;
            }
            // 中文模式：返回原始链接
            return originalUrl;
        }

        /**
         * 更新链接模式的显示和按钮文本
         */
        function updateLinkModeUI() {
            if (linkMode === 'zh') {
                linkModeDisplay.textContent = '链接模式：中文 (默认)';
                toggleLinkModeButton.textContent = '切换到英文翻译';
                toggleLinkModeButton.classList.remove('bg-green-600');
                toggleLinkModeButton.classList.add('bg-primary');
            } else {
                linkModeDisplay.textContent = '链接模式：英文翻译';
                toggleLinkModeButton.textContent = '切换到中文 (默认)';
                toggleLinkModeButton.classList.remove('bg-primary');
                toggleLinkModeButton.classList.add('bg-green-600');
            }
            localStorage.setItem('linkMode', linkMode);
        }

        /**
         * 切换链接模式
         */
        function toggleLinkMode() {
            linkMode = linkMode === 'zh' ? 'en' : 'zh';
            updateLinkModeUI();
            // 在切换模式后，清除旧的推荐卡片，防止误解
            const recCards = document.querySelectorAll('.recommendation-card');
            recCards.forEach(card => card.remove());
        }

        /**
         * 在聊天界面显示消息
         * @param {string} text - 消息文本
         * @param {'user'|'model'} role - 消息发送者角色
         */
        function displayMessage(text, role, recommendation = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-4 p-3 rounded-lg max-w-[85%] shadow-md ${role === 'user' ? 'user-message ml-auto' : 'model-message mr-auto'}`;
            
            // 使用 Markdown 解析器进行基本格式化
            const formattedText = marked.parse(text);
            messageDiv.innerHTML = formattedText;
            
            // 如果有推荐，添加推荐卡片
            if (recommendation) {
                const recDiv = document.createElement('div');
                recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                
                // 获取处理后的链接
                const processedUrl = getProcessedUrl(recommendation.url);
                const linkText = linkMode === 'en' ? '（英文翻译）' : '（中文）';

                recDiv.innerHTML = `
                    <p class="font-bold text-gray-700 mb-1">🎯 小强推荐文章 ${linkText}:</p>
                    <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                        ${recommendation.title}
                    </a>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendation.id}</span>
                        <button onclick="copyArticleLink('${processedUrl}', '${recommendation.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                            复制链接
                        </button>
                    </div>
                `;
                messageDiv.appendChild(recDiv);
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * 复制文章链接到剪贴板 (使用 document.execCommand 兼容性更高)
         */
        function copyArticleLink(url, id) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(textarea);

            const statusText = success ? `已复制文章 ${id} 的链接！` : '复制失败，请手动复制。';
            // 使用自定义模态框代替 alert
            showStatusModal(statusText); 
        }

        /**
         * 显示状态消息的自定义模态框
         * @param {string} message 
         */
        function showStatusModal(message) {
            const modalId = 'statusModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
                        <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
                        <button onclick="document.getElementById('${modalId}').classList.remove('opacity-100', 'pointer-events-auto'); document.getElementById('${modalId}').classList.add('opacity-0', 'pointer-events-none');" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150">
                            确定
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('modalMessage').textContent = message;
            // 确保先应用 scale-95 和 opacity-0，然后延迟应用 transform 和 opacity-100
            setTimeout(() => {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }, 10);
        }


        /**
         * 主逻辑：发送消息并获取回复
         */
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UI更新
            userInput.value = '';
            sendButton.disabled = true;
            displayMessage(text, 'user');

            // 2. 构造历史记录和新消息
            chatHistory.push({ role: "user", parts: [{ text: text }] });
            
            // 3. 构造系统指令 (System Prompt) - 注入人设和文章库
            // 使用 try/catch 确保即使 mockArticles 未定义，程序也不会完全崩溃
            let articleList = '';
            if (typeof mockArticles !== 'undefined') {
                articleList = mockArticles.map(a => 
                    `ID: ${a.id}, 标题: ${a.title}, 侧重点/摘要: ${a.summary}`
                ).join('\n');
            } else {
                 articleList = '文章列表不可用，请勿推荐。';
            }


            const systemPrompt = `
                你是一个幽默、亲切、爱互动的公众号助理，名字叫“小小强”。你的主要任务是：
                1. **扮演作者分身：** 你是作者本人（一位保险专家），过去在北京生活，但从2023年开始，因为陪孩子读书，现定居在菲律宾。你必须主动、自然地将“北京生活”、“菲律宾陪读经历”、“跨国生活感受”等真实故事融入聊天中。
                2. **进行亲切互动：** 对话开始时或话题轻松时，可以适当讲个小笑话或进行幽默问候。
                3. **精准文章推荐：** 当读者的话题与保险、菲律宾生活、旅游或留学相关时，你必须从下面的“文章列表”中选择一篇最精准的文章进行推荐。
                4. **推荐格式：** 必须在回复的最后一行以严格的格式输出推荐ID，格式为：[RECOMMEND_ID: Axxx]，其中 Axxx 是文章ID。如果没有合适的文章，则回复[RECOMMEND_ID: NONE]。
                5. **精准区分：** 对于相似主题的文章（如保险），你必须根据读者是问“需求评估”还是问“代理人选择”来区分推荐文章。

                --- 文章列表（用于推荐，请勿直接发送给用户）---
                ${articleList}
            `;

            const payload = {
                contents: chatHistory,
                // 注意：使用 systemInstruction 传递人设和文章库，以获得更稳定的结果
                config: {
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                }
            };

            let responseText = "抱歉，系统暂时出了点小问题。";
            let recommendedArticle = null;

            try {
                // 4. API Call with Exponential Backoff
                const maxRetries = 3;
                let response = null;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) break; // If not rate limit, break retry loop
                        
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        console.log(`API 429 encountered, retrying in ${delay / 1000}s...`);

                    } catch (fetchError) {
                        responseText = `API请求失败 (Fetch Error): ${fetchError.message}`;
                        throw fetchError;
                    }
                }

                // Handle HTTP errors
                if (!response.ok) {
                    const errorJson = await response.json();
                    const errorMessage = errorJson.error?.message || response.statusText;
                    responseText = `API请求失败，状态码 ${response.status}。详细错误: ${errorMessage}`;
                    
                    // 特殊处理 403 错误，提醒用户检查 Key
                    if (response.status === 403) {
                         responseText += "\n\n⚠️ 403错误：请检查您的 API Key 是否正确粘贴或是否已启用权限。";
                    }
                } else {
                    const result = await response.json();
                    const modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || responseText;
                    
                    // 5. 提取推荐ID
                    const match = modelResponse.match(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i);
                    const recId = match ? match[1] : 'NONE';

                    // 6. 清理回复文本
                    responseText = modelResponse.replace(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i, '').trim();

                    // 7. 查找推荐文章
                    if (recId !== 'NONE') {
                        recommendedArticle = mockArticles.find(a => a.id === recId);
                        if (!recommendedArticle) {
                            responseText += `\n\n(系统提示: 小强推荐了不存在的文章ID: ${recId})`;
                        }
                    }

                    // 8. 记录历史 (使用正确的 role: 'model')
                    chatHistory.push({ role: "model", parts: [{ text: modelResponse }] });
                }

            } catch (error) {
                console.error("Critical error in sendMessage:", error);
                responseText = `Api错误，请查看控制台。${error.message}`;
            }
            
            // 9. 最终显示回复
            displayMessage(responseText, 'model', recommendedArticle);
            sendButton.disabled = false;
        }

        // --- 4. Event Listeners ---

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });

        // 切换链接模式
        toggleLinkModeButton.addEventListener('click', toggleLinkMode);
        
        resetButton.addEventListener('click', () => {
            // 使用自定义模态框代替 confirm()
            showConfirmModal("确定要重置对话吗？重置后小强将忘记所有之前的聊天内容。", initializeApp);
        });

        /**
         * 显示确认对话框的自定义模态框
         * @param {string} message 
         * @param {Function} onConfirmCallback 
         */
        function showConfirmModal(message, onConfirmCallback) {
            const modalId = 'confirmModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl w-80 transform scale-95 transition-transform duration-300">
                        <p id="confirmModalMessage" class="text-lg font-semibold text-gray-800 mb-6"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirmCancelBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                                取消
                            </button>
                            <button id="confirmOkBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">
                                确定重置
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('confirmModalMessage').textContent = message;

            const closeModal = () => {
                modal.classList.remove('opacity-100', 'pointer-events-auto');
                modal.classList.add('opacity-0', 'pointer-events-none');
            };

            // 移除旧监听器，防止重复执行
            const okBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');

            const newOkListener = () => {
                closeModal();
                onConfirmCallback();
                okBtn.removeEventListener('click', newOkListener);
                cancelBtn.removeEventListener('click', newCancelListener);
            };

            const newCancelListener = () => {
                closeModal();
                cancelBtn.removeEventListener('click', newCancelListener);
                okBtn.removeEventListener('click', newOkListener);
            };

            okBtn.addEventListener('click', newOkListener);
            cancelBtn.addEventListener('click', newCancelListener);


            setTimeout(() => {
                modal.classList.add('opacity-100', 'pointer-events-auto');
            }, 10);
        }

        // --- 5. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // 确保在 DOM 加载完成后，并且 mockArticles（从 articles.js）被加载后再运行
            if (typeof mockArticles !== 'undefined') {
                initializeApp();
            } else {
                showInitError();
            }
        });
    </script>
    
</body>
</html>