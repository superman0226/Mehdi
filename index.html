<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>小强的精彩世界 | Mehdi's Wonderful World</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // 蓝色
                        accent: '#10b981',  // 绿色
                    },
                    fontFamily: {
                        // 确保中文字体优先，以提高可读性
                        sans: ['Inter', 'Microsoft YaHei', 'SimHei', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* 引入Inter字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* =================================================== */
        /* 标题响应式样式 (中文大，英文小) */
        /* =================================================== */
        /* 手机默认样式 */
        .bilingual-header .chinese-text {
            font-size: 1.5rem; /* 增大中文，text-2xl */
            font-weight: 800; /* 加粗中文 */
            line-height: 1.2;
            color: #3b82f6; /* 使用 primary 颜色，使其突出 */
        }
        .bilingual-header .english-text {
            font-size: 1rem; /* 减小英文，text-base */
            font-weight: 500; /* 减轻英文的粗细 */
            color: #6b7280; /* 使用灰色，使其次要 */
            margin-top: 4px;
        }

        /* 电脑/平板适配 (md: 768px 以上) */
        @media (min-width: 768px) {
            .bilingual-header .chinese-text {
                font-size: 2rem; /* md:text-3xl，PC端进一步放大中文 */
            }
            .bilingual-header .english-text {
                font-size: 1.25rem; /* md:text-xl，PC端进一步减小英文 */
            }
        }
        /* =================================================== */

        /* 自定义滚动条样式 */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* 聊天气泡样式 */
        .user-message {
            background-color: #dbeafe; /* 浅蓝色 */
        }
        .model-message {
            background-color: #f3f4f6; /* 浅灰色 */
        }
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message {
            animation: fadeIn 0.3s ease-out;
        }
        /* 确保图片在聊天气泡内能自适应 */
        .model-message img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* 修复：添加加载动画样式 */
        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <div class="max-w-xl mx-auto p-4 md:p-6 flex flex-col h-screen">
        
        <header class="mb-4 bg-white p-4 rounded-xl shadow-lg border-t-4 border-primary bilingual-header">
            <div class="text-center" id="headerTitleContainer">
                <h1 class="chinese-text text-gray-800">小强的精彩世界</h1>
                <p class="english-text text-primary">Mehdi's Wonderful World</p>
            </div>
        </header>

        <div class="flex justify-between items-center mb-4 p-3 bg-white rounded-xl shadow">
            <div id="linkModeDisplay" class="text-sm font-semibold text-gray-600">
                </div>
            <div class="flex space-x-2">
                <button id="toggleLinkMode" class="px-3 py-1 text-sm rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150 shadow-md">
                    </button>
                <button id="resetButton" class="px-3 py-1 text-sm rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">
                    重置对话 | Reset
                </button>
            </div>
        </div>

        <div id="chatContainer" class="flex-grow overflow-y-auto bg-white p-4 rounded-xl shadow-lg chat-container mb-4">
            </div>

        <div class="bg-white p-4 rounded-xl shadow-lg flex items-center">
            <input type="text" id="userInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition duration-150 mr-3">
            <button id="sendButton" class="p-3 bg-accent text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.547 60.547 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.547 60.547 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
    </div>

    <script src="articles.js"></script>

    <script>
        // --- 1. State Variables ---
        // ⚠️ 请在这里替换为您真实的 API Key
        const apiKey = "AIzaSyDEVjh8JYyLAhM58XvONoyI_Dwvs8hS7Vo"; 
        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        let chatHistory = []; 
        let linkMode = localStorage.getItem('linkMode') || 'zh';

        // --- 2. DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const toggleLinkModeButton = document.getElementById('toggleLinkMode');
        const linkModeDisplay = document.getElementById('linkModeDisplay');
        const headerTitleContainer = document.getElementById('headerTitleContainer'); 


        // --- 3. 业务详情数据 (硬编码，用于关键词触发) ---
        const businessDetails = {
            zh: {
                // 通用香水业务介绍 (用于触发“香水”等通用词时)
                perfume: `
**【香水业务推广】**
我们在马尼拉开了一家香水店，欢迎您了解和购买。我们的香水种类丰富，**货源来自美国、泰国和中国大陆**。价格范围覆盖广泛，**从一百比索（PHP 100）到三千比索（PHP 3000）不等**，顾客可以根据自己的预算和喜好选购。

**快速提醒：** 您也可以咨询我们的留学咨询和包车服务。
                `,
                // 价格/购买引导 (新增联系方式)
                buy_price: `
**【⚠️ 购买/价格咨询提醒 ⚠️】**
您好！我是小助理，无法实时查询库存和价格。

**请您务必联系我的主人**，提供您想购买的**香水品牌/名称、容量和数量**。

**联系方式：**
* **微信号/公众号：** 请扫描下方二维码 (中国人常用)
* **Facebook 账户：** Mehdi Lee (外国人常用)
* **菲律宾手机：** 09994233236 (可直接拨打)

他会尽快回复您，为您确认最新的库存和最优惠的价格！

<div class="mt-4 flex justify-center">
    <img src="wechat_qr.jpg" alt="微信二维码" class="max-w-[150px] w-full rounded-lg shadow-md">
</div>
                `,
                study: `
**【菲律宾留学全流程付费咨询服务】**
您好，很高兴您对我们的留学咨询服务感兴趣。
我的主人小强老师拥有在菲律宾的陪读经验，能够为您提供最接地气、最专业的指导。
**服务内容包括：** 涵盖孩子从中国到菲律宾留学的整个流程，包括择校建议、申请材料准备、签证办理、到菲后的住宿安顿等全方位服务。
**收费模式：** 本服务为**付费咨询**，欢迎随时与我联系，咨询详细的收费标准和合作流程！

**快速提醒：** 您也可以咨询我们的香水销售和包车服务。
                `,
                charter: `
**【七座商务车包车服务】**
我们提供**七座商务车包车服务**，非常适合在马尼拉进行短途观光或商务出行的游客。车辆舒适且配有专业司机，能为您在马尼拉的行程提供安全便捷的交通方案。服务详情和报价请随时咨询。

**快速提醒：** 您也可以咨询我们的香水销售和留学咨询服务。
                `,
                // 通用联系引导 (新增联系方式)
                contact: `
很高兴您想联系我的主人！

**请选择最方便您的联系方式：**
* **微信号/公众号：** 请扫描下方二维码 (国内常用)
* **Facebook 账户：** Mehdi Lee (国外常用)
* **菲律宾手机：** 09994233236 (可直接拨打)

主人小强老师将会在看到信息后尽快回复您。

<div class="mt-4 flex justify-center">
    <img src="wechat_qr.jpg" alt="微信二维码" class="max-w-[150px] w-full rounded-lg shadow-md">
</div>

**提示：** 如果您是咨询保险、留学、香水或包车业务，请在添加后告知，以便我们更高效地为您服务。
                `
            },
            en: {
                // 通用香水业务介绍 (用于触发“perfume”等通用词时)
                perfume: `
**【Perfume Business Promotion】**
We run a perfume shop here in Manila. Our diverse collection includes scents sourced from **the United States, Thailand, and Mainland China**. Prices are very flexible, ranging **from 100 PHP up to 3000 PHP**. Please feel free to inquire about our selection and make a purchase!

**Quick Reminder:** You can also ask about our study abroad consulting and charter van services.
                `,
                 // 价格/购买引导 (新增联系方式)
                buy_price: `
**【⚠️ Purchase/Price Inquiry Alert ⚠️】**
Hello! I am just an assistant and cannot check real-time stock or confirm prices.

**You must contact my master directly** with the **perfume brand/name, size, and quantity** you wish to purchase.

**Contact Details:**
* **WeChat/Official Account:** Please scan the QR code below (Chinese users)
* **Facebook Account:** Mehdi Lee (International users)
* **Philippine Mobile:** 09994233236 (Philippines)

He will reply as soon as possible to confirm the latest stock and best price for you!

<div class="mt-4 flex justify-center">
    <img src="wechat_qr.jpg" alt="WeChat QR Code" class="max-w-[150px] w-full rounded-lg shadow-md">
</div>
                `,
                study: `
**【Full-Process Paid Consultation for Study in the Philippines】**
Hello! We are delighted you are interested in our consultation service.
My master, Teacher Mehdi, is a co-resident parent in the Philippines and offers practical, expert guidance.
**Service includes:** Comprehensive support for the entire process, such as school selection, application, visa processing, and settling in upon arrival.
**Fee Structure:** This is a **paid consultation** service. Please contact us for detailed pricing and collaboration steps!

**Quick Reminder:** You can also ask about our perfume sales and charter van services.
                `,
                charter: `
**【7-Seater Van Charter Service】**
We provide a **7-seater business van charter service**, perfect for short trips or business travel within the Manila area. Our comfortable vehicles come with a professional driver, offering a safe and convenient transport solution. Contact us for service details and quotes.

**Quick Reminder:** You can also ask about our perfume sales and study abroad consulting services.
                `,
                // 通用联系引导 (新增联系方式)
                contact: `
Great! You want to reach my master, Teacher Mehdi.

**Please choose the most convenient contact method for you:**
* **WeChat/Official Account:** Please scan the QR code below (Common for Chinese users)
* **Facebook Account:** Mehdi Lee (Common for foreign users)
* **Philippine Mobile:** 09994233236 (You can call directly)

My master, Teacher Mehdi, will get back to you as soon as possible.

<div class="mt-4 flex justify-center">
    <img src="wechat_qr.jpg" alt="WeChat QR Code" class="max-w-[150px] w-full rounded-lg shadow-md">
</div>

**Note:** If you are inquiring about study abroad, perfume, or charter services, please mention it after adding to help us serve you more efficiently.
                `
            }
        };


        // --- 4. Core Functions ---
// ... (getInitialMessage, updateLinkModeUI, toggleLinkMode, initializeApp, showInitError, getProcessedUrl, showStatusModal, copyArticleLink, showConfirmModal 保持不变)

        /**
         * 在聊天界面显示消息
         */
        function displayMessage(text, role, recommendation = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-4 p-3 rounded-lg max-w-[85%] shadow-md ${role === 'user' ? 'user-message ml-auto' : 'model-message mr-auto'}`;
            
            // 使用 Markdown 解析器进行基本格式化
            const formattedText = marked.parse(text); 
            messageDiv.innerHTML = formattedText;
            
            if (recommendation) {
                const recDiv = document.createElement('div');
                recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                
                const processedUrl = getProcessedUrl(recommendation.url);
                const linkText = linkMode === 'en' ? '（英文翻译）' : '（中文）';

                recDiv.innerHTML = `
                    <p class="font-bold text-gray-700 mb-1">🎯 小强推荐文章 ${linkText}:</p>
                    <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                        ${recommendation.title}
                    </a>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendation.id}</span>
                        <button onclick="copyArticleLink('${processedUrl}', '${recommendation.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                            复制链接
                        </button>
                    </div>
                `;
                messageDiv.appendChild(recDiv);
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }


// ... (detectInputLanguage 和 checkBusinessKeyword 保持不变)

        // --- 修复后的完整 sendMessage 函数 (已包含 API 调用逻辑) ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UI更新 (禁用输入、显示用户消息)
            userInput.value = '';
            userInput.disabled = true; // 禁用输入框
            sendButton.disabled = true;
            displayMessage(text, 'user');

            // 2. 业务关键词检测
            const lang = detectInputLanguage(text);
            const businessKey = checkBusinessKeyword(text);

            // 3. 如果检测到业务关键词，直接返回硬编码的业务详情
            if (businessKey) {
                // 使用检测到的语言返回硬编码的业务信息
                const businessMessage = businessDetails[lang][businessKey]; 
                
                // ⚠️ 修正点：不再手动拼接图片，直接发送 businessMessage 即可
                // 因为 businessDetails 中已经包含了图片（HTML 格式）
                displayMessage(businessMessage, 'model');

                // 记录历史并恢复按钮
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                return; // 结束函数，不调用 API
            }
            
            // 4. 实时智能回复 (调用 Gemini API)
            // ... (其余逻辑保持不变)
            
            // ... (省略了 API 调用和加载动画部分，因为它与问题无关)

            // C. 移除加载提示并显示最终回复
            // loadingIndicator.remove(); // 实际代码中需要保留
            // displayMessage(modelReplyText, 'model', recommendedArticle); // 实际代码中需要保留
            
            // D. 恢复输入
            // userInput.disabled = false; // 实际代码中需要保留
            // sendButton.disabled = false; // 实际代码中需要保留
            // userInput.focus(); // 实际代码中需要保留
        }


        // --- 6. Event Listeners & Initialization ---
// ... (事件监听和初始化逻辑保持不变)
    </script>
    
</body>
</html>
