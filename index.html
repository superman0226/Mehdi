<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>小强的精彩世界 | Mehdi's Wonderful World</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // 蓝色
                        accent: '#10b981',  // 绿色
                    },
                    fontFamily: {
                        // 确保中文字体优先，以提高可读性
                        sans: ['Inter', 'Microsoft YaHei', 'SimHei', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* 引入Inter字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* =================================================== */
        /* 标题响应式样式 (中文大，英文小) */
        /* =================================================== */
        /* 手机默认样式 */
        .bilingual-header .chinese-text {
            font-size: 1.5rem; /* 增大中文，text-2xl */
            font-weight: 800; /* 加粗中文 */
            line-height: 1.2;
            color: #3b82f6; /* 使用 primary 颜色，使其突出 */
        }
        .bilingual-header .english-text {
            font-size: 1rem; /* 减小英文，text-base */
            font-weight: 500; /* 减轻英文的粗细 */
            color: #6b7280; /* 使用灰色，使其次要 */
            margin-top: 4px;
        }

        /* 电脑/平板适配 (md: 768px 以上) */
        @media (min-width: 768px) {
            .bilingual-header .chinese-text {
                font-size: 2rem; /* md:text-3xl，PC端进一步放大中文 */
            }
            .bilingual-header .english-text {
                font-size: 1.25rem; /* md:text-xl，PC端进一步减小英文 */
            }
        }
        /* =================================================== */

        /* 自定义滚动条样式 */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* 聊天气泡样式 */
        .user-message {
            background-color: #dbeafe; /* 浅蓝色 */
        }
        .model-message {
            background-color: #f3f4f6; /* 浅灰色 */
        }
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message {
            animation: fadeIn 0.3s ease-out;
        }
        /* 确保图片在聊天气泡内能自适应 */
        .model-message img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* 修复：添加加载动画样式 */
        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
         /* 修正 Markdown 列表和段落的间距 */
        .model-message ul, .model-message ol {
            margin-left: 1.25rem;
            list-style-type: disc;
        }
        .model-message p {
             margin-top: 0.5rem;
             margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <div class="max-w-xl mx-auto p-4 md:p-6 flex flex-col h-screen">
        
        <header class="mb-4 bg-white p-4 rounded-xl shadow-lg border-t-4 border-primary bilingual-header">
            <div class="text-center" id="headerTitleContainer">
                <h1 class="chinese-text text-gray-800">小强的精彩世界</h1>
                <p class="english-text text-primary">Mehdi's Wonderful World</p>
            </div>
        </header>

        <div class="flex justify-between items-center mb-4 p-3 bg-white rounded-xl shadow">
            <div id="linkModeDisplay" class="text-sm font-semibold text-gray-600">
                </div>
            <div class="flex space-x-2">
                <button id="toggleLinkMode" class="px-3 py-1 text-sm rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150 shadow-md">
                    </button>
                <button id="resetButton" class="px-3 py-1 text-sm rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md">
                    重置对话 | Reset
                </button>
            </div>
        </div>

        <div id="chatContainer" class="flex-grow overflow-y-auto bg-white p-4 rounded-xl shadow-lg chat-container mb-4">
            </div>
        
        <div id="articleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
                <h2 id="modalArticleTitle" class="text-xl font-bold text-primary mb-3"></h2>
                <div id="modalArticleSummary" class="text-gray-700 max-h-60 overflow-y-auto mb-4"></div>
                <div class="flex justify-between items-center">
                    <a id="modalArticleLink" href="#" target="_blank" class="text-sm text-accent hover:underline font-semibold">
                        查看完整文章 &rarr;
                    </a>
                    <button onclick="closeArticleModal()" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">
                        关闭
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-lg flex items-center">
            <input type="text" id="userInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition duration-150 mr-3">
            <button id="sendButton" class="p-3 bg-accent text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.547 60.547 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.547 60.547 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
    </div>

    <script src="articles.js"></script>

    <script>
        // 【优化点：新增功能】 设置历史记录的最大长度 (N 轮对话 = 2 * N 条消息)
        const MAX_HISTORY_MESSAGES = 10; 
        
        // --- 1. State Variables ---
        // ⚠️ 请在这里替换为您真实的 API Key
        const apiKey = "AIzaSyDEVjh8JYyLAhM58XvONoyI_Dwvs8hS7Vo"; 
        const modelName = 'gemini-2.5-flash-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        let chatHistory = []; 
        let linkMode = localStorage.getItem('linkMode') || 'zh';

        // --- 2. DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const toggleLinkModeButton = document.getElementById('toggleLinkMode');
        const linkModeDisplay = document.getElementById('linkModeDisplay');
        const headerTitleContainer = document.getElementById('headerTitleContainer'); 
        // 【优化点：新增功能】 注册 Modal DOM
        const articleModal = document.getElementById('articleModal');
        const modalArticleTitle = document.getElementById('modalArticleTitle');
        const modalArticleSummary = document.getElementById('modalArticleSummary');
        const modalArticleLink = document.getElementById('modalArticleLink');


        // --- 3. 业务详情数据 (硬编码，用于关键词触发) ---
        // (保持不变)
        const businessDetails = {
            zh: {
                // 通用香水业务介绍 (用于触发“香水”等通用词时)
                perfume: `
**【香水业务推广】**
我们在马尼拉开了一家香水店，欢迎您了解和购买。我们的香水种类丰富，**货源来自美国、泰国和中国大陆**。价格范围覆盖广泛，**从一百比索（PHP 100）到三千比索（PHP 3000）不等**，顾客可以根据自己的预算和喜好选购。

**快速提醒：** 您也可以咨询我们的留学咨询和包车服务。
                `,
                // 价格/购买引导 (新增联系方式)
                buy_price: `
**【⚠️ 购买/价格咨询提醒 ⚠️】**
您好！我是小助理，无法实时查询库存和价格。

**请您务必联系我的主人**，提供您想购买的**香水品牌/名称、容量和数量**。

**联系方式：**
* **微信号/公众号：** 请扫描下方二维码 (国内常用)
* **Facebook 账户：** Mehdi Lee (国外常用)
* **菲律宾手机：** 09994233236 (可直接拨打)

他会尽快回复您，为您确认最新的库存和最优惠的价格！
                `,
                study: `
**【菲律宾留学全流程付费咨询服务】**
您好，很高兴您对我们的留学咨询服务感兴趣。
我的主人小强老师拥有在菲律宾的陪读经验，能够为您提供最接地气、最专业的指导。
**服务内容包括：** 涵盖孩子从中国到菲律宾留学的整个流程，包括择校建议、申请材料准备、签证办理、到菲后的住宿安顿等全方位服务。
**收费模式：** 本服务为**付费咨询**，欢迎随时与我联系，咨询详细的收费标准和合作流程！

**快速提醒：** 您也可以咨询我们的香水销售和包车服务。
                `,
                charter: `
**【七座商务车包车服务】**
我们提供**七座商务车包车服务**，非常适合在马尼拉进行短途观光或商务出行的游客。车辆舒适且配有专业司机，能为您在马尼拉的行程提供安全便捷的交通方案。服务详情和报价请随时咨询。

**快速提醒：** 您也可以咨询我们的香水销售和留学咨询服务。
                `,
                // 通用联系引导 (新增联系方式)
                contact: `
很高兴您想联系我的主人！

**请选择最方便您的联系方式：**
* **微信号/公众号：** 请扫描下方二维码 (国内常用)
* **Facebook 账户：** Mehdi Lee (国外常用)
* **菲律宾手机：** 09994233236 (可直接拨打)

主人小强老师将会在看到信息后尽快回复您。

**提示：** 如果您是咨询留学、香水或包车业务，请在添加后告知，以便我们更高效地为您服务。
                `
            },
            en: {
                // 通用香水业务介绍 (用于触发“perfume”等通用词时)
                perfume: `
**【Perfume Business Promotion】**
We run a perfume shop here in Manila. Our diverse collection includes scents sourced from **the United States, Thailand, and Mainland China**. Prices are very flexible, ranging **from 100 PHP up to 3000 PHP**. Please feel free to inquire about our selection and make a purchase!

**Quick Reminder:** You can also ask about our study abroad consulting and charter van services.
                `,
                 // 价格/购买引导 (新增联系方式)
                buy_price: `
**【⚠️ Purchase/Price Inquiry Alert ⚠️】**
Hello! I am just an assistant and cannot check real-time stock or confirm prices.

**You must contact my master directly** with the **perfume brand/name, size, and quantity** you wish to purchase.

**Contact Details:**
* **WeChat/Official Account:** Please scan the QR code below (Chinese users)
* **Facebook Account:** Mehdi Lee (International users)
* **Philippine Mobile:** 09994233236 (Philippines)

He will reply as soon as possible to confirm the latest stock and best price for you!
                `,
                study: `
**【Full-Process Paid Consultation for Study in the Philippines】**
Hello! We are delighted you are interested in our consultation service.
My master, Teacher Mehdi, is a co-resident parent in the Philippines and offers practical, expert guidance.
**Service includes:** Comprehensive support for the entire process, such as school selection, application, visa processing, and settling in upon arrival.
**Fee Structure:** This is a **paid consultation** service. Please contact us for detailed pricing and collaboration steps!

**Quick Reminder:** You can also ask about our perfume sales and charter van services.
                `,
                charter: `
**【7-Seater Van Charter Service】**
We provide a **7-seater business van charter service**, perfect for short trips or business travel within the Manila area. Our comfortable vehicles come with a professional driver, offering a safe and convenient transport solution. Contact us for service details and quotes.

**Quick Reminder:** You can also ask about our perfume sales and study abroad consulting services.
                `,
                // 通用联系引导 (新增联系方式)
                contact: `
Great! You want to reach my master, Teacher Mehdi.

**Please choose the most convenient contact method for you:**
* **WeChat/Official Account:** Please scan the QR code below (Chinese users)
* **Facebook Account:** Mehdi Lee (International users)
* **Philippine Mobile:** 09994233236 (Philippines)

My master, Teacher Mehdi, will get back to you as soon as possible.


**Note:** If you are inquiring about study abroad, perfume, or charter services, please mention it after adding to help us serve you more efficiently.
                `
            }
        };


        // --- 4. Core Functions ---

        /**
         * 获取当前语言的欢迎语 (助理名字根据语言切换)
         */
        function getInitialMessage(lang) {
            if (lang === 'zh') {
                const zhMessage = `你好啊！我是你的公众号小助理**小小强**。我的主人**小强老师**是一位高学历、高知识结构、有广东、北京等多地丰富经历生活、热爱公益，曾被**中央电视台《人物》专栏**报道过的有志人士。他通晓计算机、信息技术、企业管理（10年以上）、人寿保险（12年以上）、心理学（研究血型与性格相关20年），10多年以来撰写了400多篇文章。**2023年以后带娃来菲律宾留学并旅居在此**，对这里的生活、教育、旅游都非常熟悉！

**我用了一年时间摸清了中国孩子在菲律宾读中学和考大学的路（包括华侨生联考），还开了香水店和包车服务。**

如果您有关于**保险、心理、菲律宾旅行、留学、马尼拉包车游、买香水**等任何问题，尽管问我！我很乐意分享小强老师的精彩经历和经验。`;
                return zhMessage;
            } else {
                const enMessage = `Hello! I am your official account assistant, **Mehdi**. My master, **Teacher Mehdi**, is a highly educated, public-spirited individual who has lived in places like Guangdong and Beijing, and was even featured in **China Central Television (CCTV)'s "People" column**. He is proficient in IT, Business Management (10+ years), Life Insurance (12+ years), and Psychology. **Since 2023, he has been residing in the Philippines,** and is now very familiar with the local study, travel, and lifestyle scene!

**I spent a year getting to know the path for Chinese children to study middle school and university here (including the Huqiao Entrance Exam). Plus, we run a perfume shop and a charter van service!**

If you have questions about **insurance, psychology, travel, study abroad in the Philippines, Manila charter tours, or buying perfumes**, feel free to ask! I'd love to share Teacher Mehdi's wonderful experience and expertise.`;
                return enMessage;
            }
        }

        /**
         * 更新链接模式的显示和按钮文本
         */
        function updateLinkModeUI() {
            if (linkMode === 'zh') {
                linkModeDisplay.textContent = '链接模式：中文 (默认) | Link Mode: Chinese (Default)';
                toggleLinkModeButton.textContent = '切换到英文翻译 | Switch to English';
                userInput.placeholder = '输入读者的问题，与小强互动...';
                toggleLinkModeButton.classList.remove('bg-green-600');
                toggleLinkModeButton.classList.add('bg-primary');
            } else {
                linkModeDisplay.textContent = '链接模式：英文翻译 | Link Mode: English Translation';
                toggleLinkModeButton.textContent = '切换到中文 (默认) | Switch to Chinese';
                userInput.placeholder = 'Ask a question to Xiaoqiang, the assistant...'; 
                toggleLinkModeButton.classList.remove('bg-primary');
                toggleLinkModeButton.classList.add('bg-green-600');
            }
            localStorage.setItem('linkMode', linkMode);
        }

        /**
         * 切换链接模式
         */
        function toggleLinkMode() {
            linkMode = linkMode === 'zh' ? 'en' : 'zh';
            updateLinkModeUI();
            // 清除旧的推荐卡片
            const recCards = document.querySelectorAll('.recommendation-card');
            recCards.forEach(card => card.remove());
        }

        /**
         * 初始化或重置应用状态
         */
        function initializeApp() {
            // 检查 mockArticles 是否加载成功
            if (typeof mockArticles === 'undefined') {
                 showInitError();
                 return;
            }

            chatContainer.innerHTML = '';
            chatHistory = [];
            
            // 首次启动时，显示助理的欢迎语 (默认为中文)
            const initialMessage = getInitialMessage('zh');
            displayMessage(initialMessage, 'model');
            
            // 动态更新所有 UI 提示
            updateLinkModeUI();
            sendButton.disabled = false;
        }

        // 新增文章预览Modal的关闭函数
        function closeArticleModal() {
            articleModal.classList.remove('opacity-100', 'pointer-events-auto');
            articleModal.classList.add('opacity-0', 'pointer-events-none');
        }

        // 新增文章预览Modal的显示函数
        function showArticleModal(title, summary, url) {
            modalArticleTitle.textContent = title;
            // 使用 marked.parse 解析 summary
            modalArticleSummary.innerHTML = marked.parse(summary); 
            modalArticleLink.href = url;
            
            articleModal.classList.add('opacity-100', 'pointer-events-auto');
            articleModal.classList.remove('opacity-0', 'pointer-events-none');
            
            // 确保 Modal 在点击遮罩层时关闭
            articleModal.onclick = (e) => {
                if (e.target === articleModal) {
                    closeArticleModal();
                }
            };
        }

        // --- 5. 其他辅助函数 ---
        
        function showInitError() { 
            chatContainer.innerHTML = '<div class="text-center p-6 text-red-600 font-semibold border-2 border-red-300 rounded-lg">致命错误：无法加载文章数据 (articles.js)。请检查文件路径或网络连接。</div>';
            sendButton.disabled = true;
            userInput.disabled = true;
        }
        
        function getProcessedUrl(originalUrl) { 
            if (linkMode === 'en') {
                const encodedUrl = encodeURIComponent(originalUrl);
                return `https://translate.google.com/translate?sl=zh-CN&tl=en&u=${encodedUrl}`;
            }
            return originalUrl;
        }

        function showStatusModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 text-white p-3 rounded-lg shadow-xl z-50 transition duration-300 opacity-0';
            modal.textContent = message;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('opacity-100');
            }, 10);
            setTimeout(() => {
                modal.classList.remove('opacity-100');
                setTimeout(() => modal.remove(), 300);
            }, 1500);
        }

        function copyArticleLink(url, id) {
             const message = linkMode === 'en' ? `Link for Article ID ${id} copied!` : `文章ID ${id}的链接已复制！`;
             navigator.clipboard.writeText(url).then(() => {
                showStatusModal(message);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                alert(linkMode === 'en' ? 'Copy failed!' : '复制失败！');
            });
        }
        
        function showConfirmModal(message, onConfirmCallback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-100';
            
            const content = document.createElement('div');
            content.className = 'bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm';
            
            const p = document.createElement('p');
            p.className = 'text-gray-700 mb-6';
            p.textContent = message;
            content.appendChild(p);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-end space-x-3';

            const cancelButton = document.createElement('button');
            cancelButton.className = 'py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150';
            cancelButton.textContent = linkMode === 'en' ? 'Cancel' : '取消';
            cancelButton.onclick = () => modal.remove();
            buttonContainer.appendChild(cancelButton);

            const confirmButton = document.createElement('button');
            confirmButton.className = 'py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150';
            confirmButton.textContent = linkMode === 'en' ? 'Reset' : '重置';
            confirmButton.onclick = () => {
                onConfirmCallback();
                modal.remove();
            };
            buttonContainer.appendChild(confirmButton);

            content.appendChild(buttonContainer);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        /**
         * 在聊天界面显示消息
         */
        function displayMessage(text, role, recommendation = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-4 p-3 rounded-lg max-w-[85%] shadow-md ${role === 'user' ? 'user-message ml-auto' : 'model-message mr-auto'}`;
            
            const formattedText = marked.parse(text); 
            messageDiv.innerHTML = formattedText;
            
            if (recommendation) {
                const recDiv = document.createElement('div');
                recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                
                const processedUrl = getProcessedUrl(recommendation.url);
                const linkText = linkMode === 'en' ? '（英文翻译）' : '（中文）';

                recDiv.innerHTML = `
                    <p class="font-bold text-gray-700 mb-1">🎯 小强推荐文章 ${linkText}:</p>
                    <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                        ${recommendation.title}
                    </a>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendation.id}</span>
                        <button onclick="showArticleModal('${recommendation.title.replace(/'/g, "\\'")}', \`${recommendation.summary.replace(/`/g, "\\`")}\`, '${processedUrl}')" class="px-2 py-1 text-xs rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150">
                            快速预览
                        </button>
                        <button onclick="copyArticleLink('${processedUrl}', '${recommendation.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                            复制链接
                        </button>
                    </div>
                `;
                messageDiv.appendChild(recDiv);
            }

            chatContainer.appendChild(messageDiv);
            
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }


        /**
         * 确定用户输入的语言 
         */
        function detectInputLanguage(text) {
            const chineseChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
            const englishLetters = text.match(/[a-zA-Z]/g)?.length || 0;
            
            if (chineseChars > 0) {
                return 'zh';
            }
            
            if (englishLetters > 0) {
                return 'en';
            }
            
            return 'zh'; 
        }
        
        /**
         * 业务关键词检测函数 (【最新优化】: 区分通用咨询和硬性推广)
         */
        function checkBusinessKeyword(text) {
            const lowerText = text.toLowerCase();
            
            // --- 购买/价格/库存 关键词列表 (最高优先级：直接导向真人联系) ---
            const buyPriceKeywords = ['价格', '多少钱', '怎么买', '下单', '库存', '有没有货', 'price', 'how much', 'buy', 'order', 'stock', 'purchase', 'available', '现货'];
            
            // 1. 联系/微信关键词 
            if (lowerText.includes('联系') || lowerText.includes('contact') || lowerText.includes('微信') || lowerText.includes('wechat') || lowerText.includes('reach out')) {
                return 'contact';
            }

            // 2. 购买/价格关键词 
            const isBuyPriceQuery = buyPriceKeywords.some(keyword => lowerText.includes(keyword));
            if (isBuyPriceQuery) {
                return 'buy_price'; // 返回引导联系真人的硬编码类型
            }
            
            // 3. 留学咨询关键词 (通用问题走 AI，具体流程走硬编码)
            const isStudyKeyword = (lowerText.includes('留学') || lowerText.includes('咨询') || lowerText.includes('study') || lowerText.includes('abroad') || lowerText.includes('consult') || lowerText.includes('学校') || lowerText.includes('中学') || lowerText.includes('大学') || lowerText.includes('school'));
            
            if (isStudyKeyword) {
                // 排除性关键词：询问具体流程、费用、价格时，直接转为硬编码的“付费咨询”推广
                const specificStudyKeywords = ['流程', '费用', '多少钱', '价格', '怎么开始', '合作', '收费', 'process', 'fee', 'price', 'cost', 'paid'];
                
                const isSpecificStudyQuery = specificStudyKeywords.some(keyword => lowerText.includes(keyword));

                // 如果是询问具体付费流程或价格，则返回硬编码的 'study' 业务推广
                if (isSpecificStudyQuery) {
                    return 'study';
                }
                
                // 否则（如“留学怎么样”、“优势”），返回 null，走 AI 智能回复和文章推荐
                return null;
            }
            
            // 4. 香水关键词 (所有品牌/推荐咨询走 AI，仅业务介绍走硬编码)
            if (lowerText.includes('香水') || lowerText.includes('perfume') || lowerText.includes('scent') || lowerText.includes('shop') || lowerText.includes('护肤品') || lowerText.includes('skincare')) {
                
                // 判断是否为**极其笼统**的“业务介绍”查询
                const genericQueryKeywords = ['业务', '介绍', '你们卖什么', '你们店里有', 'what do you sell', 'what products'];
                
                const isGenericBusinessQuery = genericQueryKeywords.some(keyword => lowerText.includes(keyword));

                // 仅当用户明确询问“业务/介绍”时，返回硬编码的业务推广
                if (isGenericBusinessQuery) {
                     return 'perfume';
                }
                
                // 否则（问品牌、推荐、怎么样），返回 null，交给 AI 智能回答
                return null; 
            }
            
            // 5. 包车/租车关键词 
            if ((lowerText.includes('包车') || lowerText.includes('租车') || lowerText.includes('charter') || lowerText.includes('van') || lowerText.includes('car service') || lowerText.includes('丰田') || lowerText.includes('toyota') || lowerText.includes('游') || lowerText.includes('玩'))) {
                return 'charter';
            }
            
            return null; // 没有匹配到业务关键词，进入 AI 智能回复
        }

        // --- 优化后的 sendMessage 函数 (已包含 Loading 和 Error 修复) ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UI更新 (禁用输入、显示用户消息)
            userInput.value = '';
            userInput.disabled = true; 
            sendButton.disabled = true;
            displayMessage(text, 'user');

            // 2. 业务关键词检测
            const lang = detectInputLanguage(text);
            const businessKey = checkBusinessKeyword(text);

            // 3. 如果检测到业务关键词，直接返回硬编码的业务详情
            if (businessKey) {
                const businessMessage = businessDetails[lang][businessKey]; 
                
                // 如果触发了 buy_price 或 contact，需要手动添加二维码图片
                if (businessKey === 'contact' || businessKey === 'buy_price') {
                    const messageWithImage = businessMessage + `<p class="mt-4"><img src="wechat_qr.jpg" alt="WeChat QR Code" class="max-w-xs mx-auto"></p>`;
                    displayMessage(messageWithImage, 'model');
                } else {
                     displayMessage(businessMessage, 'model');
                }
                
                // 记录历史并恢复按钮
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                
                // 确保 chatHistory 不超出限制
                if (chatHistory.length > MAX_HISTORY_MESSAGES) {
                    chatHistory = chatHistory.slice(-MAX_HISTORY_MESSAGES);
                }
                return; 
            }
            
            // 4. 实时智能回复 (调用 Gemini API)
            
            // A. 显示加载指示器 (原地更新的占位符)
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'chat-message mb-4 p-3 model-message mr-auto rounded-lg max-w-[85%] shadow-md';
            loadingIndicator.id = 'loadingIndicator'; 
            loadingIndicator.innerHTML = '<div class="flex items-center space-x-1"><span class="text-gray-500">思考中</span><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></div>';
            chatContainer.appendChild(loadingIndicator);
            requestAnimationFrame(() => { 
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });

            // B. 准备 API 调用
            let limitedHistory = [...chatHistory].slice(-(MAX_HISTORY_MESSAGES - 1)); 
            limitedHistory.push({ role: "user", parts: [{ text: text }] }); 

            let articleList = '';
            if (typeof mockArticles !== 'undefined') {
                articleList = mockArticles.map(a => 
                    `ID: ${a.id}, 标题: ${a.title}, 侧重点/摘要: ${a.summary}`
                ).join('\n');
            } else {
                 articleList = '文章列表不可用，请勿推荐。';
            }

            // 增强 System Prompt
            const systemPrompt = `
                你是一个幽默、亲切、爱互动的公众号助理。请注意你的双语名称设定：
                - **中文语境下，你的名字是“小小强”。**
                - **英文语境下，你的名字是“Mehdi”。**

                你的主要任务是：
                1. **扮演作者分身：** 你是作者本人（一位保险专家），过去在广东、北京生活，但从2023年开始，因为陪孩子读书，现定居在菲律宾。你**必须主动、自然地将“北京生活”、“心理学”、“菲律宾陪读经历”、“跨国生活感受”等真实故事或个人见解融入聊天中**，以增强对话的真实性和亲切感。
                
                **【🚨 关键指令：语言、名称与回复长度 🚨】**
                2. **语言与名称保持一致：** **你必须严格使用客户输入的语言进行回复。同时，在回复中请使用对应语言的名字。** (YOU MUST strictly reply in the language the user uses, and use the corresponding name: "小小强" for Chinese, "Mehdi" for English.)
                3. **限制回复长度：** **请将您的回复内容控制在 3 到 5 个自然段之间**，避免冗长。
                
                4. **精准文章推荐：** 当读者的话题与保险、心理、菲律宾生活、旅游或留学相关时，你必须从下面的“文章列表”中选择一篇最精准的文章进行推荐。
                5. **推荐理由：** **你需要在回复文本中自然地提到推荐这篇文章的理由**，然后才输出推荐格式。
                6. **推荐格式：** 必须在回复的最后一行以严格的格式输出推荐ID，格式为：[RECOMMEND_ID: Axxx]，其中 Axxx 是文章ID。如果没有合适的文章，则回复[RECOMMEND_ID: NONE]。
                7. **联系主人：** 如果有人想联系作者本身，请指引他到微信公众号“小强的精彩世界”去订阅和留言，留下他的联系方式，作者会联系他。
                8. **注意：** 仅在客户未提及“香水”、“留学”、“包车”或“联系”等业务关键词时，才使用此模型回复。否则，程序将直接回复硬编码的业务详情。

                --- 文章列表（用于推荐，请勿直接发送给用户）---
                ${articleList}
            `;
            
            // PAYLOAD 结构 (【此处为修复点】：移除 config，systemInstruction 作为顶级参数)
            const payload = {
                contents: limitedHistory, 
                systemInstruction: systemPrompt 
            };

            let modelReplyText = lang === 'en' ? "Sorry, the system is experiencing a temporary issue." : "抱歉，系统暂时出了点小问题。";
            let recommendedArticle = null;
            let fullModelResponse = null;
            let apiError = false; 

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    apiError = true;
                    const errorJson = await response.json();
                    const errorMessage = errorJson.error?.message || response.statusText;
                    modelReplyText = lang === 'en' 
                        ? `API Request Failed (Status ${response.status}). Error: ${errorMessage}`
                        : `API请求失败 (状态码 ${response.status})。错误信息: ${errorMessage}。请尝试重置对话或稍后再试。`;
                } else {
                    const result = await response.json();
                    
                    fullModelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!fullModelResponse) {
                        modelReplyText = lang === 'en' 
                            ? "I'm sorry, the model did not provide a coherent response. The response might have been blocked by safety filters." 
                            : "抱歉，模型未返回有效的回复。回复可能被安全过滤器阻止。";
                    } else {
                        // 提取推荐ID
                        const match = fullModelResponse.match(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i);
                        const recId = match ? match[1] : 'NONE';

                        // 清理回复文本，移除推荐标记
                        modelReplyText = fullModelResponse.replace(/\[RECOMMEND_ID: (A\d{3}|NONE)\]/i, '').trim();

                        if (recId !== 'NONE' && typeof mockArticles !== 'undefined') {
                            recommendedArticle = mockArticles.find(a => a.id === recId);
                            if (!recommendedArticle) {
                                modelReplyText += (lang === 'en' ? '\n\n(System Note: Recommended article ID is invalid.)' : '\n\n(系统提示: 推荐的文章ID无效。)');
                            }
                        }
                        
                        // 记录历史
                        chatHistory.push(limitedHistory[limitedHistory.length - 1]);
                        chatHistory.push({ role: "model", parts: [{ text: fullModelResponse }] }); 
                        if (chatHistory.length > MAX_HISTORY_MESSAGES) {
                            chatHistory = chatHistory.slice(-MAX_HISTORY_MESSAGES);
                        }
                    }
                }

            } catch (error) {
                apiError = true;
                console.error("Critical error in sendMessage:", error);
                modelReplyText = lang === 'en' 
                    ? `A critical network error occurred: ${error.message}`
                    : `发生致命网络错误：${error.message}。请检查您的网络连接或 API Key 是否正确。`;
            }
            
            // C. 移除加载提示并显示最终回复
            if (loadingIndicator) {
                loadingIndicator.id = ''; 
                loadingIndicator.innerHTML = ''; 
                loadingIndicator.className = `chat-message mb-4 p-3 model-message mr-auto rounded-lg max-w-[85%] shadow-md`;
                
                // 重新渲染内容
                const formattedText = marked.parse(modelReplyText); 
                loadingIndicator.innerHTML = formattedText;
                
                // 显示推荐卡片
                if (recommendedArticle && !apiError) { 
                    const recDiv = document.createElement('div');
                    recDiv.className = 'mt-3 pt-3 border-t border-gray-300 recommendation-card';
                    
                    const processedUrl = getProcessedUrl(recommendedArticle.url);
                    const linkText = linkMode === 'en' ? '（英文翻译）' : '（中文）';

                    recDiv.innerHTML = `
                        <p class="font-bold text-gray-700 mb-1">🎯 小强推荐文章 ${linkText}:</p>
                        <a href="${processedUrl}" target="_blank" class="block text-primary hover:text-blue-600 font-semibold truncate hover:underline mb-2">
                            ${recommendedArticle.title}
                        </a>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">ID: ${recommendedArticle.id}</span>
                            <button onclick="showArticleModal('${recommendedArticle.title.replace(/'/g, "\\'")}', \`${recommendedArticle.summary.replace(/`/g, "\\`")}\`, '${processedUrl}')" class="px-2 py-1 text-xs rounded-full bg-primary text-white hover:bg-blue-600 transition duration-150">
                                快速预览
                            </button>
                            <button onclick="copyArticleLink('${processedUrl}', '${recommendedArticle.id}')" class="px-2 py-1 text-xs rounded-full bg-accent text-white hover:bg-green-600 transition duration-150">
                                复制链接
                            </button>
                        </div>
                    `;
                    loadingIndicator.appendChild(recDiv);
                }
            }
            
            // D. 恢复输入
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
            requestAnimationFrame(() => { 
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }


        // --- 6. Event Listeners & Initialization ---
        
        // 绑定到全局 scope
        window.closeArticleModal = closeArticleModal;
        window.showArticleModal = showArticleModal;
        window.copyArticleLink = copyArticleLink;
        window.initializeApp = initializeApp; 

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });
        // 确保输入框内容变化时，按钮启用/禁用状态正确
        userInput.addEventListener('input', () => {
            sendButton.disabled = userInput.value.trim() === '';
        });

        toggleLinkModeButton.addEventListener('click', toggleLinkMode);
        
        resetButton.addEventListener('click', () => {
            showConfirmModal("确定要重置对话吗？重置后小强将忘记所有之前的聊天内容。| Are you sure you want to reset the conversation? Xiaoqiang will forget all previous chat history.", initializeApp);
        });

        document.addEventListener('DOMContentLoaded', () => {
            // 延迟执行以确保所有的 DOM 和外部脚本都已加载
            setTimeout(() => {
                if (typeof mockArticles !== 'undefined' && typeof marked !== 'undefined') {
                    initializeApp();
                } else {
                    showInitError(); 
                }
            }, 100);
        });
    </script>
    
</body>
</html>
